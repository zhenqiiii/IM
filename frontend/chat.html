<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊天 - IM即时通讯系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-indigo-600 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">IM即时通讯系统</h1>
            <div class="flex items-center space-x-4">
                <span id="user-nickname" class="text-sm">加载中...</span>
                <img id="user-avatar" src="https://via.placeholder.com/32" alt="头像" class="w-8 h-8 rounded-full">
                <button id="logout-btn" class="text-sm bg-indigo-700 hover:bg-indigo-800 px-3 py-1 rounded">
                    退出登录
                </button>
            </div>
        </div>
    </header>

    <!-- 主要内容区域 -->
    <div class="flex-1 flex overflow-hidden">
        <!-- 左侧好友列表 -->
        <div class="w-1/4 bg-white border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b border-gray-200">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="搜索好友" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="search-btn" class="absolute right-2 top-2 text-gray-500 hover:text-indigo-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-2" id="friend-list">
                <!-- 好友列表将通过JavaScript动态加载 -->
                <div class="text-center text-gray-500 py-4">加载好友列表中...</div>
            </div>
            
            <div class="p-4 border-t border-gray-200">
                <button id="add-friend-btn" class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    添加好友
                </button>
            </div>
        </div>
        
        <!-- 右侧聊天区域 -->
        <div class="flex-1 flex flex-col">
            <!-- 聊天头部 -->
            <div class="p-4 border-b border-gray-200 bg-white shadow-sm flex justify-between items-center">
                <h2 id="chat-title" class="text-lg font-medium">请选择一个聊天</h2>
                <div id="chat-actions" class="hidden">
                    <button id="delete-friend-btn" class="text-sm text-red-600 hover:text-red-800">
                        删除好友
                    </button>
                </div>
            </div>
            
            <!-- 聊天消息区域 -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 bg-gray-50">
                <div class="flex items-center justify-center h-full">
                    <p class="text-gray-500">选择一个好友开始聊天</p>
                </div>
            </div>
            
            <!-- 聊天输入区域 -->
            <div id="chat-input-area" class="p-4 border-t border-gray-200 bg-white hidden">
                <form id="message-form" class="flex items-center">
                    <input type="text" id="message-input" placeholder="输入消息..." class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <button type="submit" class="px-4 py-2 border border-transparent rounded-r-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        发送
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- 添加好友模态框 -->
    <div id="add-friend-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">添加好友</h3>
                <button id="close-add-friend-modal" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div id="add-friend-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4">
                <span id="add-friend-error-text"></span>
            </div>
            
            <div id="add-friend-success" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4">
                <span id="add-friend-success-text"></span>
            </div>
            
            <form id="add-friend-form">
                <div class="mb-4">
                    <label for="friend-account" class="block text-sm font-medium text-gray-700 mb-1">好友账号</label>
                    <input type="text" id="friend-account" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div id="search-result" class="mb-4 hidden">
                    <div class="p-3 border border-gray-200 rounded-md">
                        <div class="flex items-center">
                            <img id="result-avatar" src="https://via.placeholder.com/40" alt="头像" class="w-10 h-10 rounded-full mr-3">
                            <div>
                                <p id="result-nickname" class="font-medium"></p>
                                <p id="result-account" class="text-sm text-gray-500"></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="search-friend-btn" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        搜索
                    </button>
                    <button type="button" id="confirm-add-friend-btn" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 hidden">
                        添加
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否已登录
            const token = localStorage.getItem('token');
            if (!token) {
                // 未登录，跳转到登录页面
                window.location.href = 'login.html';
                return;
            }
            
            // 全局变量
            let currentUser = null;
            let currentRoomId = null;
            let currentChatUser = null;
            let socket = null;
            let friends = [];
            
            // DOM元素
            const userNickname = document.getElementById('user-nickname');
            const userAvatar = document.getElementById('user-avatar');
            const logoutBtn = document.getElementById('logout-btn');
            const friendList = document.getElementById('friend-list');
            const chatTitle = document.getElementById('chat-title');
            const chatMessages = document.getElementById('chat-messages');
            const chatInputArea = document.getElementById('chat-input-area');
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-input');
            const addFriendBtn = document.getElementById('add-friend-btn');
            const addFriendModal = document.getElementById('add-friend-modal');
            const closeAddFriendModal = document.getElementById('close-add-friend-modal');
            const addFriendForm = document.getElementById('add-friend-form');
            const friendAccount = document.getElementById('friend-account');
            const searchFriendBtn = document.getElementById('search-friend-btn');
            const searchResult = document.getElementById('search-result');
            const resultAvatar = document.getElementById('result-avatar');
            const resultNickname = document.getElementById('result-nickname');
            const resultAccount = document.getElementById('result-account');
            const confirmAddFriendBtn = document.getElementById('confirm-add-friend-btn');
            const addFriendError = document.getElementById('add-friend-error');
            const addFriendErrorText = document.getElementById('add-friend-error-text');
            const addFriendSuccess = document.getElementById('add-friend-success');
            const addFriendSuccessText = document.getElementById('add-friend-success-text');
            const chatActions = document.getElementById('chat-actions');
            const deleteFriendBtn = document.getElementById('delete-friend-btn');
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            
            // 获取当前用户信息
            async function fetchCurrentUser() {
                try {
                    const response = await fetch('http://localhost:8081/user/detail', {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // 成功状态码
                        currentUser = data.data;
                        userNickname.textContent = currentUser.nickname || currentUser.account;
                        if (currentUser.avatar) {
                            userAvatar.src = currentUser.avatar;
                        }
                        
                        // 获取好友列表
                        fetchFriends();
                        
                        // 建立WebSocket连接
                        connectWebSocket();
                    } else {
                        // 获取用户信息失败，可能是token过期
                        localStorage.removeItem('token');
                        window.location.href = 'login.html';
                    }
                } catch (error) {
                    console.error('获取用户信息出错:', error);
                    alert('网络错误，请稍后重试');
                }
            }
            
            // 获取好友列表
            async function fetchFriends() {
                // 这里需要根据后端API调整，目前后端没有直接获取好友列表的API
                // 可以通过获取聊天室列表间接获取好友
                
                // 清空好友列表
                friendList.innerHTML = '';
                
                // 模拟好友列表，实际项目中应该从后端获取
                friends = [];
                
                // 如果好友列表为空，显示提示信息
                if (friends.length === 0) {
                    friendList.innerHTML = '<div class="text-center text-gray-500 py-4">暂无好友，请添加好友</div>';
                }
            }
            
            // 建立WebSocket连接
            function connectWebSocket() {
                // 构建WebSocket URL，指向后端服务
                const wsUrl = `ws://localhost:8081/user/msg?token=${token}`;
                
                // 创建WebSocket连接
                socket = new WebSocket(wsUrl);
                
                // 连接打开事件
                socket.onopen = function(e) {
                    console.log('WebSocket连接已建立');
                };
                
                // 接收消息事件
                socket.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    console.log('收到消息:', message);
                    
                    // 如果当前正在查看的聊天室与消息的聊天室相同，则显示消息
                    if (currentRoomId === message.room_id) {
                        appendMessage(message);
                    }
                    
                    // 更新好友列表中的最新消息
                    updateFriendLastMessage(message);
                };
                
                // 连接关闭事件
                socket.onclose = function(event) {
                    console.log('WebSocket连接已关闭');
                    // 可以在这里添加重连逻辑
                };
                
                // 连接错误事件
                socket.onerror = function(error) {
                    console.error('WebSocket错误:', error);
                };
            }
            
            // 更新好友列表中的最新消息
            function updateFriendLastMessage(message) {
                // 实际项目中应该更新好友列表中的最新消息
            }
            
            // 加载聊天记录
            async function loadChatMessages(roomId, page = 1, pageSize = 20) {
                try {
                    const response = await fetch(`http://localhost:8081/user/history?room_id=${roomId}&page_index=${page}&page_size=${pageSize}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // 成功状态码
                        // 清空聊天消息区域
                        chatMessages.innerHTML = '';
                        
                        // 显示聊天记录
                        const messages = data.data.list;
                        if (messages.length === 0) {
                            chatMessages.innerHTML = '<div class="flex justify-center my-4"><p class="text-gray-500">暂无聊天记录</p></div>';
                        } else {
                            // 按时间顺序显示消息
                            messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                            
                            messages.forEach(msg => {
                                const messageObj = {
                                    user_id: msg.user_id,
                                    room_id: roomId,
                                    message: msg.data,
                                    created_at: msg.created_at
                                };
                                appendMessage(messageObj);
                            });
                            
                            // 滚动到底部
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                    } else {
                        console.error('获取聊天记录失败:', data.msg);
                    }
                } catch (error) {
                    console.error('获取聊天记录出错:', error);
                }
            }
            
            // 添加消息到聊天区域
            function appendMessage(message) {
                const isCurrentUser = message.user_id === currentUser.user_id;
                
                const messageElement = document.createElement('div');
                messageElement.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'} mb-4`;
                
                const messageTime = new Date(message.created_at || new Date()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                messageElement.innerHTML = `
                    <div class="${isCurrentUser ? 'order-2' : 'order-1'} max-w-xs mx-2">
                        <div class="${isCurrentUser ? 'bg-indigo-500 text-white' : 'bg-gray-200 text-gray-800'} rounded-lg px-4 py-2 shadow">
                            <p>${message.message}</p>
                        </div>
                        <span class="text-xs text-gray-500 ${isCurrentUser ? 'text-right' : 'text-left'} block mt-1">${messageTime}</span>
                    </div>
                    <div class="${isCurrentUser ? 'order-1' : 'order-2'} flex-shrink-0">
                        <img src="${isCurrentUser ? (currentUser.avatar || 'https://via.placeholder.com/32') : (currentChatUser?.avatar || 'https://via.placeholder.com/32')}" alt="头像" class="w-8 h-8 rounded-full">
                    </div>
                `;
                
                chatMessages.appendChild(messageElement);
                
                // 滚动到底部
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // 打开聊天
            function openChat(roomId, user) {
                currentRoomId = roomId;
                currentChatUser = user;
                
                // 更新聊天标题
                chatTitle.textContent = user.nickname || user.account;
                
                // 显示聊天输入区域
                chatInputArea.classList.remove('hidden');
                
                // 显示聊天操作区域
                chatActions.classList.remove('hidden');
                
                // 加载聊天记录
                loadChatMessages(roomId);
            }
            
            // 搜索好友
            async function searchFriend(account) {
                try {
                    const response = await fetch(`http://localhost:8081/user/query?account=${account}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // 成功状态码
                        return data.data;
                    } else {
                        throw new Error(data.msg || '搜索好友失败');
                    }
                } catch (error) {
                    console.error('搜索好友出错:', error);
                    throw error;
                }
            }
            
            // 添加好友
            async function addFriend(account) {
                try {
                    const formData = new FormData();
                    formData.append('account', account);
                    
                    const response = await fetch('http://localhost:8081/user/add', {
                        method: 'POST',
                        headers: {
                            'Authorization': token
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // 成功状态码
                        return data.data;
                    } else {
                        throw new Error(data.msg || '添加好友失败');
                    }
                } catch (error) {
                    console.error('添加好友出错:', error);
                    throw error;
                }
            }
            
            // 删除好友
            async function deleteFriend(userId) {
                try {
                    const formData = new FormData();
                    formData.append('user_id', userId);
                    
                    const response = await fetch('http://localhost:8081/user/delete', {
                        method: 'DELETE',
                        headers: {
                            'Authorization': token
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // 成功状态码
                        return true;
                    } else {
                        throw new Error(data.msg || '删除好友失败');
                    }
                } catch (error) {
                    console.error('删除好友出错:', error);
                    throw error;
                }
            }
            
            // 事件监听
            
            // 退出登录
            logoutBtn.addEventListener('click', function() {
                // 关闭WebSocket连接
                if (socket) {
                    socket.close();
                }
                
                // 清除本地存储的token
                localStorage.removeItem('token');
                
                // 跳转到登录页面
                window.location.href = 'login.html';
            });
            
            // 发送消息
            messageForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const message = messageInput.value.trim();
                if (!message) return;
                
                if (!currentRoomId) {
                    alert('请先选择一个聊天');
                    return;
                }
                
                // 构建消息对象
                const messageObj = {
                    user_id: currentUser.user_id,
                    room_id: currentRoomId,
                    message: message
                };
                
                // 发送消息
                socket.send(JSON.stringify(messageObj));
                
                // 清空输入框
                messageInput.value = '';
            });
            
            // 打开添加好友模态框
            addFriendBtn.addEventListener('click', function() {
                // 重置表单
                addFriendForm.reset();
                searchResult.classList.add('hidden');
                confirmAddFriendBtn.classList.add('hidden');
                addFriendError.classList.add('hidden');
                addFriendSuccess.classList.add('hidden');
                
                // 显示模态框
                addFriendModal.classList.remove('hidden');
            });
            
            // 关闭添加好友模态框
            closeAddFriendModal.addEventListener('click', function() {
                addFriendModal.classList.add('hidden');
            });
            
            // 点击模态框外部关闭模态框
            addFriendModal.addEventListener('click', function(e) {
                if (e.target === addFriendModal) {
                    addFriendModal.classList.add('hidden');
                }
            });
            
            // 搜索好友
            searchFriendBtn.addEventListener('click', async function() {
                const account = friendAccount.value.trim();
                if (!account) {
                    addFriendErrorText.textContent = '请输入好友账号';
                    addFriendError.classList.remove('hidden');
                    addFriendSuccess.classList.add('hidden');
                    return;
                }
                
                try {
                    const user = await searchFriend(account);
                    
                    // 显示搜索结果
                    resultNickname.textContent = user.nickname || user.account;
                    resultAccount.textContent = user.account;
                    if (user.avatar) {
                        resultAvatar.src = user.avatar;
                    }
                    
                    searchResult.classList.remove('hidden');
                    
                    // 如果已经是好友，不显示添加按钮
                    if (user.is_friend) {
                        addFriendErrorText.textContent = '该用户已经是您的好友';
                        addFriendError.classList.remove('hidden');
                        addFriendSuccess.classList.add('hidden');
                        confirmAddFriendBtn.classList.add('hidden');
                    } else {
                        addFriendError.classList.add('hidden');
                        addFriendSuccess.classList.add('hidden');
                        confirmAddFriendBtn.classList.remove('hidden');
                        
                        // 存储搜索到的用户信息
                        confirmAddFriendBtn.dataset.account = user.account;
                    }
                } catch (error) {
                    addFriendErrorText.textContent = error.message || '搜索好友失败';
                    addFriendError.classList.remove('hidden');
                    addFriendSuccess.classList.add('hidden');
                    searchResult.classList.add('hidden');
                    confirmAddFriendBtn.classList.add('hidden');
                }
            });
            
            // 确认添加好友
            confirmAddFriendBtn.addEventListener('click', async function() {
                const account = confirmAddFriendBtn.dataset.account;
                if (!account) return;
                
                try {
                    await addFriend(account);
                    
                    // 显示成功信息
                    addFriendSuccessText.textContent = '添加好友成功';
                    addFriendSuccess.classList.remove('hidden');
                    addFriendError.classList.add('hidden');
                    
                    // 重新获取好友列表
                    fetchFriends();
                    
                    // 3秒后关闭模态框
                    setTimeout(() => {
                        addFriendModal.classList.add('hidden');
                    }, 3000);
                } catch (error) {
                    addFriendErrorText.textContent = error.message || '添加好友失败';
                    addFriendError.classList.remove('hidden');
                    addFriendSuccess.classList.add('hidden');
                }
            });
            
            // 删除好友
            deleteFriendBtn.addEventListener('click', async function() {
                if (!currentChatUser) return;
                
                if (confirm(`确定要删除好友 ${currentChatUser.nickname || currentChatUser.account} 吗？`)) {
                    try {
                        await deleteFriend(currentChatUser.user_id);
                        
                        // 重新获取好友列表
                        fetchFriends();
                        
                        // 重置聊天区域
                        currentRoomId = null;
                        currentChatUser = null;
                        chatTitle.textContent = '请选择一个聊天';
                        chatMessages.innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-gray-500">选择一个好友开始聊天</p></div>';
                        chatInputArea.classList.add('hidden');
                        chatActions.classList.add('hidden');
                        
                        alert('删除好友成功');
                    } catch (error) {
                        alert(error.message || '删除好友失败');
                    }
                }
            });
            
            // 搜索好友（本地搜索）
            searchBtn.addEventListener('click', function() {
                const keyword = searchInput.value.trim().toLowerCase();
                if (!keyword) {
                    // 显示所有好友
                    fetchFriends();
                    return;
                }
                
                // 过滤好友列表
                const filteredFriends = friends.filter(friend => {
                    return friend.nickname.toLowerCase().includes(keyword) || 
                           friend.account.toLowerCase().includes(keyword);
                });
                
                // 更新好友列表
                renderFriendList(filteredFriends);
            });
            
            // 渲染好友列表
            function renderFriendList(friendsList) {
                // 清空好友列表
                friendList.innerHTML = '';
                
                if (friendsList.length === 0) {
                    friendList.innerHTML = '<div class="text-center text-gray-500 py-4">未找到匹配的好友</div>';
                    return;
                }
                
                // 渲染好友列表
                friendsList.forEach(friend => {
                    const friendElement = document.createElement('div');
                    friendElement.className = 'p-2 hover:bg-gray-100 rounded-md cursor-pointer';
                    friendElement.dataset.roomId = friend.room_id;
                    friendElement.dataset.userId = friend.user_id;
                    
                    friendElement.innerHTML = `
                        <div class="flex items-center">
                            <img src="${friend.avatar || 'https://via.placeholder.com/40'}" alt="头像" class="w-10 h-10 rounded-full mr-3">
                            <div class="flex-1">
                                <p class="font-medium">${friend.nickname || friend.account}</p>
                                <p class="text-sm text-gray-500 truncate">${friend.last_message || ''}</p>
                            </div>
                        </div>
                    `;
                    
                    // 点击好友打开聊天
                    friendElement.addEventListener('click', function() {
                        openChat(friend.room_id, friend);
                    });
                    
                    friendList.appendChild(friendElement);
                });
            }
            
            // 初始化
            fetchCurrentUser();
        });
    </script>
</body>
</html>