<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËÅäÂ§© - DINGDANG</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-50 to-gray-100 h-screen flex flex-col">
    <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
    <header class="bg-white/90 backdrop-blur-lg border-b border-gray-200/60 text-gray-800 px-4 py-3 shadow-lg">
        <div class="w-full max-w-none flex items-center justify-between h-16">
            <!-- Â∑¶‰æßÊ†áÈ¢ò - ÁªùÂØπÂ∑¶ÂØπÈΩê -->
            <div class="flex items-center flex-shrink-0">
                <h1 class="text-3xl lg:text-4xl font-black bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 bg-clip-text text-transparent tracking-widest drop-shadow-sm">
                    DINGDANG
                </h1>
            </div>
            
            <!-- Âè≥‰æßÁî®Êà∑‰ø°ÊÅØ - ÁªùÂØπÂè≥ÂØπÈΩê -->
            <div class="flex items-center justify-end flex-shrink-0">
                <!-- Áî®Êà∑ÊòµÁß∞ - ÂìçÂ∫îÂºèÊòæÁ§∫ -->
                <span id="user-nickname" class="text-sm lg:text-base text-gray-700 font-medium mr-3 lg:mr-4 hidden md:block truncate max-w-32 lg:max-w-48">Âä†ËΩΩ‰∏≠...</span>
                
                <!-- Â§¥ÂÉè - ÂìçÂ∫îÂºèÂ∞∫ÂØ∏ -->
                <img id="user-avatar" src="https://avatars.githubusercontent.com/u/148515933?s=400&u=7cbff7c77a33416cabfe463fff24495157026760&v=4" alt="Â§¥ÂÉè" class="w-10 h-10 lg:w-12 lg:h-12 rounded-full ring-2 ring-white shadow-md mr-3 lg:mr-4">
                
                <!-- Áî®Êà∑‰∏≠ÂøÉÊåâÈíÆ - ÂìçÂ∫îÂºèËÆæËÆ° -->
                <button id="user-center-btn" class="bg-gray-900 hover:bg-gray-800 active:bg-gray-700 text-white font-medium rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 active:scale-95">
                    <span class="hidden sm:inline px-6 py-4 lg:px-7 lg:py-4 text-sm lg:text-base">Áî®Êà∑‰∏≠ÂøÉ</span>
                    <span class="sm:hidden px-5 py-4 text-xs">‰∏≠ÂøÉ</span>
                </button>
            </div>
        </div>
    </header>

    <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
    <div class="flex-1 flex overflow-hidden">
        <!-- Â∑¶‰æßËÅîÁ≥ª‰∫∫ÂàóË°® -->
        <div class="w-1/4 bg-white/70 backdrop-blur-sm border-r border-gray-200/60 flex flex-col">
            <div class="p-5 border-b border-gray-200/60">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="ÊêúÁ¥¢ËÅîÁ≥ª‰∫∫" class="w-full px-4 py-3 border border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-900/20 focus:border-gray-400 bg-gray-50/50 text-sm transition-all duration-200">
                    <button id="search-btn" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-3" id="friend-list">
                <!-- ËÅîÁ≥ª‰∫∫ÂàóË°®Â∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
                <div class="text-center text-gray-400 py-8 text-sm">Âä†ËΩΩËÅîÁ≥ª‰∫∫ÂàóË°®‰∏≠...</div>
            </div>
            
            <div class="p-4 border-t border-gray-200/60">
                <button id="add-friend-btn" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-xl shadow-sm text-sm font-medium text-white bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900/50 transition-all duration-200 hover:shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Ê∑ªÂä†ËÅîÁ≥ª‰∫∫
                </button>
            </div>
        </div>
        
        <!-- Âè≥‰æßËÅäÂ§©Âå∫Âüü -->
        <div class="flex-1 flex flex-col">
            <!-- ËÅäÂ§©Â§¥ÈÉ® -->
            <div class="p-5 border-b border-gray-200/60 bg-white/80 backdrop-blur-sm shadow-sm flex justify-between items-center">
                <h2 id="chat-title" class="text-lg font-semibold text-gray-800">ËØ∑ÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©</h2>
                <div id="chat-actions" class="hidden">
                    <button id="view-profile-btn" class="text-sm text-gray-600 hover:text-gray-900 bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-lg transition-all duration-200">
                        Êü•ÁúãËµÑÊñô
                    </button>
                </div>
            </div>
            
            <!-- ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-6 bg-gradient-to-b from-gray-50/50 to-white/50">
                <div class="flex items-center justify-center h-full">
                    <div class="text-center">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gray-200 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                            </svg>
                        </div>
                        <p class="text-gray-400 text-sm">ÈÄâÊã©‰∏Ä‰∏™ËÅîÁ≥ª‰∫∫ÂºÄÂßãËÅäÂ§©</p>
                    </div>
                </div>
            </div>
            
            <!-- ËÅäÂ§©ËæìÂÖ•Âå∫Âüü -->
            <div id="chat-input-area" class="p-5 border-t border-gray-200/60 bg-white/80 backdrop-blur-sm hidden">
                <!-- Ë°®ÊÉÖÈÄâÊã©Âô® -->
                <div id="emoji-picker" class="hidden absolute bottom-24 left-6 w-80 p-4 border border-gray-200/60 rounded-2xl bg-white/95 backdrop-blur-md shadow-xl max-h-48 overflow-y-auto z-10">
                    <div class="grid grid-cols-8 gap-2">
                        <!-- Ë°®ÊÉÖÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
                
                <!-- Êñá‰ª∂ÈÄâÊã©Âô® -->
                <input type="file" id="file-input" class="hidden" accept="*/*">
                <input type="file" id="image-input" class="hidden" accept="image/*">
                
                <div class="relative">
                    <!-- ËæìÂÖ•Ê°ÜÂÆπÂô® -->
                    <div class="bg-gray-50/80 rounded-2xl border border-gray-200/60 p-3 flex items-center space-x-3">
                        <!-- Â∑¶‰æßÂäüËÉΩÊåâÈíÆ -->
                        <div class="flex space-x-2 flex-shrink-0">
                            <button type="button" id="emoji-btn" class="w-9 h-9 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-white/80 rounded-xl transition-all duration-200 text-lg">
                                üòä
                            </button>
                            <button type="button" id="image-btn" class="w-9 h-9 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-white/80 rounded-xl transition-all duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </button>
                            <button type="button" id="file-btn" class="w-9 h-9 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-white/80 rounded-xl transition-all duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                                </svg>
                            </button>
                        </div>
                        
                        <!-- ‰∏ªËæìÂÖ•Âå∫Âüü -->
                        <form id="message-form" class="flex-1 flex items-center space-x-3 min-h-[2.5rem]">
                            <textarea id="message-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." class="flex-1 resize-none border-none outline-none bg-transparent text-sm placeholder-gray-400 max-h-20 min-h-[2.5rem] py-2 leading-relaxed" rows="1"></textarea>
                            
                            <!-- ÂèëÈÄÅÊåâÈíÆ -->
                            <button type="submit" class="w-10 h-10 bg-gray-900 hover:bg-gray-800 text-white rounded-xl flex items-center justify-center transition-all duration-200 hover:shadow-md flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                </svg>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ê∑ªÂä†Â•ΩÂèãÊ®°ÊÄÅÊ°Ü -->
    <div id="add-friend-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center hidden z-50">
        <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-8 w-full max-w-md border border-gray-200/50">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-900">Ê∑ªÂä†Â•ΩÂèã</h3>
                <button id="close-add-friend-modal" class="text-gray-400 hover:text-gray-600 p-1 rounded-lg hover:bg-gray-100 transition-all duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div id="add-friend-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl relative mb-4">
                <span id="add-friend-error-text"></span>
            </div>
            
            <div id="add-friend-success" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-xl relative mb-4">
                <span id="add-friend-success-text"></span>
            </div>
            
            <form id="add-friend-form">
                <div class="mb-6">
                    <label for="friend-account" class="block text-sm font-medium text-gray-700 mb-2">Â•ΩÂèãË¥¶Âè∑</label>
                    <input type="text" id="friend-account" class="w-full px-4 py-3 border border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-900/20 focus:border-gray-400 bg-gray-50/50 transition-all duration-200">
                </div>
                
                <div id="search-result" class="mb-6 hidden">
                    <div class="p-4 border border-gray-200 rounded-xl bg-gray-50/50">
                        <div class="flex items-center">
                            <img id="result-avatar" src="https://via.placeholder.com/40" alt="Â§¥ÂÉè" class="w-12 h-12 rounded-full mr-4 ring-2 ring-white shadow-sm">
                            <div>
                                <p id="result-nickname" class="font-medium text-gray-900"></p>
                                <p id="result-account" class="text-sm text-gray-500"></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="search-friend-btn" class="px-6 py-3 border border-gray-200 rounded-xl shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900/20 transition-all duration-200">
                        ÊêúÁ¥¢
                    </button>
                    <button type="button" id="confirm-add-friend-btn" class="px-6 py-3 border border-transparent rounded-xl shadow-sm text-sm font-medium text-white bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900/50 transition-all duration-200 hover:shadow-md hidden">
                        Ê∑ªÂä†
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁôªÂΩï
            const token = localStorage.getItem('token');
            if (!token) {
                // Êú™ÁôªÂΩïÔºåË∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢
                window.location.href = 'login.html';
                return;
            }
            
            // ÂÖ®Â±ÄÂèòÈáè
            let currentUser = null;
            let currentRoomId = null;
            let currentChatUser = null;
            let socket = null;
            let friends = [];
            
            // DOMÂÖÉÁ¥†ÁºìÂ≠ò
            const elements = {
                // Áî®Êà∑Áõ∏ÂÖ≥
                userNickname: document.getElementById('user-nickname'),
                userAvatar: document.getElementById('user-avatar'),
                userCenterBtn: document.getElementById('user-center-btn'),
                logoutBtn: document.getElementById('logout-btn'),
                
                // ËÅäÂ§©Áõ∏ÂÖ≥
                friendList: document.getElementById('friend-list'),
                chatTitle: document.getElementById('chat-title'),
                chatMessages: document.getElementById('chat-messages'),
                chatInputArea: document.getElementById('chat-input-area'),
                messageForm: document.getElementById('message-form'),
                messageInput: document.getElementById('message-input'),
                chatActions: document.getElementById('chat-actions'),
                viewProfileBtn: document.getElementById('view-profile-btn'),
                
                // ÊêúÁ¥¢Áõ∏ÂÖ≥
                searchInput: document.getElementById('search-input'),
                searchBtn: document.getElementById('search-btn'),
                
                // Ê∑ªÂä†Â•ΩÂèãÁõ∏ÂÖ≥
                addFriendBtn: document.getElementById('add-friend-btn'),
                addFriendModal: document.getElementById('add-friend-modal'),
                closeAddFriendModal: document.getElementById('close-add-friend-modal'),
                addFriendForm: document.getElementById('add-friend-form'),
                friendAccount: document.getElementById('friend-account'),
                searchFriendBtn: document.getElementById('search-friend-btn'),
                searchResult: document.getElementById('search-result'),
                resultAvatar: document.getElementById('result-avatar'),
                resultNickname: document.getElementById('result-nickname'),
                resultAccount: document.getElementById('result-account'),
                confirmAddFriendBtn: document.getElementById('confirm-add-friend-btn'),
                addFriendError: document.getElementById('add-friend-error'),
                addFriendErrorText: document.getElementById('add-friend-error-text'),
                addFriendSuccess: document.getElementById('add-friend-success'),
                addFriendSuccessText: document.getElementById('add-friend-success-text'),
                
                // Áî®Êà∑‰∏≠ÂøÉÁõ∏ÂÖ≥
                userCenterModal: document.getElementById('user-center-modal'),
                userCenterPanel: document.getElementById('user-center-panel'),
                userCenterBackdrop: document.getElementById('user-center-backdrop'),
                closeUserCenterBtn: document.getElementById('close-user-center-btn'),
                profileAvatar: document.getElementById('profile-avatar'),
                profileNickname: document.getElementById('profile-nickname'),
                profileAccount: document.getElementById('profile-account'),
                profileEmail: document.getElementById('profile-email'),
                profileNicknameDisplay: document.getElementById('profile-nickname-display'),
                profileAccountDisplay: document.getElementById('profile-account-display'),
                profileEmailDisplay: document.getElementById('profile-email-display'),
                profileViewMode: document.getElementById('profile-view-mode'),
                profileForm: document.getElementById('profile-form'),
                editProfileBtn: document.getElementById('edit-profile-btn'),
                cancelEditBtn: document.getElementById('cancel-edit-btn'),
                changePasswordBtn: document.getElementById('change-password-btn'),
                
                // Êü•ÁúãËµÑÊñôÁõ∏ÂÖ≥
                profileModal: document.getElementById('profile-modal'),
                profilePanel: document.getElementById('profile-panel'),
                profileBackdrop: document.getElementById('profile-backdrop'),
                closeProfileBtn: document.getElementById('close-profile-btn'),
                friendProfileAvatar: document.getElementById('friend-profile-avatar'),
                friendProfileNickname: document.getElementById('friend-profile-nickname'),
                friendProfileAccount: document.getElementById('friend-profile-account'),
                friendProfileEmail: document.getElementById('friend-profile-email'),
                deleteFriendBtn: document.getElementById('delete-friend-btn'),
                
                // Ê∂àÊÅØËæìÂÖ•Áõ∏ÂÖ≥
                emojiBtn: document.getElementById('emoji-btn'),
                emojiPicker: document.getElementById('emoji-picker'),
                imageBtn: document.getElementById('image-btn'),
                fileBtn: document.getElementById('file-btn'),
                imageInput: document.getElementById('image-input'),
                fileInput: document.getElementById('file-input')
            };
            
            // Ë°®ÊÉÖÊï∞ÊçÆ
            const emojis = [
                'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£',
                'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞',
                'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòù', 'üòú',
                'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©', 'ü•≥', 'üòè',
                'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£',
                'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†',
                'üò°', 'ü§¨', 'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®',
                'üò∞', 'üò•', 'üòì', 'ü§ó', 'ü§î', 'ü§≠', 'ü§´', 'ü§•',
                'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ', 'üò¶', 'üòß',
                'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê',
                'ü•¥', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë',
                'ü§†', 'üòà', 'üëø', 'üëπ', 'üë∫', 'ü§°', 'üí©', 'üëª',
                'üíÄ', '‚ò†Ô∏è', 'üëΩ', 'üëæ', 'ü§ñ', 'üéÉ', 'üò∫', 'üò∏',
                'üòπ', 'üòª', 'üòº', 'üòΩ', 'üôÄ', 'üòø', 'üòæ', '‚ù§Ô∏è',
                'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é',
                'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò',
                'üíù', 'üíü', 'üëç', 'üëé', 'üëå', 'ü§è', '‚úåÔ∏è', 'ü§û',
                'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üñï', 'üëá',
                '‚òùÔ∏è', 'üëã', 'ü§ö', 'üñêÔ∏è', '‚úã', 'üññ', 'üëè', 'üôå'
            ];
            
            // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑‰ø°ÊÅØ
            async function fetchCurrentUser() {
                try {
                    const response = await fetch('/user/detail', {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // ÊàêÂäüÁä∂ÊÄÅÁ†Å
                        currentUser = data.data;
                        elements.userNickname.textContent = currentUser.nickname || currentUser.account;
                        if (currentUser.avatar) {
                            elements.userAvatar.src = currentUser.avatar;
                        }
                        
                        // Ëé∑ÂèñÂ•ΩÂèãÂàóË°®
                        fetchFriends();
                        
                        // Âª∫Á´ãWebSocketËøûÊé•
                        connectWebSocket();
                    } else {
                        // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•ÔºåÂèØËÉΩÊòØtokenËøáÊúü
                        localStorage.removeItem('token');
                        window.location.href = 'login.html';
                    }
                } catch (error) {
                    console.error('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂá∫Èîô:', error);
                    alert('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
                }
            }
            
            // Ëé∑ÂèñÂ•ΩÂèãÂàóË°®
            async function fetchFriends() {
                try {
                    // Ë∞ÉÁî®ÂêéÁ´ØAPIËé∑ÂèñËÅîÁ≥ª‰∫∫ÂàóË°®
                    const response = await fetch('/user/chatlist', {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    // Ê∏ÖÁ©∫Â•ΩÂèãÂàóË°®
                    elements.friendList.innerHTML = '';
                    
                    if (data.code === 111) { // ÊàêÂäüÁä∂ÊÄÅÁ†Å
                        const chatlist = data.data.chatlist;
                        
                        // Â§ÑÁêÜËÅîÁ≥ª‰∫∫ÂàóË°®Êï∞ÊçÆ
                        friends = chatlist.map(contact => {
                            return {
                                nickname: contact.name,
                                account: contact.account, // Áî®Êà∑Ë¥¶Âè∑ÔºåÁî®‰∫éÊü•ËØ¢ËØ¶ÁªÜ‰ø°ÊÅØ
                                room_id: contact.room_id,
                                type: contact.type, // 1ÁßÅËÅä 2Áæ§ËÅä
                                last_message: '',
                                last_message_type: 'text', // ÊúÄÊñ∞Ê∂àÊÅØÁ±ªÂûã
                                avatar: 'https://avatars.githubusercontent.com/u/148515933?s=400&u=7cbff7c77a33416cabfe463fff24495157026760&v=4', // ÈªòËÆ§Â§¥ÂÉè
                                has_new_message: false, // ÊòØÂê¶ÊúâÊñ∞Ê∂àÊÅØ
                                new_message_count: 0 // Êñ∞Ê∂àÊÅØÊï∞Èáè
                            };
                        });
                        
                        // Ê∏≤ÊüìÂ•ΩÂèãÂàóË°®
                        renderFriendList(friends);
                    } else {
                        console.error('Ëé∑ÂèñËÅîÁ≥ª‰∫∫ÂàóË°®Â§±Ë¥•:', data.msg);
                        elements.friendList.innerHTML = '<div class="text-center text-gray-500 py-4">Ëé∑ÂèñËÅîÁ≥ª‰∫∫ÂàóË°®Â§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï</div>';
                    }
                } catch (error) {
                    console.error('Ëé∑ÂèñËÅîÁ≥ª‰∫∫ÂàóË°®Âá∫Èîô:', error);
                    elements.friendList.innerHTML = '<div class="text-center text-gray-500 py-4">ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï</div>';
                }
                
                // Â¶ÇÊûúÂ•ΩÂèãÂàóË°®‰∏∫Á©∫ÔºåÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
                if (friends.length === 0) {
                    elements.friendList.innerHTML = '<div class="text-center text-gray-500 py-4">ÊöÇÊó†ËÅîÁ≥ª‰∫∫ÔºåËØ∑Ê∑ªÂä†Â•ΩÂèã</div>';
                }
            }
            
            // Âª∫Á´ãWebSocketËøûÊé•
            function connectWebSocket() {
                // ÊûÑÂª∫WebSocket URLÔºåÊåáÂêëÂêéÁ´ØÊúçÂä°
                // Ëé∑ÂèñÂΩìÂâçÂüüÂêçÂíåÁ´ØÂè£
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.host;
                const wsUrl = `${protocol}//${host}/user/msg?token=${token}`;
                
                // ÂàõÂª∫WebSocketËøûÊé•
                socket = new WebSocket(wsUrl);
                
                // ËøûÊé•ÊâìÂºÄ‰∫ã‰ª∂
                socket.onopen = function(e) {
                    console.log('WebSocketËøûÊé•Â∑≤Âª∫Á´ã');
                };
                
                // Êé•Êî∂Ê∂àÊÅØ‰∫ã‰ª∂
                socket.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    console.log('Êî∂Âà∞Ê∂àÊÅØ:', message);
                    
                    // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®Êü•ÁúãÁöÑËÅäÂ§©ÂÆ§‰∏éÊ∂àÊÅØÁöÑËÅäÂ§©ÂÆ§Áõ∏ÂêåÔºåÂàôÊòæÁ§∫Ê∂àÊÅØ
                    if (currentRoomId === message.room_id) {
                        // Ê£ÄÊü•Êó•ÊúüÊòØÂê¶ÈúÄË¶ÅÊ∑ªÂä†ÂàÜÈöîÁ∫ø
                        const messageDate = new Date(message.created_at);
                        const messageDateStr = messageDate.toDateString();
                        
                        // Ëé∑ÂèñÊúÄÂêé‰∏Ä‰∏™Êó•ÊúüÂàÜÈöîÁ∫øÊàñÊ∂àÊÅØÁöÑÊó•Êúü
                        let lastDateStr = null;
                        const dateElements = chatMessages.querySelectorAll('.date-separator');
                        if (dateElements.length > 0) {
                            const lastDateElement = dateElements[dateElements.length - 1];
                            lastDateStr = lastDateElement.getAttribute('data-date');
                        }
                        
                        // Â¶ÇÊûúÊó•Êúü‰∏çÂêåÔºåÊ∑ªÂä†Êñ∞ÁöÑÊó•ÊúüÂàÜÈöîÁ∫ø
                        if (!lastDateStr || messageDateStr !== lastDateStr) {
                            addDateSeparator(messageDate);
                        }
                        
                        // Ê∑ªÂä†Ê∂àÊÅØÂà∞UI
                        appendMessage(message);
                        
                        // Ê∑ªÂä†Ê∂àÊÅØÂà∞ÂΩìÂâçÊ∂àÊÅØÂàóË°®
                        currentRoomMessages.push(message);
                        
                        // ÊªöÂä®Âà∞Â∫ïÈÉ®
                        elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
                    }
                    
                    // Êõ¥Êñ∞Â•ΩÂèãÂàóË°®‰∏≠ÁöÑÊúÄÊñ∞Ê∂àÊÅØ
                    updateFriendLastMessage(message);
                };
                
                // ËøûÊé•ÂÖ≥Èó≠‰∫ã‰ª∂
                socket.onclose = function(event) {
                    console.log('WebSocketËøûÊé•Â∑≤ÂÖ≥Èó≠');
                    // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ÈáçËøûÈÄªËæë
                };
                
                // ËøûÊé•ÈîôËØØ‰∫ã‰ª∂
                socket.onerror = function(error) {
                    console.error('WebSocketÈîôËØØ:', error);
                };
            }
            
            // Êõ¥Êñ∞Â•ΩÂèãÂàóË°®‰∏≠ÁöÑÊúÄÊñ∞Ê∂àÊÅØ
            function updateFriendLastMessage(message) {
                // Êü•ÊâæÂØπÂ∫îÁöÑÂ•ΩÂèã
                const friendIndex = friends.findIndex(f => f.room_id === message.room_id);
                if (friendIndex !== -1) {
                    // Ê†πÊçÆÊ∂àÊÅØÁ±ªÂûãËÆæÁΩÆÊòæÁ§∫ÂÜÖÂÆπ
                    let displayMessage = '';
                    const messageType = message.type || 'text';
                    
                    switch (messageType) {
                        case 'emoji':
                            displayMessage = message.data || message.message;
                            break;
                        case 'image':
                            displayMessage = '[ÂõæÁâá]';
                            break;
                        case 'file':
                            displayMessage = '[Êñá‰ª∂]';
                            break;
                        case 'video':
                            displayMessage = '[ËßÜÈ¢ë]';
                            break;
                        case 'speech':
                            displayMessage = '[ËØ≠Èü≥]';
                            break;
                        case 'text':
                        default:
                            displayMessage = message.data || message.message;
                            break;
                    }
                    
                    // Êõ¥Êñ∞ÊúÄÊñ∞Ê∂àÊÅØ
                    friends[friendIndex].last_message = displayMessage;
                    friends[friendIndex].last_message_type = messageType;
                    
                    // Â¶ÇÊûú‰∏çÊòØÂΩìÂâçËÅäÂ§©ÂÆ§ÁöÑÊ∂àÊÅØÔºåÊ†áËÆ∞‰∏∫ÊúâÊñ∞Ê∂àÊÅØ
                    if (message.room_id !== currentRoomId) {
                        friends[friendIndex].has_new_message = true;
                        friends[friendIndex].new_message_count = (friends[friendIndex].new_message_count || 0) + 1;
                    }
                    
                    // ÈáçÊñ∞Ê∏≤ÊüìÂ•ΩÂèãÂàóË°®
                    renderFriendList(friends);
                }
            }
            
            // Ê∑ªÂä†Êó•ÊúüÂàÜÈöîÁ∫ø
            function addDateSeparator(date) {
                const dateStr = date.getFullYear() + '/' + 
                               String(date.getMonth() + 1).padStart(2, '0') + '/' + 
                               String(date.getDate()).padStart(2, '0');
                
                const separatorElement = document.createElement('div');
                separatorElement.className = 'flex justify-center my-4 date-separator';
                separatorElement.setAttribute('data-date', date.toDateString());
                separatorElement.innerHTML = `
                    <div class="px-4 py-1 bg-gray-100 rounded-full text-xs text-gray-500">
                        ${dateStr}
                    </div>
                `;
                
                elements.chatMessages.appendChild(separatorElement);
            }
            
            // ËÅäÂ§©ËÆ∞ÂΩïÂàÜÈ°µÂèòÈáè
            let currentPage = 1;
            let isLoadingMessages = false;
            let hasMoreMessages = true;
            let currentRoomMessages = [];
            
            // Âä†ËΩΩËÅäÂ§©ËÆ∞ÂΩï
            async function loadChatMessages(roomId, page = 1, pageSize = 20, append = false) {
                try {
                    // Â¶ÇÊûúÊ≠£Âú®Âä†ËΩΩÊàñÊ≤°ÊúâÊõ¥Â§öÊ∂àÊÅØÔºåÂàôËøîÂõû
                    if (isLoadingMessages || (page > 1 && !hasMoreMessages)) {
                        return;
                    }
                    
                    isLoadingMessages = true;
                    
                    // Â¶ÇÊûúÊòØÂä†ËΩΩÁ¨¨‰∏ÄÈ°µÔºåÈáçÁΩÆÂàÜÈ°µÂèòÈáè
                    if (page === 1 && !append) {
                        currentPage = 1;
                        hasMoreMessages = true;
                        currentRoomMessages = [];
                    }
                    
                    // ÊòæÁ§∫Âä†ËΩΩÊåáÁ§∫Âô®
                    if (page > 1) {
                        const loadingIndicator = document.createElement('div');
                        loadingIndicator.id = 'loading-indicator';
                        loadingIndicator.className = 'flex justify-center my-4';
                        loadingIndicator.innerHTML = `
                            <div class="px-4 py-1 bg-gray-100 rounded-full text-xs text-gray-500 flex items-center">
                                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Âä†ËΩΩÊõ¥Â§öÊ∂àÊÅØ...
                            </div>
                        `;
                        elements.chatMessages.insertBefore(loadingIndicator, elements.chatMessages.firstChild);
                    }
                    
                    const response = await fetch(`/user/history?room_id=${roomId}&page_index=${page}&page_size=${pageSize}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    // ÁßªÈô§Âä†ËΩΩÊåáÁ§∫Âô®
                    const loadingIndicator = document.getElementById('loading-indicator');
                    if (loadingIndicator) {
                        loadingIndicator.remove();
                    }
                    
                    if (data.code === 111) { // ÊàêÂäüÁä∂ÊÄÅÁ†Å
                        // ÊòæÁ§∫ËÅäÂ§©ËÆ∞ÂΩï
                        const messages = data.data.list;
                        
                        // Â¶ÇÊûúÊ≤°ÊúâÊ∂àÊÅØÔºå‰∏îÊòØÁ¨¨‰∏ÄÈ°µÔºåÊòæÁ§∫ÊöÇÊó†ËÅäÂ§©ËÆ∞ÂΩï
                        if (messages.length === 0 && page === 1 && !append) {
                            elements.chatMessages.innerHTML = '<div class="flex justify-center my-4"><p class="text-gray-500">ÊöÇÊó†ËÅäÂ§©ËÆ∞ÂΩï</p></div>';
                            hasMoreMessages = false;
                        } else if (messages.length === 0) {
                            // Â¶ÇÊûúÊòØÂÖ∂‰ªñÈ°µ‰∏îÊ≤°ÊúâÊ∂àÊÅØÔºåËØ¥ÊòéÊ≤°ÊúâÊõ¥Â§öÊ∂àÊÅØ‰∫Ü
                            hasMoreMessages = false;
                            
                            // Ê∑ªÂä†Ê≤°ÊúâÊõ¥Â§öÊ∂àÊÅØÁöÑÊèêÁ§∫
                            const noMoreMessagesIndicator = document.createElement('div');
                            noMoreMessagesIndicator.className = 'flex justify-center my-4';
                            noMoreMessagesIndicator.innerHTML = `
                                <div class="px-4 py-1 bg-gray-100 rounded-full text-xs text-gray-500">
                                    Ê≤°ÊúâÊõ¥Â§öÊ∂àÊÅØ‰∫Ü
                                </div>
                            `;
                            elements.chatMessages.insertBefore(noMoreMessagesIndicator, elements.chatMessages.firstChild);
                        } else {
                            // ÊåâÊó∂Èó¥È°∫Â∫èÊòæÁ§∫Ê∂àÊÅØ
                            messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                            
                            // ‰øùÂ≠òÂΩìÂâçÊªöÂä®‰ΩçÁΩÆÂíåÈ´òÂ∫¶
                            const scrollPos = elements.chatMessages.scrollTop;
                            const oldHeight = elements.chatMessages.scrollHeight;
                            
                            // ÂêàÂπ∂Ê∂àÊÅØÂà∞ÂΩìÂâçÊàøÈó¥Ê∂àÊÅØÂàóË°®
                            if (page === 1 && !append) {
                                // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÈ°µ‰∏î‰∏çÊòØËøΩÂä†Ê®°ÂºèÔºåÊ∏ÖÁ©∫ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü
                                elements.chatMessages.innerHTML = '';
                                currentRoomMessages = messages;
                            } else {
                                // Â∞ÜÊñ∞Ê∂àÊÅØÊ∑ªÂä†Âà∞Êï∞ÁªÑÂºÄÂ§¥
                                currentRoomMessages = [...messages, ...currentRoomMessages];
                            }
                            
                            // ÈáçÊñ∞Ê∏≤ÊüìÊâÄÊúâÊ∂àÊÅØÊàñËøΩÂä†Êñ∞Ê∂àÊÅØ
                            if (page > 1 || append) {
                                // Â¶ÇÊûúÊòØÂä†ËΩΩÊõ¥Â§öÊàñËøΩÂä†Ê®°Âºè
                                if (page > 1) {
                                    // Ê∏ÖÁ©∫ËÅäÂ§©Âå∫Âüü
                                    elements.chatMessages.innerHTML = '';
                                    
                                    // ÈáçÊñ∞Ê∏≤ÊüìÊâÄÊúâÊ∂àÊÅØ
                                    let currentDate = null;
                                    
                                    currentRoomMessages.forEach(msg => {
                                        const messageDate = new Date(msg.created_at);
                                        const messageDateStr = messageDate.toDateString();
                                        
                                        // Â¶ÇÊûúÊó•ÊúüÂèòÂåñÔºåÊ∑ªÂä†Êó•ÊúüÂàÜÈöîÁ∫ø
                                        if (!currentDate || messageDateStr !== currentDate) {
                                            currentDate = messageDateStr;
                                            addDateSeparator(messageDate);
                                        }
                                        
                                        // Áõ¥Êé•‰º†ÈÄíMessageBasicÂØπË±°ÔºåÂåÖÂê´ÊâÄÊúâÂøÖË¶ÅÂ≠óÊÆµ
                                        appendMessage(msg);
                                    });
                                    
                                    // ËÆ°ÁÆóÊñ∞Â¢ûÂÜÖÂÆπÁöÑÈ´òÂ∫¶ÔºåÂπ∂Ë∞ÉÊï¥ÊªöÂä®‰ΩçÁΩÆ
                                    const newHeight = elements.chatMessages.scrollHeight;
                                    elements.chatMessages.scrollTop = scrollPos + (newHeight - oldHeight);
                                } else {
                                    // Â¶ÇÊûúÊòØËøΩÂä†Ê®°Âºè‰ΩÜ‰∏çÊòØÂä†ËΩΩÊõ¥Â§öÔºåÊªöÂä®Âà∞Â∫ïÈÉ®
                                    elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
                                }
                            } else {
                                // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÈ°µ‰∏î‰∏çÊòØËøΩÂä†Ê®°ÂºèÔºåÁõ¥Êé•Ê∏≤Êüì
                                let currentDate = null;
                                
                                messages.forEach(msg => {
                                    const messageDate = new Date(msg.created_at);
                                    const messageDateStr = messageDate.toDateString();
                                    
                                    // Â¶ÇÊûúÊó•ÊúüÂèòÂåñÔºåÊ∑ªÂä†Êó•ÊúüÂàÜÈöîÁ∫ø
                                    if (!currentDate || messageDateStr !== currentDate) {
                                        currentDate = messageDateStr;
                                        addDateSeparator(messageDate);
                                    }
                                    
                                    // Áõ¥Êé•‰º†ÈÄíMessageBasicÂØπË±°ÔºåÂåÖÂê´ÊâÄÊúâÂøÖË¶ÅÂ≠óÊÆµ
                                    appendMessage(msg);
                                });
                                
                                // ÊªöÂä®Âà∞Â∫ïÈÉ®
                                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
                            }
                            
                            // Êõ¥Êñ∞ÂΩìÂâçÈ°µÁ†Å
                            currentPage = page;
                        }
                    } else {
                        console.error('Ëé∑ÂèñËÅäÂ§©ËÆ∞ÂΩïÂ§±Ë¥•:', data.msg);
                    }
                } catch (error) {
                    console.error('Ëé∑ÂèñËÅäÂ§©ËÆ∞ÂΩïÂá∫Èîô:', error);
                } finally {
                    isLoadingMessages = false;
                }
            }
            
            // Ê∑ªÂä†Ê∂àÊÅØÂà∞ËÅäÂ§©Âå∫Âüü
            function appendMessage(message) {
                const isCurrentUser = message.user_id === currentUser.user_id;
                
                const messageElement = document.createElement('div');
                messageElement.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'} mb-4`;
                
                // Ê†ºÂºèÂåñÂèëÈÄÅÊó∂Èó¥ÔºåÂè™Á≤æÁ°ÆÂà∞ÂàÜÈíü
                const createdTime = new Date(message.created_at || new Date()).toLocaleTimeString([], { 
                    hour: '2-digit', minute: '2-digit' 
                });
                
                // Ëé∑ÂèñÁî®Êà∑ÊòµÁß∞
                const userName = isCurrentUser ? currentUser.nickname : (currentChatUser?.nickname || 'Áî®Êà∑');
                
                // Ê†πÊçÆÊ∂àÊÅØÁ±ªÂûãÊ∏≤Êüì‰∏çÂêåÁöÑÂÜÖÂÆπ
                let messageContent = '';
                const messageType = message.type || 'text'; // ÈªòËÆ§‰∏∫ÊñáÊú¨Á±ªÂûã
                
                switch (messageType) {
                    case 'emoji':
                        messageContent = `<span class="text-4xl">${message.data}</span>`;
                        break;
                    case 'image':
                        messageContent = `
                            <div class="max-w-48">
                                <img src="${message.data}" alt="${message.file_name || 'ÂõæÁâá'}" class="rounded-lg max-w-full h-auto cursor-pointer" onclick="window.open('${message.data}', '_blank')">
                                <p class="text-xs text-gray-500 mt-1">${message.file_name || 'ÂõæÁâá'}</p>
                            </div>
                        `;
                        break;
                    case 'file':
                        const fileSize = message.file_size ? (message.file_size / 1024 / 1024).toFixed(2) + 'MB' : 'Êú™Áü•Â§ßÂ∞è';
                        messageContent = `
                            <div class="flex items-center space-x-3 p-3 border border-gray-300 rounded-lg bg-white">
                                <div class="flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate">${message.file_name || 'Êñá‰ª∂'}</p>
                                    <p class="text-xs text-gray-500">${fileSize}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <a href="${message.data}" download="${message.file_name}" class="text-indigo-600 hover:text-indigo-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        `;
                        break;
                    case 'text':
                    default:
                        messageContent = `<p>${message.data || message.message}</p>`;
                        break;
                }
                
                messageElement.innerHTML = `
                    <div class="${isCurrentUser ? 'order-2' : 'order-1'} flex-shrink-0">
                        <img src="${isCurrentUser ? (currentUser.avatar || 'https://via.placeholder.com/32') : (currentChatUser?.avatar || 'https://via.placeholder.com/32')}" alt="Â§¥ÂÉè" class="w-8 h-8 rounded-full ring-2 ring-white shadow-sm">
                    </div>
                    <div class="${isCurrentUser ? 'order-1' : 'order-2'} max-w-xs mx-2">
                        <div class="${isCurrentUser ? 'text-right' : 'text-left'} text-xs text-gray-500 mb-1">${userName}</div>
                        <div class="${isCurrentUser ? 'bg-gray-900 text-white' : 'bg-white border border-gray-200/60 text-gray-800'} rounded-xl ${messageType === 'emoji' ? 'px-3 py-2' : messageType === 'image' || messageType === 'file' ? 'p-3' : 'px-4 py-3'} shadow-sm">
                            ${messageContent}
                        </div>
                        <div class="text-xs text-gray-400 ${isCurrentUser ? 'text-right' : 'text-left'} mt-1">
                            <span>${createdTime}</span>
                        </div>
                    </div>
                `;
                
                elements.chatMessages.appendChild(messageElement);
                
                // ÊªöÂä®Âà∞Â∫ïÈÉ®
                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            }
            
            // Ê∑ªÂä†ÊªöÂä®‰∫ã‰ª∂ÁõëÂê¨Ôºå‰∏äÊªëÂä†ËΩΩÊõ¥Â§öÊ∂àÊÅØ
            function setupScrollListener() {
                // ÁßªÈô§‰πãÂâçÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÂ¶ÇÊûúÊúâÔºâ
                elements.chatMessages.removeEventListener('scroll', handleScroll);
                
                // Ê∑ªÂä†Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                elements.chatMessages.addEventListener('scroll', handleScroll);
            }
            
            // Â§ÑÁêÜÊªöÂä®‰∫ã‰ª∂
            function handleScroll() {
                // Â¶ÇÊûúÊªöÂä®Âà∞È°∂ÈÉ®ÈôÑËøëÔºàË∑ùÁ¶ªÈ°∂ÈÉ®Â∞è‰∫é50ÂÉèÁ¥†ÔºâÔºåÂä†ËΩΩÊõ¥Â§öÊ∂àÊÅØ
                if (elements.chatMessages.scrollTop < 50 && !isLoadingMessages && hasMoreMessages && currentRoomId) {
                    // Âä†ËΩΩ‰∏ã‰∏ÄÈ°µÊ∂àÊÅØ
                    loadChatMessages(currentRoomId, currentPage + 1, 20, true);
                }
            }
            
            // ÊâìÂºÄËÅäÂ§©
            function openChat(roomId, contact) {
                // Â¶ÇÊûúÊòØÂêå‰∏Ä‰∏™ËÅäÂ§©Ôºå‰∏çÈáçÊñ∞Âä†ËΩΩ
                if (currentRoomId === roomId) {
                    return;
                }
                
                currentRoomId = roomId;
                currentChatUser = contact;
                
                // Ê∏ÖÈô§ËØ•Â•ΩÂèãÁöÑÊñ∞Ê∂àÊÅØÊèêÁ§∫
                const friendIndex = friends.findIndex(f => f.room_id === roomId);
                if (friendIndex !== -1) {
                    friends[friendIndex].has_new_message = false;
                    friends[friendIndex].new_message_count = 0;
                    // ÈáçÊñ∞Ê∏≤ÊüìÂ•ΩÂèãÂàóË°®‰ª•Êõ¥Êñ∞UI
                    renderFriendList(friends);
                }
                
                // ÈáçÁΩÆÂàÜÈ°µÂèòÈáè
                currentPage = 1;
                hasMoreMessages = true;
                currentRoomMessages = [];
                
                // Êõ¥Êñ∞ËÅäÂ§©Ê†áÈ¢òÔºåÊ†πÊçÆÁ±ªÂûãÊòæÁ§∫‰∏çÂêåÁöÑÊ†áÈ¢ò
                const chatType = contact.type === 1 ? 'ÁßÅËÅä' : 'Áæ§ËÅä';
                elements.chatTitle.innerHTML = `${contact.nickname} <span class="text-sm text-gray-500">(${chatType})</span>`;
                
                // ÊòæÁ§∫ËÅäÂ§©ËæìÂÖ•Âå∫Âüü
                elements.chatInputArea.classList.remove('hidden');
                
                // ÊòæÁ§∫ËÅäÂ§©Êìç‰ΩúÂå∫ÂüüÔºåÂè™ÊúâÁßÅËÅäÊâçÊòæÁ§∫Êü•ÁúãËµÑÊñôÊåâÈíÆ
                elements.chatActions.classList.remove('hidden');
                if (contact.type === 1) {
                    elements.viewProfileBtn.classList.remove('hidden');
                } else {
                    elements.viewProfileBtn.classList.add('hidden');
                }
                
                // Âä†ËΩΩËÅäÂ§©ËÆ∞ÂΩï
                loadChatMessages(roomId);
                
                // ËÆæÁΩÆÊªöÂä®‰∫ã‰ª∂ÁõëÂê¨
                setupScrollListener();
            }
            
            // ÊêúÁ¥¢Â•ΩÂèã
            async function searchFriend(account) {
                try {
                    const response = await fetch(`/user/query?account=${account}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // ÊàêÂäüÁä∂ÊÄÅÁ†Å
                        return data.data;
                    } else {
                        throw new Error(data.msg || 'ÊêúÁ¥¢Â•ΩÂèãÂ§±Ë¥•');
                    }
                } catch (error) {
                    console.error('ÊêúÁ¥¢Â•ΩÂèãÂá∫Èîô:', error);
                    throw error;
                }
            }
            
            // Ê∑ªÂä†Â•ΩÂèã
            async function addFriend(account) {
                try {
                    const formData = new FormData();
                    formData.append('account', account);
                    
                    const response = await fetch('/user/add', {
                        method: 'POST',
                        headers: {
                            'Authorization': token
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // ÊàêÂäüÁä∂ÊÄÅÁ†Å
                        return data.data;
                    } else {
                        throw new Error(data.msg || 'Ê∑ªÂä†Â•ΩÂèãÂ§±Ë¥•');
                    }
                } catch (error) {
                    console.error('Ê∑ªÂä†Â•ΩÂèãÂá∫Èîô:', error);
                    throw error;
                }
            }
            
            // Âà†Èô§Â•ΩÂèã
            async function deleteFriend(roomId) {
                try {
                    // ‰ªéÂΩìÂâçÂ•ΩÂèãÂàóË°®‰∏≠ÊâæÂà∞ÂØπÂ∫îÁöÑÂ•ΩÂèã‰ø°ÊÅØ
                    const friend = friends.find(f => f.room_id === roomId);
                    if (!friend) {
                        throw new Error('Êâæ‰∏çÂà∞ËØ•Â•ΩÂèã‰ø°ÊÅØ');
                    }
                    
                    // ÊûÑÂª∫ËØ∑Ê±ÇÂèÇÊï∞
                    const formData = new FormData();
                    formData.append('room_id', roomId);
                    
                    const response = await fetch('/user/delete', {
                        method: 'DELETE',
                        headers: {
                            'Authorization': token
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // ÊàêÂäüÁä∂ÊÄÅÁ†Å
                        return true;
                    } else {
                        throw new Error(data.msg || 'Âà†Èô§Â•ΩÂèãÂ§±Ë¥•');
                    }
                } catch (error) {
                    console.error('Âà†Èô§Â•ΩÂèãÂá∫Èîô:', error);
                    throw error;
                }
            }
            
            // Áî®Êà∑‰∏≠ÂøÉÁõ∏ÂÖ≥ÂáΩÊï∞
            function openUserCenter() {
                // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                elements.userCenterModal.classList.remove('hidden');
                // Ëß¶ÂèëÊªëÂÖ•Âä®Áîª
                setTimeout(() => {
                    elements.userCenterPanel.classList.remove('translate-x-full');
                }, 10);
                
                // Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØ
                loadUserProfile();
            }
            
            function closeUserCenter() {
                // Ëß¶ÂèëÊªëÂá∫Âä®Áîª
                elements.userCenterPanel.classList.add('translate-x-full');
                // ÈöêËóèÊ®°ÊÄÅÊ°Ü
                setTimeout(() => {
                    elements.userCenterModal.classList.add('hidden');
                }, 300);
            }
            
            function openProfile() {
                // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                elements.profileModal.classList.remove('hidden');
                // Ëß¶ÂèëÊªëÂÖ•Âä®Áîª
                setTimeout(() => {
                    elements.profilePanel.classList.remove('translate-x-full');
                }, 10);
                
                // Âä†ËΩΩÂ•ΩÂèã‰ø°ÊÅØ
                loadFriendProfile();
            }
            
            function closeProfile() {
                // Ëß¶ÂèëÊªëÂá∫Âä®Áîª
                elements.profilePanel.classList.add('translate-x-full');
                // ÈöêËóèÊ®°ÊÄÅÊ°Ü
                setTimeout(() => {
                    elements.profileModal.classList.add('hidden');
                }, 300);
            }
            
            // ÊòæÁ§∫Âè™ËØªÊ®°Âºè
            function showViewMode() {
                elements.profileViewMode.classList.remove('hidden');
                elements.profileForm.classList.add('hidden');
            }
            
            // ÊòæÁ§∫ÁºñËæëÊ®°Âºè
            function showEditMode() {
                elements.profileViewMode.classList.add('hidden');
                elements.profileForm.classList.remove('hidden');
            }
            
            // Âä†ËΩΩÁî®Êà∑ËµÑÊñô
            async function loadUserProfile() {
                try {
                    const response = await fetch('/user/detail', {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) {
                        const user = data.data;
                        elements.profileAvatar.src = user.avatar || 'https://via.placeholder.com/80';
                        
                        // Êõ¥Êñ∞ÊòæÁ§∫Ê®°Âºè
                        elements.profileNicknameDisplay.textContent = user.nickname || '';
                        elements.profileAccountDisplay.textContent = user.account || '';
                        elements.profileEmailDisplay.textContent = user.email || '';
                        
                        // Êõ¥Êñ∞ÁºñËæëÊ®°Âºè
                        elements.profileNickname.value = user.nickname || '';
                        elements.profileAccount.value = user.account || '';
                        elements.profileEmail.value = user.email || '';

                    } else {
                        alert('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•');
                    }
                } catch (error) {
                    console.error('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂá∫Èîô:', error);
                    alert('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
                }
            }
            
            // Âä†ËΩΩÂ•ΩÂèãËµÑÊñô
            async function loadFriendProfile() {
                if (!currentChatUser) return;
                
                try {
                    // Ë∞ÉÁî®/user/queryÊé•Âè£Ëé∑ÂèñÂ•ΩÂèãËØ¶ÁªÜ‰ø°ÊÅØ
                    if (!currentChatUser.account) {
                        console.warn('ÂΩìÂâçËÅäÂ§©Áî®Êà∑Áº∫Â∞ëaccount‰ø°ÊÅØ');
                        // ‰ΩøÁî®Â§áÁî®‰ø°ÊÅØ
                        elements.friendProfileAvatar.src = currentChatUser.avatar || 'https://via.placeholder.com/80';
                        elements.friendProfileNickname.textContent = currentChatUser.nickname || '';
                        elements.friendProfileAccount.textContent = currentChatUser.account || '';
                        elements.friendProfileEmail.textContent = currentChatUser.email || '';

                        return;
                    }
                    
                    const response = await fetch(`/user/query?account=${encodeURIComponent(currentChatUser.account)}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // ÊàêÂäüÁä∂ÊÄÅÁ†Å
                        const userInfo = data.data;
                        elements.friendProfileAvatar.src = userInfo.avatar || 'https://via.placeholder.com/80';
                        elements.friendProfileNickname.textContent = userInfo.nickname || '';
                        elements.friendProfileAccount.textContent = userInfo.account || '';
                        elements.friendProfileEmail.textContent = userInfo.email || '';

                    } else {
                        // Â¶ÇÊûúÊé•Âè£Ë∞ÉÁî®Â§±Ë¥•Ôºå‰ΩøÁî®ÂΩìÂâçËÅäÂ§©Áî®Êà∑ÁöÑ‰ø°ÊÅØ‰Ωú‰∏∫Â§áÁî®
                        console.warn('Ëé∑ÂèñÂ•ΩÂèãËØ¶ÁªÜ‰ø°ÊÅØÂ§±Ë¥•:', data.msg);
                        elements.friendProfileAvatar.src = currentChatUser.avatar || 'https://via.placeholder.com/80';
                        elements.friendProfileNickname.textContent = currentChatUser.nickname || '';
                        elements.friendProfileAccount.textContent = currentChatUser.account || '';
                        elements.friendProfileEmail.textContent = currentChatUser.email || '';

                    }
                } catch (error) {
                    console.error('Ëé∑ÂèñÂ•ΩÂèã‰ø°ÊÅØÂá∫Èîô:', error);
                    // ÁΩëÁªúÈîôËØØÊó∂‰ΩøÁî®ÂΩìÂâçËÅäÂ§©Áî®Êà∑ÁöÑ‰ø°ÊÅØ‰Ωú‰∏∫Â§áÁî®
                    elements.friendProfileAvatar.src = currentChatUser.avatar || 'https://via.placeholder.com/80';
                    elements.friendProfileNickname.textContent = currentChatUser.nickname || '';
                    elements.friendProfileAccount.textContent = currentChatUser.account || '';
                    elements.friendProfileEmail.textContent = currentChatUser.email || '';
                    
                    alert('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
                }
            }
            
            // ‰∫ã‰ª∂ÁõëÂê¨
            
            // Áî®Êà∑‰∏≠ÂøÉÊåâÈíÆ
            elements.userCenterBtn.addEventListener('click', function() {
                openUserCenter();
                // Á°Æ‰øùÊâìÂºÄÊó∂ÊòæÁ§∫Âè™ËØªÊ®°Âºè
                showViewMode();
            });
            
            // ÁºñËæëËµÑÊñôÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            elements.editProfileBtn.addEventListener('click', function() {
                showEditMode();
            });
            
            // ÂèñÊ∂àÁºñËæëÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            elements.cancelEditBtn.addEventListener('click', function() {
                showViewMode();
            });
            
            // Áî®Êà∑‰∏≠ÂøÉÂÖ≥Èó≠ÊåâÈíÆ
            elements.closeUserCenterBtn.addEventListener('click', closeUserCenter);
            
            // Áî®Êà∑‰∏≠ÂøÉËÉåÊôØÈÅÆÁΩ©
            elements.userCenterBackdrop.addEventListener('click', closeUserCenter);
            
            // Êü•ÁúãËµÑÊñôÊåâÈíÆ
            elements.viewProfileBtn.addEventListener('click', openProfile);
            
            // Êü•ÁúãËµÑÊñôÂÖ≥Èó≠ÊåâÈíÆ
            elements.closeProfileBtn.addEventListener('click', closeProfile);
            
            // Êü•ÁúãËµÑÊñôËÉåÊôØÈÅÆÁΩ©
            elements.profileBackdrop.addEventListener('click', closeProfile);
            
            // Áî®Êà∑ËµÑÊñôË°®ÂçïÊèê‰∫§
            elements.profileForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØÁöÑAPIË∞ÉÁî®
                    alert('ËµÑÊñôÊõ¥Êñ∞ÂäüËÉΩÂæÖÂÆûÁé∞');
                    
                    // Êõ¥Êñ∞ÊàêÂäüÂêéÂàáÊç¢ÂõûÂè™ËØªÊ®°Âºè
                    showViewMode();
                    // ÈáçÊñ∞Âä†ËΩΩÁî®Êà∑ËµÑÊñô‰ª•ÊòæÁ§∫ÊúÄÊñ∞Êï∞ÊçÆ
                    loadUserProfile();
                } catch (error) {
                    console.error('Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØÂá∫Èîô:', error);
                    alert('Êõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
                }
            });
            
            // ‰øÆÊîπÂØÜÁ†ÅÊåâÈíÆ
            elements.changePasswordBtn.addEventListener('click', function() {
                alert('‰øÆÊîπÂØÜÁ†ÅÂäüËÉΩÂæÖÂÆûÁé∞');
            });
            
            // Âà†Èô§Â•ΩÂèãÊåâÈíÆÔºàÂú®Êü•ÁúãËµÑÊñôÁ™óÂè£‰∏≠Ôºâ
            elements.deleteFriendBtn.addEventListener('click', async function() {
                if (!currentChatUser || !currentRoomId) return;
                
                // Âè™ÊúâÁßÅËÅäÊâçËÉΩÂà†Èô§Â•ΩÂèã
                if (currentChatUser.type !== 1) {
                    alert('Âè™ËÉΩÂà†Èô§ÁßÅËÅäËÅîÁ≥ª‰∫∫');
                    return;
                }
                
                if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Â•ΩÂèã ${currentChatUser.nickname} ÂêóÔºü`)) {
                    try {
                        await deleteFriend(currentRoomId);
                        
                        // ÂÖ≥Èó≠ËµÑÊñôÁ™óÂè£
                        closeProfile();
                        
                        // ÈáçÊñ∞Ëé∑ÂèñÂ•ΩÂèãÂàóË°®
                        fetchFriends();
                        
                        // ÈáçÁΩÆËÅäÂ§©Âå∫Âüü
                        currentRoomId = null;
                        currentChatUser = null;
                        elements.chatTitle.textContent = 'ËØ∑ÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©';
                        elements.chatMessages.innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-gray-500">ÈÄâÊã©‰∏Ä‰∏™ËÅîÁ≥ª‰∫∫ÂºÄÂßãËÅäÂ§©</p></div>';
                        elements.chatInputArea.classList.add('hidden');
                        elements.chatActions.classList.add('hidden');
                        
                        alert('Âà†Èô§Â•ΩÂèãÊàêÂäü');
                    } catch (error) {
                        alert(error.message || 'Âà†Èô§Â•ΩÂèãÂ§±Ë¥•');
                    }
                }
            });
            
            // ÈÄÄÂá∫ÁôªÂΩï
            elements.logoutBtn.addEventListener('click', function() {
                // ÂÖ≥Èó≠WebSocketËøûÊé•
                if (socket) {
                    socket.close();
                }
                
                // Ê∏ÖÈô§Êú¨Âú∞Â≠òÂÇ®ÁöÑtoken
                localStorage.removeItem('token');
                
                // Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢
                window.location.href = 'login.html';
            });
            
            // ÂèëÈÄÅÊ∂àÊÅØ
            elements.messageForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const message = elements.messageInput.value.trim();
                if (!message) return;
                
                if (!currentRoomId) {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©');
                    return;
                }
                
                // Ëé∑ÂèñÂΩìÂâçÊó•Êúü
                const now = new Date();
                const todayStr = now.toDateString();
                
                // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊ∑ªÂä†Êó•ÊúüÂàÜÈöîÁ∫ø
                let lastDateStr = null;
                const dateElements = elements.chatMessages.querySelectorAll('.date-separator');
                if (dateElements.length > 0) {
                    const lastDateElement = dateElements[dateElements.length - 1];
                    lastDateStr = lastDateElement.getAttribute('data-date');
                }
                
                // Â¶ÇÊûúÊó•Êúü‰∏çÂêåÊàñÊ≤°ÊúâÊó•ÊúüÂàÜÈöîÁ∫øÔºåÊ∑ªÂä†Êñ∞ÁöÑÊó•ÊúüÂàÜÈöîÁ∫ø
                if (!lastDateStr || todayStr !== lastDateStr) {
                    addDateSeparator(now);
                }
                
                // ÊûÑÂª∫Ê∂àÊÅØÂØπË±°Ôºå‰ΩøÁî®dataÂ≠óÊÆµÂåπÈÖçMessageBasicÁªìÊûÑ
                const messageObj = {
                    user_id: currentUser.user_id,
                    room_id: currentRoomId,
                    data: message,
                    type: 'text', // ËÆæÁΩÆÊ∂àÊÅØÁ±ªÂûã‰∏∫ÊñáÊú¨
                    created_at: now.toISOString() // Ê∑ªÂä†ÂàõÂª∫Êó∂Èó¥
                };
                
                // ÂèëÈÄÅÊ∂àÊÅØ
                socket.send(JSON.stringify(messageObj));
                
                // Ê∑ªÂä†Ê∂àÊÅØÂà∞ÂΩìÂâçÊ∂àÊÅØÂàóË°®ÔºàÊú¨Âú∞ÊòæÁ§∫Ôºå‰∏çÁ≠âÂæÖÊúçÂä°Âô®ÂìçÂ∫îÔºâ
                // Ê≥®ÊÑèÔºöÊúçÂä°Âô®ÂìçÂ∫îÂêé‰ºöÈÄöËøáWebSocketÂÜçÊ¨°Êî∂Âà∞ËøôÊù°Ê∂àÊÅØÔºå‰ΩÜÁî±‰∫éÂ∑≤ÁªèÊ∑ªÂä†ËøáÔºå‰∏ç‰ºöÈáçÂ§çÊòæÁ§∫
                currentRoomMessages.push(messageObj);
                
                // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
                elements.messageInput.value = '';
            });
            
            // ÊâìÂºÄÊ∑ªÂä†Â•ΩÂèãÊ®°ÊÄÅÊ°Ü
            elements.addFriendBtn.addEventListener('click', function() {
                // ÈáçÁΩÆË°®Âçï
                elements.addFriendForm.reset();
                elements.searchResult.classList.add('hidden');
                elements.confirmAddFriendBtn.classList.add('hidden');
                elements.addFriendError.classList.add('hidden');
                elements.addFriendSuccess.classList.add('hidden');
                
                // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                elements.addFriendModal.classList.remove('hidden');
            });
            
            // ÂÖ≥Èó≠Ê∑ªÂä†Â•ΩÂèãÊ®°ÊÄÅÊ°Ü
            elements.closeAddFriendModal.addEventListener('click', function() {
                elements.addFriendModal.classList.add('hidden');
            });
            
            // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            elements.addFriendModal.addEventListener('click', function(e) {
                if (e.target === elements.addFriendModal) {
                    elements.addFriendModal.classList.add('hidden');
                }
            });
            
            // ÊêúÁ¥¢Â•ΩÂèã
            elements.searchFriendBtn.addEventListener('click', async function() {
                const account = elements.friendAccount.value.trim();
                if (!account) {
                    elements.addFriendErrorText.textContent = 'ËØ∑ËæìÂÖ•Â•ΩÂèãË¥¶Âè∑';
                    elements.addFriendError.classList.remove('hidden');
                    elements.addFriendSuccess.classList.add('hidden');
                    return;
                }
                
                try {
                    const user = await searchFriend(account);
                    
                    // ÊòæÁ§∫ÊêúÁ¥¢ÁªìÊûú
                    elements.resultNickname.textContent = user.nickname || user.account;
                    elements.resultAccount.textContent = user.account;
                    if (user.avatar) {
                        elements.resultAvatar.src = user.avatar;
                    }
                    
                    elements.searchResult.classList.remove('hidden');
                    
                    // Â¶ÇÊûúÂ∑≤ÁªèÊòØÂ•ΩÂèãÔºå‰∏çÊòæÁ§∫Ê∑ªÂä†ÊåâÈíÆ
                    if (user.is_friend) {
                        elements.addFriendErrorText.textContent = 'ËØ•Áî®Êà∑Â∑≤ÁªèÊòØÊÇ®ÁöÑÂ•ΩÂèã';
                        elements.addFriendError.classList.remove('hidden');
                        elements.addFriendSuccess.classList.add('hidden');
                        elements.confirmAddFriendBtn.classList.add('hidden');
                    } else {
                        elements.addFriendError.classList.add('hidden');
                        elements.addFriendSuccess.classList.add('hidden');
                        elements.confirmAddFriendBtn.classList.remove('hidden');
                        
                        // Â≠òÂÇ®ÊêúÁ¥¢Âà∞ÁöÑÁî®Êà∑‰ø°ÊÅØ
                        elements.confirmAddFriendBtn.dataset.account = user.account;
                    }
                } catch (error) {
                    elements.addFriendErrorText.textContent = error.message || 'ÊêúÁ¥¢Â•ΩÂèãÂ§±Ë¥•';
                    elements.addFriendError.classList.remove('hidden');
                    elements.addFriendSuccess.classList.add('hidden');
                    elements.searchResult.classList.add('hidden');
                    elements.confirmAddFriendBtn.classList.add('hidden');
                }
            });
            
            // Á°ÆËÆ§Ê∑ªÂä†Â•ΩÂèã
            elements.confirmAddFriendBtn.addEventListener('click', async function() {
                const account = elements.confirmAddFriendBtn.dataset.account;
                if (!account) return;
                
                try {
                    await addFriend(account);
                    
                    // ÊòæÁ§∫ÊàêÂäü‰ø°ÊÅØ
                    elements.addFriendSuccessText.textContent = 'Ê∑ªÂä†Â•ΩÂèãÊàêÂäü';
                    elements.addFriendSuccess.classList.remove('hidden');
                    elements.addFriendError.classList.add('hidden');
                    
                    // ÈáçÊñ∞Ëé∑ÂèñÂ•ΩÂèãÂàóË°®
                    fetchFriends();
                    
                    // 3ÁßíÂêéÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                    setTimeout(() => {
                        elements.addFriendModal.classList.add('hidden');
                    }, 3000);
                } catch (error) {
                    elements.addFriendErrorText.textContent = error.message || 'Ê∑ªÂä†Â•ΩÂèãÂ§±Ë¥•';
                    elements.addFriendError.classList.remove('hidden');
                    elements.addFriendSuccess.classList.add('hidden');
                }
            });
            

            
            // ÊêúÁ¥¢ËÅîÁ≥ª‰∫∫ÔºàÊú¨Âú∞ÊêúÁ¥¢Ôºâ
            elements.searchBtn.addEventListener('click', function() {
                const keyword = elements.searchInput.value.trim().toLowerCase();
                if (!keyword) {
                    // ÊòæÁ§∫ÊâÄÊúâËÅîÁ≥ª‰∫∫
                    renderFriendList(friends);
                    return;
                }
                
                // ËøáÊª§ËÅîÁ≥ª‰∫∫ÂàóË°®
                const filteredFriends = friends.filter(friend => {
                    return friend.nickname.toLowerCase().includes(keyword);
                });
                
                // Êõ¥Êñ∞ËÅîÁ≥ª‰∫∫ÂàóË°®
                renderFriendList(filteredFriends);
            });
            
            // ÊêúÁ¥¢Ê°ÜÂõûËΩ¶‰∫ã‰ª∂
            elements.searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    elements.searchBtn.click();
                }
            });
            
            // ÊêúÁ¥¢Ê°ÜÊ∏ÖÁ©∫‰∫ã‰ª∂
            elements.searchInput.addEventListener('input', function() {
                if (this.value.trim() === '') {
                    renderFriendList(friends);
                }
            });
            
            // Ê∏≤ÊüìÂ•ΩÂèãÂàóË°®
            function renderFriendList(friendsList) {
                // Ê∏ÖÁ©∫Â•ΩÂèãÂàóË°®
                elements.friendList.innerHTML = '';
                
                if (friendsList.length === 0) {
                    elements.friendList.innerHTML = '<div class="text-center text-gray-500 py-4">Êú™ÊâæÂà∞ÂåπÈÖçÁöÑËÅîÁ≥ª‰∫∫</div>';
                    return;
                }
                
                // Ê∏≤ÊüìÂ•ΩÂèãÂàóË°®
                friendsList.forEach(friend => {
                    const friendElement = document.createElement('div');
                    // Â¶ÇÊûúÊúâÊñ∞Ê∂àÊÅØÔºåÊ∑ªÂä†ÁâπÊÆäÊ†∑Âºè
                    const hasNewMessage = friend.has_new_message && friend.room_id !== currentRoomId;
                    friendElement.className = `p-3 hover:bg-white/60 rounded-xl cursor-pointer relative transition-all duration-200 mb-2 ${hasNewMessage ? 'bg-blue-50/80 border border-blue-200/60 shadow-sm' : 'hover:shadow-sm'}`;
                    friendElement.dataset.roomId = friend.room_id;
                    friendElement.dataset.type = friend.type;
                    
                    // Ê†πÊçÆÁ±ªÂûãÊòæÁ§∫‰∏çÂêåÁöÑÂõæÊ†á
                    const typeIcon = friend.type === 1 ? 
                        '<div class="w-2 h-2 bg-blue-400 rounded-full" title="ÁßÅËÅä"></div>' : 
                        '<div class="w-2 h-2 bg-green-400 rounded-full" title="Áæ§ËÅä"></div>';
                    
                    // Êñ∞Ê∂àÊÅØÊèêÁ§∫Ê†áËØÜ
                    const newMessageBadge = hasNewMessage && friend.new_message_count > 0 ? 
                        `<span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-medium shadow-sm">${friend.new_message_count > 99 ? '99+' : friend.new_message_count}</span>` : '';
                    
                    friendElement.innerHTML = `
                        <div class="flex items-center">
                            <div class="relative">
                                <img src="${friend.avatar || 'https://via.placeholder.com/40'}" alt="Â§¥ÂÉè" class="w-12 h-12 rounded-full ring-2 ring-white shadow-sm">
                                ${hasNewMessage ? '<div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></div>' : ''}
                            </div>
                            <div class="flex-1 ml-3 min-w-0">
                                <div class="flex items-center justify-between">
                                    <p class="font-medium text-gray-900 truncate ${hasNewMessage ? 'text-blue-700' : ''}">${friend.nickname}</p>
                                    <div class="flex items-center space-x-2">
                                        ${typeIcon}
                                    </div>
                                </div>
                                <div class="flex items-center text-sm text-gray-500 truncate mt-1 ${hasNewMessage ? 'text-blue-600 font-medium' : ''}">
                                    ${getMessageTypeIcon(friend.last_message_type || 'text')}
                                    <span class="ml-1 truncate">${friend.last_message || 'ÊöÇÊó†Ê∂àÊÅØ'}</span>
                                </div>
                            </div>
                        </div>
                        ${newMessageBadge}
                    `;
                    
                    // ÁÇπÂáªËÅîÁ≥ª‰∫∫ÊâìÂºÄËÅäÂ§©
                    friendElement.addEventListener('click', function() {
                        openChat(friend.room_id, friend);
                    });
                    
                    elements.friendList.appendChild(friendElement);
                });
            }
            
            // Ëé∑ÂèñÊ∂àÊÅØÁ±ªÂûãÂõæÊ†á
            function getMessageTypeIcon(messageType) {
                switch (messageType) {
                    case 'emoji':
                        return '<span class="text-yellow-500">üòä</span>';
                    case 'image':
                        return '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>';
                    case 'file':
                        return '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>';
                    case 'video':
                        return '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>';
                    case 'speech':
                        return '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>';
                    case 'text':
                    default:
                        return '';
                }
            }
            
            // ÂàùÂßãÂåñË°®ÊÉÖÈÄâÊã©Âô®
            function initEmojiPicker() {
                const emojiGrid = elements.emojiPicker.querySelector('.grid');
                emojiGrid.innerHTML = '';
                
                emojis.forEach(emoji => {
                    const emojiBtn = document.createElement('button');
                    emojiBtn.type = 'button';
                    emojiBtn.className = 'p-2 text-2xl hover:bg-gray-200 rounded transition-colors duration-200';
                    emojiBtn.textContent = emoji;
                    emojiBtn.addEventListener('click', function() {
                        // ÂèëÈÄÅË°®ÊÉÖÊ∂àÊÅØ
                        sendEmojiMessage(emoji);
                        // ÈöêËóèË°®ÊÉÖÈÄâÊã©Âô®
                        elements.emojiPicker.classList.add('hidden');
                    });
                    emojiGrid.appendChild(emojiBtn);
                });
            }
            
            // ÂèëÈÄÅË°®ÊÉÖÊ∂àÊÅØ
            function sendEmojiMessage(emoji) {
                if (!currentRoomId) {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©');
                    return;
                }
                
                const now = new Date();
                
                // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊ∑ªÂä†Êó•ÊúüÂàÜÈöîÁ∫ø
                const lastDateElements = elements.chatMessages.querySelectorAll('.date-separator');
                const lastDateStr = lastDateElements.length > 0 ? 
                    lastDateElements[lastDateElements.length - 1].textContent.trim() : null;
                const todayStr = now.getFullYear() + '/' + 
                                String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                                String(now.getDate()).padStart(2, '0');
                
                if (!lastDateStr || todayStr !== lastDateStr) {
                    addDateSeparator(now);
                }
                
                // ÊûÑÂª∫Ë°®ÊÉÖÊ∂àÊÅØÂØπË±°
                const messageObj = {
                    user_id: currentUser.user_id,
                    room_id: currentRoomId,
                    data: emoji,
                    type: 'emoji', // ËÆæÁΩÆÊ∂àÊÅØÁ±ªÂûã‰∏∫Ë°®ÊÉÖ
                    created_at: now.toISOString()
                };
                
                // ÂèëÈÄÅÊ∂àÊÅØ
                socket.send(JSON.stringify(messageObj));
                
                // Ê∑ªÂä†Ê∂àÊÅØÂà∞ÂΩìÂâçÊ∂àÊÅØÂàóË°®
                currentRoomMessages.push(messageObj);
            }
            
            // ÂèëÈÄÅÂõæÁâáÊ∂àÊÅØ
            function sendImageMessage(file) {
                if (!currentRoomId) {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©');
                    return;
                }
                
                // ÂàõÂª∫Êñá‰ª∂ËØªÂèñÂô®
                const reader = new FileReader();
                reader.onload = function(e) {
                    const now = new Date();
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊ∑ªÂä†Êó•ÊúüÂàÜÈöîÁ∫ø
                    const lastDateElements = elements.chatMessages.querySelectorAll('.date-separator');
                    const lastDateStr = lastDateElements.length > 0 ? 
                        lastDateElements[lastDateElements.length - 1].textContent.trim() : null;
                    const todayStr = now.getFullYear() + '/' + 
                                    String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                                    String(now.getDate()).padStart(2, '0');
                    
                    if (!lastDateStr || todayStr !== lastDateStr) {
                        addDateSeparator(now);
                    }
                    
                    // ÊûÑÂª∫ÂõæÁâáÊ∂àÊÅØÂØπË±°
                    const messageObj = {
                        user_id: currentUser.user_id,
                        room_id: currentRoomId,
                        data: e.target.result, // base64ÁºñÁ†ÅÁöÑÂõæÁâáÊï∞ÊçÆ
                        type: 'image',
                        file_name: file.name,
                        file_size: file.size,
                        created_at: now.toISOString()
                    };
                    
                    // ÂèëÈÄÅÊ∂àÊÅØ
                    socket.send(JSON.stringify(messageObj));
                    
                    // Ê∑ªÂä†Ê∂àÊÅØÂà∞ÂΩìÂâçÊ∂àÊÅØÂàóË°®
                    currentRoomMessages.push(messageObj);
                };
                
                reader.readAsDataURL(file);
            }
            
            // ÂèëÈÄÅÊñá‰ª∂Ê∂àÊÅØ
            function sendFileMessage(file) {
                if (!currentRoomId) {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©');
                    return;
                }
                
                // ÂàõÂª∫Êñá‰ª∂ËØªÂèñÂô®
                const reader = new FileReader();
                reader.onload = function(e) {
                    const now = new Date();
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊ∑ªÂä†Êó•ÊúüÂàÜÈöîÁ∫ø
                    const lastDateElements = elements.chatMessages.querySelectorAll('.date-separator');
                    const lastDateStr = lastDateElements.length > 0 ? 
                        lastDateElements[lastDateElements.length - 1].textContent.trim() : null;
                    const todayStr = now.getFullYear() + '/' + 
                                    String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                                    String(now.getDate()).padStart(2, '0');
                    
                    if (!lastDateStr || todayStr !== lastDateStr) {
                        addDateSeparator(now);
                    }
                    
                    // ÊûÑÂª∫Êñá‰ª∂Ê∂àÊÅØÂØπË±°
                    const messageObj = {
                        user_id: currentUser.user_id,
                        room_id: currentRoomId,
                        data: e.target.result, // base64ÁºñÁ†ÅÁöÑÊñá‰ª∂Êï∞ÊçÆ
                        type: 'file',
                        file_name: file.name,
                        file_size: file.size,
                        created_at: now.toISOString()
                    };
                    
                    // ÂèëÈÄÅÊ∂àÊÅØ
                    socket.send(JSON.stringify(messageObj));
                    
                    // Ê∑ªÂä†Ê∂àÊÅØÂà∞ÂΩìÂâçÊ∂àÊÅØÂàóË°®
                    currentRoomMessages.push(messageObj);
                };
                
                reader.readAsDataURL(file);
            }
            
            // Ë°®ÊÉÖÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            elements.emojiBtn.addEventListener('click', function() {
                elements.emojiPicker.classList.toggle('hidden');
            });
            
            // ÂõæÁâáÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            elements.imageBtn.addEventListener('click', function() {
                elements.imageInput.click();
            });
            
            // Êñá‰ª∂ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            elements.fileBtn.addEventListener('click', function() {
                elements.fileInput.click();
            });
            
            // ÂõæÁâáÊñá‰ª∂ÈÄâÊã©‰∫ã‰ª∂
            elements.imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÔºàÈôêÂà∂‰∏∫5MBÔºâ
                    if (file.size > 5 * 1024 * 1024) {
                        alert('ÂõæÁâáÊñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá5MB');
                        return;
                    }
                    sendImageMessage(file);
                }
                // Ê∏ÖÁ©∫Êñá‰ª∂ÈÄâÊã©Âô®
                e.target.value = '';
            });
            
            // Êñá‰ª∂ÈÄâÊã©‰∫ã‰ª∂
            elements.fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÔºàÈôêÂà∂‰∏∫10MBÔºâ
                    if (file.size > 10 * 1024 * 1024) {
                        alert('Êñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá10MB');
                        return;
                    }
                    sendFileMessage(file);
                }
                // Ê∏ÖÁ©∫Êñá‰ª∂ÈÄâÊã©Âô®
                e.target.value = '';
            });
            
            // ÂõûËΩ¶ÈîÆÂèëÈÄÅÊ∂àÊÅØ
            elements.messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    elements.messageForm.dispatchEvent(new Event('submit'));
                }
            });
            
            // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÈöêËóèË°®ÊÉÖÈÄâÊã©Âô®
            document.addEventListener('click', function(e) {
                if (!elements.emojiBtn.contains(e.target) && !elements.emojiPicker.contains(e.target)) {
                    elements.emojiPicker.classList.add('hidden');
                }
            });
            
            // ÂàùÂßãÂåñ
            initEmojiPicker();
            fetchCurrentUser();
        });
    </script>
    
    <!-- Áî®Êà∑‰∏≠ÂøÉÊªëÂÖ•Á™óÂè£ -->
    <div id="user-center-modal" class="fixed inset-0 z-50 hidden">
        <!-- ËÉåÊôØÈÅÆÁΩ© -->
        <div id="user-center-backdrop" class="absolute inset-0 bg-black/30 backdrop-blur-sm"></div>
        <!-- ÊªëÂÖ•Á™óÂè£ -->
        <div id="user-center-panel" class="absolute right-0 top-0 h-full w-96 bg-white/95 backdrop-blur-md shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out border-l border-gray-200/50">
            <!-- Â§¥ÈÉ® -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200/60 bg-gradient-to-r from-gray-50/80 to-white/80">
                <h3 class="text-xl font-semibold text-gray-900">Áî®Êà∑‰∏≠ÂøÉ</h3>
                <button id="close-user-center-btn" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100/80 p-2 rounded-xl transition-all duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- ÂÜÖÂÆπÂå∫Âüü -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Áî®Êà∑Â§¥ÂÉè -->
                <div class="text-center mb-8">
                    <div class="relative inline-block">
                        <img id="profile-avatar" src="" alt="Â§¥ÂÉè" class="w-24 h-24 rounded-full mx-auto mb-3 ring-4 ring-white shadow-lg">
                        <div class="absolute inset-0 rounded-full bg-black/10 opacity-0 hover:opacity-100 transition-opacity duration-200 flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <button id="change-avatar-btn" class="text-sm text-gray-600 hover:text-gray-800 font-medium transition-colors duration-200">Êõ¥Êç¢Â§¥ÂÉè</button>
                </div>
                
                <!-- Áî®Êà∑‰ø°ÊÅØÊòæÁ§∫/ÁºñËæëÂå∫Âüü -->
                <div class="space-y-6">
                    <!-- Âè™ËØªÊòæÁ§∫Ê®°Âºè -->
                    <div id="profile-view-mode">
                        <div class="mb-5">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÊòµÁß∞</label>
                            <div id="profile-nickname-display" class="w-full px-4 py-3 border border-gray-200/60 rounded-xl bg-gray-50/80 text-gray-800"></div>
                        </div>
                        
                        <div class="mb-5">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ë¥¶Âè∑</label>
                            <div id="profile-account-display" class="w-full px-4 py-3 border border-gray-200/60 rounded-xl bg-gray-50/80 text-gray-800"></div>
                        </div>
                        
                        <div class="mb-8">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÈÇÆÁÆ±</label>
                            <div id="profile-email-display" class="w-full px-4 py-3 border border-gray-200/60 rounded-xl bg-gray-50/80 text-gray-800"></div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button type="button" id="edit-profile-btn" class="flex-1 bg-gray-900 text-white py-3 px-4 rounded-xl hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-all duration-200 font-medium shadow-sm hover:shadow-md">
                                ÁºñËæëËµÑÊñô
                            </button>
                            <button type="button" id="change-password-btn" class="flex-1 bg-gray-100 text-gray-700 py-3 px-4 rounded-xl hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300 transition-all duration-200 font-medium border border-gray-200/60">
                                ‰øÆÊîπÂØÜÁ†Å
                            </button>
                        </div>
                    </div>
                    
                    <!-- ÁºñËæëÊ®°Âºè -->
                    <form id="profile-form" class="space-y-5 hidden">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÊòµÁß∞</label>
                            <input type="text" id="profile-nickname" class="w-full px-4 py-3 border border-gray-200/60 rounded-xl focus:outline-none focus:ring-2 focus:ring-gray-400 focus:border-gray-400 transition-all duration-200">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ë¥¶Âè∑</label>
                            <input type="text" id="profile-account" class="w-full px-4 py-3 border border-gray-200/60 rounded-xl bg-gray-50/80 text-gray-600" readonly>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÈÇÆÁÆ±</label>
                            <input type="email" id="profile-email" class="w-full px-4 py-3 border border-gray-200/60 rounded-xl bg-gray-50/80 text-gray-600" readonly>
                        </div>
                        
                        <div class="flex space-x-3 pt-4">
                            <button type="submit" class="flex-1 bg-gray-900 text-white py-3 px-4 rounded-xl hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-all duration-200 font-medium shadow-sm hover:shadow-md">
                                ‰øùÂ≠ò‰øÆÊîπ
                            </button>
                            <button type="button" id="cancel-edit-btn" class="flex-1 bg-gray-100 text-gray-700 py-3 px-4 rounded-xl hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300 transition-all duration-200 font-medium border border-gray-200/60">
                                ÂèñÊ∂à
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- ÈÄÄÂá∫ÁôªÂΩïÊåâÈíÆ -->
                <div class="mt-8 pt-6 border-t border-gray-200/60">
                    <button id="logout-btn" class="w-full bg-red-500 text-white py-3 px-4 rounded-xl hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 transition-all duration-200 font-medium shadow-sm hover:shadow-md">
                        ÈÄÄÂá∫ÁôªÂΩï
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Êü•ÁúãËµÑÊñôÊªëÂÖ•Á™óÂè£ -->
    <div id="profile-modal" class="fixed inset-0 z-50 hidden">
        <!-- ËÉåÊôØÈÅÆÁΩ© -->
        <div id="profile-backdrop" class="absolute inset-0 bg-black/30 backdrop-blur-sm"></div>
        <!-- ÊªëÂÖ•Á™óÂè£ -->
        <div id="profile-panel" class="absolute right-0 top-0 h-full w-96 bg-white/95 backdrop-blur-md shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out border-l border-gray-200/50">
            <!-- Â§¥ÈÉ® -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200/60 bg-gradient-to-r from-gray-50/80 to-white/80">
                <h3 class="text-xl font-semibold text-gray-900">Áî®Êà∑ËµÑÊñô</h3>
                <button id="close-profile-btn" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100/80 p-2 rounded-xl transition-all duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- ÂÜÖÂÆπÂå∫Âüü -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Áî®Êà∑Â§¥ÂÉè -->
                <div class="text-center mb-8">
                    <img id="friend-profile-avatar" src="" alt="Â§¥ÂÉè" class="w-24 h-24 rounded-full mx-auto ring-4 ring-white shadow-lg">
                </div>
                
                <!-- Áî®Êà∑‰ø°ÊÅØÊòæÁ§∫ -->
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÊòµÁß∞</label>
                        <div id="friend-profile-nickname" class="w-full px-4 py-3 border border-gray-200/60 rounded-xl bg-gray-50/80 text-gray-800"></div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ë¥¶Âè∑</label>
                        <div id="friend-profile-account" class="w-full px-4 py-3 border border-gray-200/60 rounded-xl bg-gray-50/80 text-gray-800"></div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÈÇÆÁÆ±</label>
                        <div id="friend-profile-email" class="w-full px-4 py-3 border border-gray-200/60 rounded-xl bg-gray-50/80 text-gray-800"></div>
                    </div>
                    
                    <!-- Âà†Èô§Â•ΩÂèãÊåâÈíÆ -->
                    <div class="mt-8 pt-6 border-t border-gray-200/60">
                        <button id="delete-friend-btn" class="w-full bg-red-500 text-white py-3 px-4 rounded-xl hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 transition-all duration-200 font-medium shadow-sm hover:shadow-md">
                            Âà†Èô§Â•ΩÂèã
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>