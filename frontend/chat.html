<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËÅäÂ§© - IMÂç≥Êó∂ÈÄöËÆØÁ≥ªÁªü</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
    <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
    <header class="bg-indigo-600 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">IMÂç≥Êó∂ÈÄöËÆØÁ≥ªÁªü</h1>
            <div class="flex items-center space-x-4">
                <span id="user-nickname" class="text-sm">Âä†ËΩΩ‰∏≠...</span>
                <img id="user-avatar" src="https://avatars.githubusercontent.com/u/148515933?s=400&u=7cbff7c77a33416cabfe463fff24495157026760&v=4" alt="Â§¥ÂÉè" class="w-8 h-8 rounded-full">
                <button id="logout-btn" class="text-sm bg-indigo-700 hover:bg-indigo-800 px-3 py-1 rounded">
                    ÈÄÄÂá∫ÁôªÂΩï
                </button>
            </div>
        </div>
    </header>

    <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
    <div class="flex-1 flex overflow-hidden">
        <!-- Â∑¶‰æßËÅîÁ≥ª‰∫∫ÂàóË°® -->
        <div class="w-1/4 bg-white border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b border-gray-200">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="ÊêúÁ¥¢ËÅîÁ≥ª‰∫∫" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="search-btn" class="absolute right-2 top-2 text-gray-500 hover:text-indigo-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-2" id="friend-list">
                <!-- ËÅîÁ≥ª‰∫∫ÂàóË°®Â∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
                <div class="text-center text-gray-500 py-4">Âä†ËΩΩËÅîÁ≥ª‰∫∫ÂàóË°®‰∏≠...</div>
            </div>
            
            <div class="p-4 border-t border-gray-200">
                <button id="add-friend-btn" class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Ê∑ªÂä†ËÅîÁ≥ª‰∫∫
                </button>
            </div>
        </div>
        
        <!-- Âè≥‰æßËÅäÂ§©Âå∫Âüü -->
        <div class="flex-1 flex flex-col">
            <!-- ËÅäÂ§©Â§¥ÈÉ® -->
            <div class="p-4 border-b border-gray-200 bg-white shadow-sm flex justify-between items-center">
                <h2 id="chat-title" class="text-lg font-medium">ËØ∑ÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©</h2>
                <div id="chat-actions" class="hidden">
                    <button id="delete-friend-btn" class="text-sm text-red-600 hover:text-red-800">
                        Âà†Èô§Â•ΩÂèã
                    </button>
                </div>
            </div>
            
            <!-- ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 bg-gray-50">
                <div class="flex items-center justify-center h-full">
                    <p class="text-gray-500">ÈÄâÊã©‰∏Ä‰∏™ËÅîÁ≥ª‰∫∫ÂºÄÂßãËÅäÂ§©</p>
                </div>
            </div>
            
            <!-- ËÅäÂ§©ËæìÂÖ•Âå∫Âüü -->
            <div id="chat-input-area" class="p-4 border-t border-gray-200 bg-white hidden">
                <!-- Ë°®ÊÉÖÈÄâÊã©Âô® -->
                <div id="emoji-picker" class="hidden absolute bottom-20 left-4 w-80 p-4 border border-gray-200 rounded-lg bg-white shadow-lg max-h-48 overflow-y-auto z-10">
                    <div class="grid grid-cols-8 gap-2">
                        <!-- Ë°®ÊÉÖÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
                
                <!-- Êñá‰ª∂ÈÄâÊã©Âô® -->
                <input type="file" id="file-input" class="hidden" accept="*/*">
                <input type="file" id="image-input" class="hidden" accept="image/*">
                
                <div class="relative h-20">
                    <!-- Â∑¶‰æßÂäüËÉΩÊåâÈíÆ -->
                    <div class="absolute left-0 top-0 flex flex-col justify-center h-full space-y-1">
                        <button type="button" id="emoji-btn" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-indigo-500 hover:bg-gray-100 rounded-lg transition-colors">
                            üòä
                        </button>
                        <button type="button" id="image-btn" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-indigo-500 hover:bg-gray-100 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </button>
                        <button type="button" id="file-btn" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-indigo-500 hover:bg-gray-100 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                            </svg>
                        </button>
                    </div>
                    
                    <!-- ‰∏ªËæìÂÖ•Âå∫Âüü -->
                    <form id="message-form" class="h-full">
                        <div class="ml-12 mr-16 h-full relative">
                            <textarea id="message-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." class="w-full h-full resize-none border-none outline-none bg-gray-50 rounded-lg px-4 py-3 text-sm" rows="3"></textarea>
                        </div>
                        
                        <!-- ÂèëÈÄÅÊåâÈíÆ -->
                        <button type="submit" class="absolute bottom-2 right-2 w-12 h-8 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg flex items-center justify-center transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Ê∑ªÂä†Â•ΩÂèãÊ®°ÊÄÅÊ°Ü -->
    <div id="add-friend-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Ê∑ªÂä†Â•ΩÂèã</h3>
                <button id="close-add-friend-modal" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div id="add-friend-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4">
                <span id="add-friend-error-text"></span>
            </div>
            
            <div id="add-friend-success" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4">
                <span id="add-friend-success-text"></span>
            </div>
            
            <form id="add-friend-form">
                <div class="mb-4">
                    <label for="friend-account" class="block text-sm font-medium text-gray-700 mb-1">Â•ΩÂèãË¥¶Âè∑</label>
                    <input type="text" id="friend-account" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div id="search-result" class="mb-4 hidden">
                    <div class="p-3 border border-gray-200 rounded-md">
                        <div class="flex items-center">
                            <img id="result-avatar" src="https://via.placeholder.com/40" alt="Â§¥ÂÉè" class="w-10 h-10 rounded-full mr-3">
                            <div>
                                <p id="result-nickname" class="font-medium"></p>
                                <p id="result-account" class="text-sm text-gray-500"></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="search-friend-btn" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        ÊêúÁ¥¢
                    </button>
                    <button type="button" id="confirm-add-friend-btn" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 hidden">
                        Ê∑ªÂä†
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁôªÂΩï
            const token = localStorage.getItem('token');
            if (!token) {
                // Êú™ÁôªÂΩïÔºåË∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢
                window.location.href = 'login.html';
                return;
            }
            
            // ÂÖ®Â±ÄÂèòÈáè
            let currentUser = null;
            let currentRoomId = null;
            let currentChatUser = null;
            let socket = null;
            let friends = [];
            
            // DOMÂÖÉÁ¥†
            const userNickname = document.getElementById('user-nickname');
            const userAvatar = document.getElementById('user-avatar');
            const logoutBtn = document.getElementById('logout-btn');
            const friendList = document.getElementById('friend-list');
            const chatTitle = document.getElementById('chat-title');
            const chatMessages = document.getElementById('chat-messages');
            const chatInputArea = document.getElementById('chat-input-area');
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-input');
            const addFriendBtn = document.getElementById('add-friend-btn');
            const addFriendModal = document.getElementById('add-friend-modal');
            const closeAddFriendModal = document.getElementById('close-add-friend-modal');
            const addFriendForm = document.getElementById('add-friend-form');
            const friendAccount = document.getElementById('friend-account');
            const searchFriendBtn = document.getElementById('search-friend-btn');
            const searchResult = document.getElementById('search-result');
            const resultAvatar = document.getElementById('result-avatar');
            const resultNickname = document.getElementById('result-nickname');
            const resultAccount = document.getElementById('result-account');
            const confirmAddFriendBtn = document.getElementById('confirm-add-friend-btn');
            const addFriendError = document.getElementById('add-friend-error');
            const addFriendErrorText = document.getElementById('add-friend-error-text');
            const addFriendSuccess = document.getElementById('add-friend-success');
            const addFriendSuccessText = document.getElementById('add-friend-success-text');
            const chatActions = document.getElementById('chat-actions');
            const deleteFriendBtn = document.getElementById('delete-friend-btn');
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            const emojiBtn = document.getElementById('emoji-btn');
            const emojiPicker = document.getElementById('emoji-picker');
            const imageBtn = document.getElementById('image-btn');
            const fileBtn = document.getElementById('file-btn');
            const imageInput = document.getElementById('image-input');
            const fileInput = document.getElementById('file-input');
            
            // Ë°®ÊÉÖÊï∞ÊçÆ
            const emojis = [
                'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£',
                'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞',
                'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòù', 'üòú',
                'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©', 'ü•≥', 'üòè',
                'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£',
                'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†',
                'üò°', 'ü§¨', 'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®',
                'üò∞', 'üò•', 'üòì', 'ü§ó', 'ü§î', 'ü§≠', 'ü§´', 'ü§•',
                'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ', 'üò¶', 'üòß',
                'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê',
                'ü•¥', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë',
                'ü§†', 'üòà', 'üëø', 'üëπ', 'üë∫', 'ü§°', 'üí©', 'üëª',
                'üíÄ', '‚ò†Ô∏è', 'üëΩ', 'üëæ', 'ü§ñ', 'üéÉ', 'üò∫', 'üò∏',
                'üòπ', 'üòª', 'üòº', 'üòΩ', 'üôÄ', 'üòø', 'üòæ', '‚ù§Ô∏è',
                'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é',
                'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò',
                'üíù', 'üíü', 'üëç', 'üëé', 'üëå', 'ü§è', '‚úåÔ∏è', 'ü§û',
                'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üñï', 'üëá',
                '‚òùÔ∏è', 'üëã', 'ü§ö', 'üñêÔ∏è', '‚úã', 'üññ', 'üëè', 'üôå'
            ];
            
            // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑‰ø°ÊÅØ
            async function fetchCurrentUser() {
                try {
                    const response = await fetch('/user/detail', {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // ÊàêÂäüÁä∂ÊÄÅÁ†Å
                        currentUser = data.data;
                        userNickname.textContent = currentUser.nickname || currentUser.account;
                        if (currentUser.avatar) {
                            userAvatar.src = currentUser.avatar;
                        }
                        
                        // Ëé∑ÂèñÂ•ΩÂèãÂàóË°®
                        fetchFriends();
                        
                        // Âª∫Á´ãWebSocketËøûÊé•
                        connectWebSocket();
                    } else {
                        // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•ÔºåÂèØËÉΩÊòØtokenËøáÊúü
                        localStorage.removeItem('token');
                        window.location.href = 'login.html';
                    }
                } catch (error) {
                    console.error('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂá∫Èîô:', error);
                    alert('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
                }
            }
            
            // Ëé∑ÂèñÂ•ΩÂèãÂàóË°®
            async function fetchFriends() {
                try {
                    // Ë∞ÉÁî®ÂêéÁ´ØAPIËé∑ÂèñËÅîÁ≥ª‰∫∫ÂàóË°®
                    const response = await fetch('/user/chatlist', {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    // Ê∏ÖÁ©∫Â•ΩÂèãÂàóË°®
                    friendList.innerHTML = '';
                    
                    if (data.code === 111) { // ÊàêÂäüÁä∂ÊÄÅÁ†Å
                        const chatlist = data.data.chatlist;
                        
                        // Â§ÑÁêÜËÅîÁ≥ª‰∫∫ÂàóË°®Êï∞ÊçÆ
                        friends = chatlist.map(contact => {
                            return {
                                nickname: contact.name,
                                room_id: contact.room_id,
                                type: contact.type, // 1ÁßÅËÅä 2Áæ§ËÅä
                                last_message: '',
                                last_message_type: 'text', // ÊúÄÊñ∞Ê∂àÊÅØÁ±ªÂûã
                                avatar: 'https://avatars.githubusercontent.com/u/148515933?s=400&u=7cbff7c77a33416cabfe463fff24495157026760&v=4', // ÈªòËÆ§Â§¥ÂÉè
                                has_new_message: false, // ÊòØÂê¶ÊúâÊñ∞Ê∂àÊÅØ
                                new_message_count: 0 // Êñ∞Ê∂àÊÅØÊï∞Èáè
                            };
                        });
                        
                        // Ê∏≤ÊüìÂ•ΩÂèãÂàóË°®
                        renderFriendList(friends);
                    } else {
                        console.error('Ëé∑ÂèñËÅîÁ≥ª‰∫∫ÂàóË°®Â§±Ë¥•:', data.msg);
                        friendList.innerHTML = '<div class="text-center text-gray-500 py-4">Ëé∑ÂèñËÅîÁ≥ª‰∫∫ÂàóË°®Â§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï</div>';
                    }
                } catch (error) {
                    console.error('Ëé∑ÂèñËÅîÁ≥ª‰∫∫ÂàóË°®Âá∫Èîô:', error);
                    friendList.innerHTML = '<div class="text-center text-gray-500 py-4">ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï</div>';
                }
                
                // Â¶ÇÊûúÂ•ΩÂèãÂàóË°®‰∏∫Á©∫ÔºåÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
                if (friends.length === 0) {
                    friendList.innerHTML = '<div class="text-center text-gray-500 py-4">ÊöÇÊó†ËÅîÁ≥ª‰∫∫ÔºåËØ∑Ê∑ªÂä†Â•ΩÂèã</div>';
                }
            }
            
            // Âª∫Á´ãWebSocketËøûÊé•
            function connectWebSocket() {
                // ÊûÑÂª∫WebSocket URLÔºåÊåáÂêëÂêéÁ´ØÊúçÂä°
                // Ëé∑ÂèñÂΩìÂâçÂüüÂêçÂíåÁ´ØÂè£
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.host;
                const wsUrl = `${protocol}//${host}/user/msg?token=${token}`;
                
                // ÂàõÂª∫WebSocketËøûÊé•
                socket = new WebSocket(wsUrl);
                
                // ËøûÊé•ÊâìÂºÄ‰∫ã‰ª∂
                socket.onopen = function(e) {
                    console.log('WebSocketËøûÊé•Â∑≤Âª∫Á´ã');
                };
                
                // Êé•Êî∂Ê∂àÊÅØ‰∫ã‰ª∂
                socket.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    console.log('Êî∂Âà∞Ê∂àÊÅØ:', message);
                    
                    // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®Êü•ÁúãÁöÑËÅäÂ§©ÂÆ§‰∏éÊ∂àÊÅØÁöÑËÅäÂ§©ÂÆ§Áõ∏ÂêåÔºåÂàôÊòæÁ§∫Ê∂àÊÅØ
                    if (currentRoomId === message.room_id) {
                        // Ê£ÄÊü•Êó•ÊúüÊòØÂê¶ÈúÄË¶ÅÊ∑ªÂä†ÂàÜÈöîÁ∫ø
                        const messageDate = new Date(message.created_at);
                        const messageDateStr = messageDate.toDateString();
                        
                        // Ëé∑ÂèñÊúÄÂêé‰∏Ä‰∏™Êó•ÊúüÂàÜÈöîÁ∫øÊàñÊ∂àÊÅØÁöÑÊó•Êúü
                        let lastDateStr = null;
                        const dateElements = chatMessages.querySelectorAll('.date-separator');
                        if (dateElements.length > 0) {
                            const lastDateElement = dateElements[dateElements.length - 1];
                            lastDateStr = lastDateElement.getAttribute('data-date');
                        }
                        
                        // Â¶ÇÊûúÊó•Êúü‰∏çÂêåÔºåÊ∑ªÂä†Êñ∞ÁöÑÊó•ÊúüÂàÜÈöîÁ∫ø
                        if (!lastDateStr || messageDateStr !== lastDateStr) {
                            addDateSeparator(messageDate);
                        }
                        
                        // Ê∑ªÂä†Ê∂àÊÅØÂà∞UI
                        appendMessage(message);
                        
                        // Ê∑ªÂä†Ê∂àÊÅØÂà∞ÂΩìÂâçÊ∂àÊÅØÂàóË°®
                        currentRoomMessages.push(message);
                        
                        // ÊªöÂä®Âà∞Â∫ïÈÉ®
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                    
                    // Êõ¥Êñ∞Â•ΩÂèãÂàóË°®‰∏≠ÁöÑÊúÄÊñ∞Ê∂àÊÅØ
                    updateFriendLastMessage(message);
                };
                
                // ËøûÊé•ÂÖ≥Èó≠‰∫ã‰ª∂
                socket.onclose = function(event) {
                    console.log('WebSocketËøûÊé•Â∑≤ÂÖ≥Èó≠');
                    // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ÈáçËøûÈÄªËæë
                };
                
                // ËøûÊé•ÈîôËØØ‰∫ã‰ª∂
                socket.onerror = function(error) {
                    console.error('WebSocketÈîôËØØ:', error);
                };
            }
            
            // Êõ¥Êñ∞Â•ΩÂèãÂàóË°®‰∏≠ÁöÑÊúÄÊñ∞Ê∂àÊÅØ
            function updateFriendLastMessage(message) {
                // Êü•ÊâæÂØπÂ∫îÁöÑÂ•ΩÂèã
                const friendIndex = friends.findIndex(f => f.room_id === message.room_id);
                if (friendIndex !== -1) {
                    // Ê†πÊçÆÊ∂àÊÅØÁ±ªÂûãËÆæÁΩÆÊòæÁ§∫ÂÜÖÂÆπ
                    let displayMessage = '';
                    const messageType = message.type || 'text';
                    
                    switch (messageType) {
                        case 'emoji':
                            displayMessage = message.data || message.message;
                            break;
                        case 'image':
                            displayMessage = '[ÂõæÁâá]';
                            break;
                        case 'file':
                            displayMessage = '[Êñá‰ª∂]';
                            break;
                        case 'video':
                            displayMessage = '[ËßÜÈ¢ë]';
                            break;
                        case 'speech':
                            displayMessage = '[ËØ≠Èü≥]';
                            break;
                        case 'text':
                        default:
                            displayMessage = message.data || message.message;
                            break;
                    }
                    
                    // Êõ¥Êñ∞ÊúÄÊñ∞Ê∂àÊÅØ
                    friends[friendIndex].last_message = displayMessage;
                    friends[friendIndex].last_message_type = messageType;
                    
                    // Â¶ÇÊûú‰∏çÊòØÂΩìÂâçËÅäÂ§©ÂÆ§ÁöÑÊ∂àÊÅØÔºåÊ†áËÆ∞‰∏∫ÊúâÊñ∞Ê∂àÊÅØ
                    if (message.room_id !== currentRoomId) {
                        friends[friendIndex].has_new_message = true;
                        friends[friendIndex].new_message_count = (friends[friendIndex].new_message_count || 0) + 1;
                    }
                    
                    // ÈáçÊñ∞Ê∏≤ÊüìÂ•ΩÂèãÂàóË°®
                    renderFriendList(friends);
                }
            }
            
            // Ê∑ªÂä†Êó•ÊúüÂàÜÈöîÁ∫ø
            function addDateSeparator(date) {
                const dateStr = date.getFullYear() + '/' + 
                               String(date.getMonth() + 1).padStart(2, '0') + '/' + 
                               String(date.getDate()).padStart(2, '0');
                
                const separatorElement = document.createElement('div');
                separatorElement.className = 'flex justify-center my-4 date-separator';
                separatorElement.setAttribute('data-date', date.toDateString());
                separatorElement.innerHTML = `
                    <div class="px-4 py-1 bg-gray-100 rounded-full text-xs text-gray-500">
                        ${dateStr}
                    </div>
                `;
                
                chatMessages.appendChild(separatorElement);
            }
            
            // ËÅäÂ§©ËÆ∞ÂΩïÂàÜÈ°µÂèòÈáè
            let currentPage = 1;
            let isLoadingMessages = false;
            let hasMoreMessages = true;
            let currentRoomMessages = [];
            
            // Âä†ËΩΩËÅäÂ§©ËÆ∞ÂΩï
            async function loadChatMessages(roomId, page = 1, pageSize = 20, append = false) {
                try {
                    // Â¶ÇÊûúÊ≠£Âú®Âä†ËΩΩÊàñÊ≤°ÊúâÊõ¥Â§öÊ∂àÊÅØÔºåÂàôËøîÂõû
                    if (isLoadingMessages || (page > 1 && !hasMoreMessages)) {
                        return;
                    }
                    
                    isLoadingMessages = true;
                    
                    // Â¶ÇÊûúÊòØÂä†ËΩΩÁ¨¨‰∏ÄÈ°µÔºåÈáçÁΩÆÂàÜÈ°µÂèòÈáè
                    if (page === 1 && !append) {
                        currentPage = 1;
                        hasMoreMessages = true;
                        currentRoomMessages = [];
                    }
                    
                    // ÊòæÁ§∫Âä†ËΩΩÊåáÁ§∫Âô®
                    if (page > 1) {
                        const loadingIndicator = document.createElement('div');
                        loadingIndicator.id = 'loading-indicator';
                        loadingIndicator.className = 'flex justify-center my-4';
                        loadingIndicator.innerHTML = `
                            <div class="px-4 py-1 bg-gray-100 rounded-full text-xs text-gray-500 flex items-center">
                                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Âä†ËΩΩÊõ¥Â§öÊ∂àÊÅØ...
                            </div>
                        `;
                        chatMessages.insertBefore(loadingIndicator, chatMessages.firstChild);
                    }
                    
                    const response = await fetch(`/user/history?room_id=${roomId}&page_index=${page}&page_size=${pageSize}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    // ÁßªÈô§Âä†ËΩΩÊåáÁ§∫Âô®
                    const loadingIndicator = document.getElementById('loading-indicator');
                    if (loadingIndicator) {
                        loadingIndicator.remove();
                    }
                    
                    if (data.code === 111) { // ÊàêÂäüÁä∂ÊÄÅÁ†Å
                        // ÊòæÁ§∫ËÅäÂ§©ËÆ∞ÂΩï
                        const messages = data.data.list;
                        
                        // Â¶ÇÊûúÊ≤°ÊúâÊ∂àÊÅØÔºå‰∏îÊòØÁ¨¨‰∏ÄÈ°µÔºåÊòæÁ§∫ÊöÇÊó†ËÅäÂ§©ËÆ∞ÂΩï
                        if (messages.length === 0 && page === 1 && !append) {
                            chatMessages.innerHTML = '<div class="flex justify-center my-4"><p class="text-gray-500">ÊöÇÊó†ËÅäÂ§©ËÆ∞ÂΩï</p></div>';
                            hasMoreMessages = false;
                        } else if (messages.length === 0) {
                            // Â¶ÇÊûúÊòØÂÖ∂‰ªñÈ°µ‰∏îÊ≤°ÊúâÊ∂àÊÅØÔºåËØ¥ÊòéÊ≤°ÊúâÊõ¥Â§öÊ∂àÊÅØ‰∫Ü
                            hasMoreMessages = false;
                            
                            // Ê∑ªÂä†Ê≤°ÊúâÊõ¥Â§öÊ∂àÊÅØÁöÑÊèêÁ§∫
                            const noMoreMessagesIndicator = document.createElement('div');
                            noMoreMessagesIndicator.className = 'flex justify-center my-4';
                            noMoreMessagesIndicator.innerHTML = `
                                <div class="px-4 py-1 bg-gray-100 rounded-full text-xs text-gray-500">
                                    Ê≤°ÊúâÊõ¥Â§öÊ∂àÊÅØ‰∫Ü
                                </div>
                            `;
                            chatMessages.insertBefore(noMoreMessagesIndicator, chatMessages.firstChild);
                        } else {
                            // ÊåâÊó∂Èó¥È°∫Â∫èÊòæÁ§∫Ê∂àÊÅØ
                            messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                            
                            // ‰øùÂ≠òÂΩìÂâçÊªöÂä®‰ΩçÁΩÆÂíåÈ´òÂ∫¶
                            const scrollPos = chatMessages.scrollTop;
                            const oldHeight = chatMessages.scrollHeight;
                            
                            // ÂêàÂπ∂Ê∂àÊÅØÂà∞ÂΩìÂâçÊàøÈó¥Ê∂àÊÅØÂàóË°®
                            if (page === 1 && !append) {
                                // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÈ°µ‰∏î‰∏çÊòØËøΩÂä†Ê®°ÂºèÔºåÊ∏ÖÁ©∫ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü
                                chatMessages.innerHTML = '';
                                currentRoomMessages = messages;
                            } else {
                                // Â∞ÜÊñ∞Ê∂àÊÅØÊ∑ªÂä†Âà∞Êï∞ÁªÑÂºÄÂ§¥
                                currentRoomMessages = [...messages, ...currentRoomMessages];
                            }
                            
                            // ÈáçÊñ∞Ê∏≤ÊüìÊâÄÊúâÊ∂àÊÅØÊàñËøΩÂä†Êñ∞Ê∂àÊÅØ
                            if (page > 1 || append) {
                                // Â¶ÇÊûúÊòØÂä†ËΩΩÊõ¥Â§öÊàñËøΩÂä†Ê®°Âºè
                                if (page > 1) {
                                    // Ê∏ÖÁ©∫ËÅäÂ§©Âå∫Âüü
                                    chatMessages.innerHTML = '';
                                    
                                    // ÈáçÊñ∞Ê∏≤ÊüìÊâÄÊúâÊ∂àÊÅØ
                                    let currentDate = null;
                                    
                                    currentRoomMessages.forEach(msg => {
                                        const messageDate = new Date(msg.created_at);
                                        const messageDateStr = messageDate.toDateString();
                                        
                                        // Â¶ÇÊûúÊó•ÊúüÂèòÂåñÔºåÊ∑ªÂä†Êó•ÊúüÂàÜÈöîÁ∫ø
                                        if (!currentDate || messageDateStr !== currentDate) {
                                            currentDate = messageDateStr;
                                            addDateSeparator(messageDate);
                                        }
                                        
                                        // Áõ¥Êé•‰º†ÈÄíMessageBasicÂØπË±°ÔºåÂåÖÂê´ÊâÄÊúâÂøÖË¶ÅÂ≠óÊÆµ
                                        appendMessage(msg);
                                    });
                                    
                                    // ËÆ°ÁÆóÊñ∞Â¢ûÂÜÖÂÆπÁöÑÈ´òÂ∫¶ÔºåÂπ∂Ë∞ÉÊï¥ÊªöÂä®‰ΩçÁΩÆ
                                    const newHeight = chatMessages.scrollHeight;
                                    chatMessages.scrollTop = scrollPos + (newHeight - oldHeight);
                                } else {
                                    // Â¶ÇÊûúÊòØËøΩÂä†Ê®°Âºè‰ΩÜ‰∏çÊòØÂä†ËΩΩÊõ¥Â§öÔºåÊªöÂä®Âà∞Â∫ïÈÉ®
                                    chatMessages.scrollTop = chatMessages.scrollHeight;
                                }
                            } else {
                                // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÈ°µ‰∏î‰∏çÊòØËøΩÂä†Ê®°ÂºèÔºåÁõ¥Êé•Ê∏≤Êüì
                                let currentDate = null;
                                
                                messages.forEach(msg => {
                                    const messageDate = new Date(msg.created_at);
                                    const messageDateStr = messageDate.toDateString();
                                    
                                    // Â¶ÇÊûúÊó•ÊúüÂèòÂåñÔºåÊ∑ªÂä†Êó•ÊúüÂàÜÈöîÁ∫ø
                                    if (!currentDate || messageDateStr !== currentDate) {
                                        currentDate = messageDateStr;
                                        addDateSeparator(messageDate);
                                    }
                                    
                                    // Áõ¥Êé•‰º†ÈÄíMessageBasicÂØπË±°ÔºåÂåÖÂê´ÊâÄÊúâÂøÖË¶ÅÂ≠óÊÆµ
                                    appendMessage(msg);
                                });
                                
                                // ÊªöÂä®Âà∞Â∫ïÈÉ®
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                            }
                            
                            // Êõ¥Êñ∞ÂΩìÂâçÈ°µÁ†Å
                            currentPage = page;
                        }
                    } else {
                        console.error('Ëé∑ÂèñËÅäÂ§©ËÆ∞ÂΩïÂ§±Ë¥•:', data.msg);
                    }
                } catch (error) {
                    console.error('Ëé∑ÂèñËÅäÂ§©ËÆ∞ÂΩïÂá∫Èîô:', error);
                } finally {
                    isLoadingMessages = false;
                }
            }
            
            // Ê∑ªÂä†Ê∂àÊÅØÂà∞ËÅäÂ§©Âå∫Âüü
            function appendMessage(message) {
                const isCurrentUser = message.user_id === currentUser.user_id;
                
                const messageElement = document.createElement('div');
                messageElement.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'} mb-4`;
                
                // Ê†ºÂºèÂåñÂèëÈÄÅÊó∂Èó¥ÔºåÂè™Á≤æÁ°ÆÂà∞ÂàÜÈíü
                const createdTime = new Date(message.created_at || new Date()).toLocaleTimeString([], { 
                    hour: '2-digit', minute: '2-digit' 
                });
                
                // Ëé∑ÂèñÁî®Êà∑ÊòµÁß∞
                const userName = isCurrentUser ? currentUser.nickname : (currentChatUser?.nickname || 'Áî®Êà∑');
                
                // Ê†πÊçÆÊ∂àÊÅØÁ±ªÂûãÊ∏≤Êüì‰∏çÂêåÁöÑÂÜÖÂÆπ
                let messageContent = '';
                const messageType = message.type || 'text'; // ÈªòËÆ§‰∏∫ÊñáÊú¨Á±ªÂûã
                
                switch (messageType) {
                    case 'emoji':
                        messageContent = `<span class="text-4xl">${message.data}</span>`;
                        break;
                    case 'image':
                        messageContent = `
                            <div class="max-w-48">
                                <img src="${message.data}" alt="${message.file_name || 'ÂõæÁâá'}" class="rounded-lg max-w-full h-auto cursor-pointer" onclick="window.open('${message.data}', '_blank')">
                                <p class="text-xs text-gray-500 mt-1">${message.file_name || 'ÂõæÁâá'}</p>
                            </div>
                        `;
                        break;
                    case 'file':
                        const fileSize = message.file_size ? (message.file_size / 1024 / 1024).toFixed(2) + 'MB' : 'Êú™Áü•Â§ßÂ∞è';
                        messageContent = `
                            <div class="flex items-center space-x-3 p-3 border border-gray-300 rounded-lg bg-white">
                                <div class="flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate">${message.file_name || 'Êñá‰ª∂'}</p>
                                    <p class="text-xs text-gray-500">${fileSize}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <a href="${message.data}" download="${message.file_name}" class="text-indigo-600 hover:text-indigo-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        `;
                        break;
                    case 'text':
                    default:
                        messageContent = `<p>${message.data || message.message}</p>`;
                        break;
                }
                
                messageElement.innerHTML = `
                    <div class="${isCurrentUser ? 'order-2' : 'order-1'} flex-shrink-0">
                        <img src="${isCurrentUser ? (currentUser.avatar || 'https://via.placeholder.com/32') : (currentChatUser?.avatar || 'https://via.placeholder.com/32')}" alt="Â§¥ÂÉè" class="w-8 h-8 rounded-full">
                    </div>
                    <div class="${isCurrentUser ? 'order-1' : 'order-2'} max-w-xs mx-2">
                        <div class="${isCurrentUser ? 'text-right' : 'text-left'} text-xs text-gray-600 mb-1">${userName}</div>
                        <div class="${isCurrentUser ? 'bg-indigo-500 text-white' : 'bg-gray-200 text-gray-800'} rounded-lg ${messageType === 'emoji' ? 'px-2 py-1' : messageType === 'image' || messageType === 'file' ? 'p-2' : 'px-4 py-2'} shadow">
                            ${messageContent}
                        </div>
                        <div class="text-xs text-gray-500 ${isCurrentUser ? 'text-right' : 'text-left'} mt-1">
                            <span>${createdTime}</span>
                        </div>
                    </div>
                `;
                
                chatMessages.appendChild(messageElement);
                
                // ÊªöÂä®Âà∞Â∫ïÈÉ®
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Ê∑ªÂä†ÊªöÂä®‰∫ã‰ª∂ÁõëÂê¨Ôºå‰∏äÊªëÂä†ËΩΩÊõ¥Â§öÊ∂àÊÅØ
            function setupScrollListener() {
                // ÁßªÈô§‰πãÂâçÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÂ¶ÇÊûúÊúâÔºâ
                chatMessages.removeEventListener('scroll', handleScroll);
                
                // Ê∑ªÂä†Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                chatMessages.addEventListener('scroll', handleScroll);
            }
            
            // Â§ÑÁêÜÊªöÂä®‰∫ã‰ª∂
            function handleScroll() {
                // Â¶ÇÊûúÊªöÂä®Âà∞È°∂ÈÉ®ÈôÑËøëÔºàË∑ùÁ¶ªÈ°∂ÈÉ®Â∞è‰∫é50ÂÉèÁ¥†ÔºâÔºåÂä†ËΩΩÊõ¥Â§öÊ∂àÊÅØ
                if (chatMessages.scrollTop < 50 && !isLoadingMessages && hasMoreMessages && currentRoomId) {
                    // Âä†ËΩΩ‰∏ã‰∏ÄÈ°µÊ∂àÊÅØ
                    loadChatMessages(currentRoomId, currentPage + 1, 20, true);
                }
            }
            
            // ÊâìÂºÄËÅäÂ§©
            function openChat(roomId, contact) {
                // Â¶ÇÊûúÊòØÂêå‰∏Ä‰∏™ËÅäÂ§©Ôºå‰∏çÈáçÊñ∞Âä†ËΩΩ
                if (currentRoomId === roomId) {
                    return;
                }
                
                currentRoomId = roomId;
                currentChatUser = contact;
                
                // Ê∏ÖÈô§ËØ•Â•ΩÂèãÁöÑÊñ∞Ê∂àÊÅØÊèêÁ§∫
                const friendIndex = friends.findIndex(f => f.room_id === roomId);
                if (friendIndex !== -1) {
                    friends[friendIndex].has_new_message = false;
                    friends[friendIndex].new_message_count = 0;
                    // ÈáçÊñ∞Ê∏≤ÊüìÂ•ΩÂèãÂàóË°®‰ª•Êõ¥Êñ∞UI
                    renderFriendList(friends);
                }
                
                // ÈáçÁΩÆÂàÜÈ°µÂèòÈáè
                currentPage = 1;
                hasMoreMessages = true;
                currentRoomMessages = [];
                
                // Êõ¥Êñ∞ËÅäÂ§©Ê†áÈ¢òÔºåÊ†πÊçÆÁ±ªÂûãÊòæÁ§∫‰∏çÂêåÁöÑÊ†áÈ¢ò
                const chatType = contact.type === 1 ? 'ÁßÅËÅä' : 'Áæ§ËÅä';
                chatTitle.innerHTML = `${contact.nickname} <span class="text-sm text-gray-500">(${chatType})</span>`;
                
                // ÊòæÁ§∫ËÅäÂ§©ËæìÂÖ•Âå∫Âüü
                chatInputArea.classList.remove('hidden');
                
                // ÊòæÁ§∫ËÅäÂ§©Êìç‰ΩúÂå∫ÂüüÔºåÂè™ÊúâÁßÅËÅäÊâçÊòæÁ§∫Âà†Èô§Â•ΩÂèãÊåâÈíÆ
                chatActions.classList.remove('hidden');
                if (contact.type === 1) {
                    deleteFriendBtn.classList.remove('hidden');
                } else {
                    deleteFriendBtn.classList.add('hidden');
                }
                
                // Âä†ËΩΩËÅäÂ§©ËÆ∞ÂΩï
                loadChatMessages(roomId);
                
                // ËÆæÁΩÆÊªöÂä®‰∫ã‰ª∂ÁõëÂê¨
                setupScrollListener();
            }
            
            // ÊêúÁ¥¢Â•ΩÂèã
            async function searchFriend(account) {
                try {
                    const response = await fetch(`/user/query?account=${account}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // ÊàêÂäüÁä∂ÊÄÅÁ†Å
                        return data.data;
                    } else {
                        throw new Error(data.msg || 'ÊêúÁ¥¢Â•ΩÂèãÂ§±Ë¥•');
                    }
                } catch (error) {
                    console.error('ÊêúÁ¥¢Â•ΩÂèãÂá∫Èîô:', error);
                    throw error;
                }
            }
            
            // Ê∑ªÂä†Â•ΩÂèã
            async function addFriend(account) {
                try {
                    const formData = new FormData();
                    formData.append('account', account);
                    
                    const response = await fetch('/user/add', {
                        method: 'POST',
                        headers: {
                            'Authorization': token
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // ÊàêÂäüÁä∂ÊÄÅÁ†Å
                        return data.data;
                    } else {
                        throw new Error(data.msg || 'Ê∑ªÂä†Â•ΩÂèãÂ§±Ë¥•');
                    }
                } catch (error) {
                    console.error('Ê∑ªÂä†Â•ΩÂèãÂá∫Èîô:', error);
                    throw error;
                }
            }
            
            // Âà†Èô§Â•ΩÂèã
            async function deleteFriend(roomId) {
                try {
                    // ‰ªéÂΩìÂâçÂ•ΩÂèãÂàóË°®‰∏≠ÊâæÂà∞ÂØπÂ∫îÁöÑÂ•ΩÂèã‰ø°ÊÅØ
                    const friend = friends.find(f => f.room_id === roomId);
                    if (!friend) {
                        throw new Error('Êâæ‰∏çÂà∞ËØ•Â•ΩÂèã‰ø°ÊÅØ');
                    }
                    
                    // ÊûÑÂª∫ËØ∑Ê±ÇÂèÇÊï∞
                    const formData = new FormData();
                    formData.append('room_id', roomId);
                    
                    const response = await fetch('/user/delete', {
                        method: 'DELETE',
                        headers: {
                            'Authorization': token
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // ÊàêÂäüÁä∂ÊÄÅÁ†Å
                        return true;
                    } else {
                        throw new Error(data.msg || 'Âà†Èô§Â•ΩÂèãÂ§±Ë¥•');
                    }
                } catch (error) {
                    console.error('Âà†Èô§Â•ΩÂèãÂá∫Èîô:', error);
                    throw error;
                }
            }
            
            // ‰∫ã‰ª∂ÁõëÂê¨
            
            // ÈÄÄÂá∫ÁôªÂΩï
            logoutBtn.addEventListener('click', function() {
                // ÂÖ≥Èó≠WebSocketËøûÊé•
                if (socket) {
                    socket.close();
                }
                
                // Ê∏ÖÈô§Êú¨Âú∞Â≠òÂÇ®ÁöÑtoken
                localStorage.removeItem('token');
                
                // Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢
                window.location.href = 'login.html';
            });
            
            // ÂèëÈÄÅÊ∂àÊÅØ
            messageForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const message = messageInput.value.trim();
                if (!message) return;
                
                if (!currentRoomId) {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©');
                    return;
                }
                
                // Ëé∑ÂèñÂΩìÂâçÊó•Êúü
                const now = new Date();
                const todayStr = now.toDateString();
                
                // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊ∑ªÂä†Êó•ÊúüÂàÜÈöîÁ∫ø
                let lastDateStr = null;
                const dateElements = chatMessages.querySelectorAll('.date-separator');
                if (dateElements.length > 0) {
                    const lastDateElement = dateElements[dateElements.length - 1];
                    lastDateStr = lastDateElement.getAttribute('data-date');
                }
                
                // Â¶ÇÊûúÊó•Êúü‰∏çÂêåÊàñÊ≤°ÊúâÊó•ÊúüÂàÜÈöîÁ∫øÔºåÊ∑ªÂä†Êñ∞ÁöÑÊó•ÊúüÂàÜÈöîÁ∫ø
                if (!lastDateStr || todayStr !== lastDateStr) {
                    addDateSeparator(now);
                }
                
                // ÊûÑÂª∫Ê∂àÊÅØÂØπË±°Ôºå‰ΩøÁî®dataÂ≠óÊÆµÂåπÈÖçMessageBasicÁªìÊûÑ
                const messageObj = {
                    user_id: currentUser.user_id,
                    room_id: currentRoomId,
                    data: message,
                    type: 'text', // ËÆæÁΩÆÊ∂àÊÅØÁ±ªÂûã‰∏∫ÊñáÊú¨
                    created_at: now.toISOString() // Ê∑ªÂä†ÂàõÂª∫Êó∂Èó¥
                };
                
                // ÂèëÈÄÅÊ∂àÊÅØ
                socket.send(JSON.stringify(messageObj));
                
                // Ê∑ªÂä†Ê∂àÊÅØÂà∞ÂΩìÂâçÊ∂àÊÅØÂàóË°®ÔºàÊú¨Âú∞ÊòæÁ§∫Ôºå‰∏çÁ≠âÂæÖÊúçÂä°Âô®ÂìçÂ∫îÔºâ
                // Ê≥®ÊÑèÔºöÊúçÂä°Âô®ÂìçÂ∫îÂêé‰ºöÈÄöËøáWebSocketÂÜçÊ¨°Êî∂Âà∞ËøôÊù°Ê∂àÊÅØÔºå‰ΩÜÁî±‰∫éÂ∑≤ÁªèÊ∑ªÂä†ËøáÔºå‰∏ç‰ºöÈáçÂ§çÊòæÁ§∫
                currentRoomMessages.push(messageObj);
                
                // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
                messageInput.value = '';
            });
            
            // ÊâìÂºÄÊ∑ªÂä†Â•ΩÂèãÊ®°ÊÄÅÊ°Ü
            addFriendBtn.addEventListener('click', function() {
                // ÈáçÁΩÆË°®Âçï
                addFriendForm.reset();
                searchResult.classList.add('hidden');
                confirmAddFriendBtn.classList.add('hidden');
                addFriendError.classList.add('hidden');
                addFriendSuccess.classList.add('hidden');
                
                // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                addFriendModal.classList.remove('hidden');
            });
            
            // ÂÖ≥Èó≠Ê∑ªÂä†Â•ΩÂèãÊ®°ÊÄÅÊ°Ü
            closeAddFriendModal.addEventListener('click', function() {
                addFriendModal.classList.add('hidden');
            });
            
            // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            addFriendModal.addEventListener('click', function(e) {
                if (e.target === addFriendModal) {
                    addFriendModal.classList.add('hidden');
                }
            });
            
            // ÊêúÁ¥¢Â•ΩÂèã
            searchFriendBtn.addEventListener('click', async function() {
                const account = friendAccount.value.trim();
                if (!account) {
                    addFriendErrorText.textContent = 'ËØ∑ËæìÂÖ•Â•ΩÂèãË¥¶Âè∑';
                    addFriendError.classList.remove('hidden');
                    addFriendSuccess.classList.add('hidden');
                    return;
                }
                
                try {
                    const user = await searchFriend(account);
                    
                    // ÊòæÁ§∫ÊêúÁ¥¢ÁªìÊûú
                    resultNickname.textContent = user.nickname || user.account;
                    resultAccount.textContent = user.account;
                    if (user.avatar) {
                        resultAvatar.src = user.avatar;
                    }
                    
                    searchResult.classList.remove('hidden');
                    
                    // Â¶ÇÊûúÂ∑≤ÁªèÊòØÂ•ΩÂèãÔºå‰∏çÊòæÁ§∫Ê∑ªÂä†ÊåâÈíÆ
                    if (user.is_friend) {
                        addFriendErrorText.textContent = 'ËØ•Áî®Êà∑Â∑≤ÁªèÊòØÊÇ®ÁöÑÂ•ΩÂèã';
                        addFriendError.classList.remove('hidden');
                        addFriendSuccess.classList.add('hidden');
                        confirmAddFriendBtn.classList.add('hidden');
                    } else {
                        addFriendError.classList.add('hidden');
                        addFriendSuccess.classList.add('hidden');
                        confirmAddFriendBtn.classList.remove('hidden');
                        
                        // Â≠òÂÇ®ÊêúÁ¥¢Âà∞ÁöÑÁî®Êà∑‰ø°ÊÅØ
                        confirmAddFriendBtn.dataset.account = user.account;
                    }
                } catch (error) {
                    addFriendErrorText.textContent = error.message || 'ÊêúÁ¥¢Â•ΩÂèãÂ§±Ë¥•';
                    addFriendError.classList.remove('hidden');
                    addFriendSuccess.classList.add('hidden');
                    searchResult.classList.add('hidden');
                    confirmAddFriendBtn.classList.add('hidden');
                }
            });
            
            // Á°ÆËÆ§Ê∑ªÂä†Â•ΩÂèã
            confirmAddFriendBtn.addEventListener('click', async function() {
                const account = confirmAddFriendBtn.dataset.account;
                if (!account) return;
                
                try {
                    await addFriend(account);
                    
                    // ÊòæÁ§∫ÊàêÂäü‰ø°ÊÅØ
                    addFriendSuccessText.textContent = 'Ê∑ªÂä†Â•ΩÂèãÊàêÂäü';
                    addFriendSuccess.classList.remove('hidden');
                    addFriendError.classList.add('hidden');
                    
                    // ÈáçÊñ∞Ëé∑ÂèñÂ•ΩÂèãÂàóË°®
                    fetchFriends();
                    
                    // 3ÁßíÂêéÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                    setTimeout(() => {
                        addFriendModal.classList.add('hidden');
                    }, 3000);
                } catch (error) {
                    addFriendErrorText.textContent = error.message || 'Ê∑ªÂä†Â•ΩÂèãÂ§±Ë¥•';
                    addFriendError.classList.remove('hidden');
                    addFriendSuccess.classList.add('hidden');
                }
            });
            
            // Âà†Èô§Â•ΩÂèã
            deleteFriendBtn.addEventListener('click', async function() {
                if (!currentChatUser || !currentRoomId) return;
                
                // Âè™ÊúâÁßÅËÅäÊâçËÉΩÂà†Èô§Â•ΩÂèã
                if (currentChatUser.type !== 1) {
                    alert('Âè™ËÉΩÂà†Èô§ÁßÅËÅäËÅîÁ≥ª‰∫∫');
                    return;
                }
                
                if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Â•ΩÂèã ${currentChatUser.nickname} ÂêóÔºü`)) {
                    try {
                        await deleteFriend(currentRoomId);
                        
                        // ÈáçÊñ∞Ëé∑ÂèñÂ•ΩÂèãÂàóË°®
                        fetchFriends();
                        
                        // ÈáçÁΩÆËÅäÂ§©Âå∫Âüü
                        currentRoomId = null;
                        currentChatUser = null;
                        chatTitle.textContent = 'ËØ∑ÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©';
                        chatMessages.innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-gray-500">ÈÄâÊã©‰∏Ä‰∏™ËÅîÁ≥ª‰∫∫ÂºÄÂßãËÅäÂ§©</p></div>';
                        chatInputArea.classList.add('hidden');
                        chatActions.classList.add('hidden');
                        
                        alert('Âà†Èô§Â•ΩÂèãÊàêÂäü');
                    } catch (error) {
                        alert(error.message || 'Âà†Èô§Â•ΩÂèãÂ§±Ë¥•');
                    }
                }
            });
            
            // ÊêúÁ¥¢ËÅîÁ≥ª‰∫∫ÔºàÊú¨Âú∞ÊêúÁ¥¢Ôºâ
            searchBtn.addEventListener('click', function() {
                const keyword = searchInput.value.trim().toLowerCase();
                if (!keyword) {
                    // ÊòæÁ§∫ÊâÄÊúâËÅîÁ≥ª‰∫∫
                    renderFriendList(friends);
                    return;
                }
                
                // ËøáÊª§ËÅîÁ≥ª‰∫∫ÂàóË°®
                const filteredFriends = friends.filter(friend => {
                    return friend.nickname.toLowerCase().includes(keyword);
                });
                
                // Êõ¥Êñ∞ËÅîÁ≥ª‰∫∫ÂàóË°®
                renderFriendList(filteredFriends);
            });
            
            // ÊêúÁ¥¢Ê°ÜÂõûËΩ¶‰∫ã‰ª∂
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    searchBtn.click();
                }
            });
            
            // ÊêúÁ¥¢Ê°ÜÊ∏ÖÁ©∫‰∫ã‰ª∂
            searchInput.addEventListener('input', function() {
                if (this.value.trim() === '') {
                    renderFriendList(friends);
                }
            });
            
            // Ê∏≤ÊüìÂ•ΩÂèãÂàóË°®
            function renderFriendList(friendsList) {
                // Ê∏ÖÁ©∫Â•ΩÂèãÂàóË°®
                friendList.innerHTML = '';
                
                if (friendsList.length === 0) {
                    friendList.innerHTML = '<div class="text-center text-gray-500 py-4">Êú™ÊâæÂà∞ÂåπÈÖçÁöÑËÅîÁ≥ª‰∫∫</div>';
                    return;
                }
                
                // Ê∏≤ÊüìÂ•ΩÂèãÂàóË°®
                friendsList.forEach(friend => {
                    const friendElement = document.createElement('div');
                    // Â¶ÇÊûúÊúâÊñ∞Ê∂àÊÅØÔºåÊ∑ªÂä†ÁâπÊÆäÊ†∑Âºè
                    const hasNewMessage = friend.has_new_message && friend.room_id !== currentRoomId;
                    friendElement.className = `p-2 hover:bg-gray-100 rounded-md cursor-pointer relative ${hasNewMessage ? 'bg-blue-50 border-l-4 border-blue-500' : ''}`;
                    friendElement.dataset.roomId = friend.room_id;
                    friendElement.dataset.type = friend.type;
                    
                    // Ê†πÊçÆÁ±ªÂûãÊòæÁ§∫‰∏çÂêåÁöÑÂõæÊ†á
                    const typeIcon = friend.type === 1 ? 
                        '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>' : 
                        '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" /></svg>';
                    
                    // Êñ∞Ê∂àÊÅØÊèêÁ§∫Ê†áËØÜ
                    const newMessageBadge = hasNewMessage && friend.new_message_count > 0 ? 
                        `<span class="absolute top-1 right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold">${friend.new_message_count > 99 ? '99+' : friend.new_message_count}</span>` : '';
                    
                    friendElement.innerHTML = `
                        <div class="flex items-center">
                            <img src="${friend.avatar || 'https://via.placeholder.com/40'}" alt="Â§¥ÂÉè" class="w-10 h-10 rounded-full mr-3">
                            <div class="flex-1">
                                <div class="flex items-center">
                                    <p class="font-medium ${hasNewMessage ? 'text-blue-700' : ''}">${friend.nickname}</p>
                                    <span class="ml-2" title="${friend.type === 1 ? 'ÁßÅËÅä' : 'Áæ§ËÅä'}">${typeIcon}</span>
                                    ${hasNewMessage ? '<span class="ml-2 w-2 h-2 bg-red-500 rounded-full" title="ÊúâÊñ∞Ê∂àÊÅØ"></span>' : ''}
                                </div>
                                <div class="flex items-center text-sm ${hasNewMessage ? 'text-blue-600 font-medium' : 'text-gray-500'} truncate">
                                    ${getMessageTypeIcon(friend.last_message_type || 'text')}
                                    <span class="ml-1">${friend.last_message || ''}</span>
                                </div>
                            </div>
                        </div>
                        ${newMessageBadge}
                    `;
                    
                    // ÁÇπÂáªËÅîÁ≥ª‰∫∫ÊâìÂºÄËÅäÂ§©
                    friendElement.addEventListener('click', function() {
                        openChat(friend.room_id, friend);
                    });
                    
                    friendList.appendChild(friendElement);
                });
            }
            
            // Ëé∑ÂèñÊ∂àÊÅØÁ±ªÂûãÂõæÊ†á
            function getMessageTypeIcon(messageType) {
                switch (messageType) {
                    case 'emoji':
                        return '<span class="text-yellow-500">üòä</span>';
                    case 'image':
                        return '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>';
                    case 'file':
                        return '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>';
                    case 'video':
                        return '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>';
                    case 'speech':
                        return '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>';
                    case 'text':
                    default:
                        return '';
                }
            }
            
            // ÂàùÂßãÂåñË°®ÊÉÖÈÄâÊã©Âô®
            function initEmojiPicker() {
                const emojiGrid = emojiPicker.querySelector('.grid');
                emojiGrid.innerHTML = '';
                
                emojis.forEach(emoji => {
                    const emojiBtn = document.createElement('button');
                    emojiBtn.type = 'button';
                    emojiBtn.className = 'p-2 text-2xl hover:bg-gray-200 rounded transition-colors duration-200';
                    emojiBtn.textContent = emoji;
                    emojiBtn.addEventListener('click', function() {
                        // ÂèëÈÄÅË°®ÊÉÖÊ∂àÊÅØ
                        sendEmojiMessage(emoji);
                        // ÈöêËóèË°®ÊÉÖÈÄâÊã©Âô®
                        emojiPicker.classList.add('hidden');
                    });
                    emojiGrid.appendChild(emojiBtn);
                });
            }
            
            // ÂèëÈÄÅË°®ÊÉÖÊ∂àÊÅØ
            function sendEmojiMessage(emoji) {
                if (!currentRoomId) {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©');
                    return;
                }
                
                const now = new Date();
                
                // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊ∑ªÂä†Êó•ÊúüÂàÜÈöîÁ∫ø
                const lastDateElements = chatMessages.querySelectorAll('.date-separator');
                const lastDateStr = lastDateElements.length > 0 ? 
                    lastDateElements[lastDateElements.length - 1].textContent.trim() : null;
                const todayStr = now.getFullYear() + '/' + 
                                String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                                String(now.getDate()).padStart(2, '0');
                
                if (!lastDateStr || todayStr !== lastDateStr) {
                    addDateSeparator(now);
                }
                
                // ÊûÑÂª∫Ë°®ÊÉÖÊ∂àÊÅØÂØπË±°
                const messageObj = {
                    user_id: currentUser.user_id,
                    room_id: currentRoomId,
                    data: emoji,
                    type: 'emoji', // ËÆæÁΩÆÊ∂àÊÅØÁ±ªÂûã‰∏∫Ë°®ÊÉÖ
                    created_at: now.toISOString()
                };
                
                // ÂèëÈÄÅÊ∂àÊÅØ
                socket.send(JSON.stringify(messageObj));
                
                // Ê∑ªÂä†Ê∂àÊÅØÂà∞ÂΩìÂâçÊ∂àÊÅØÂàóË°®
                currentRoomMessages.push(messageObj);
            }
            
            // ÂèëÈÄÅÂõæÁâáÊ∂àÊÅØ
            function sendImageMessage(file) {
                if (!currentRoomId) {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©');
                    return;
                }
                
                // ÂàõÂª∫Êñá‰ª∂ËØªÂèñÂô®
                const reader = new FileReader();
                reader.onload = function(e) {
                    const now = new Date();
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊ∑ªÂä†Êó•ÊúüÂàÜÈöîÁ∫ø
                    const lastDateElements = chatMessages.querySelectorAll('.date-separator');
                    const lastDateStr = lastDateElements.length > 0 ? 
                        lastDateElements[lastDateElements.length - 1].textContent.trim() : null;
                    const todayStr = now.getFullYear() + '/' + 
                                    String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                                    String(now.getDate()).padStart(2, '0');
                    
                    if (!lastDateStr || todayStr !== lastDateStr) {
                        addDateSeparator(now);
                    }
                    
                    // ÊûÑÂª∫ÂõæÁâáÊ∂àÊÅØÂØπË±°
                    const messageObj = {
                        user_id: currentUser.user_id,
                        room_id: currentRoomId,
                        data: e.target.result, // base64ÁºñÁ†ÅÁöÑÂõæÁâáÊï∞ÊçÆ
                        type: 'image',
                        file_name: file.name,
                        file_size: file.size,
                        created_at: now.toISOString()
                    };
                    
                    // ÂèëÈÄÅÊ∂àÊÅØ
                    socket.send(JSON.stringify(messageObj));
                    
                    // Ê∑ªÂä†Ê∂àÊÅØÂà∞ÂΩìÂâçÊ∂àÊÅØÂàóË°®
                    currentRoomMessages.push(messageObj);
                };
                
                reader.readAsDataURL(file);
            }
            
            // ÂèëÈÄÅÊñá‰ª∂Ê∂àÊÅØ
            function sendFileMessage(file) {
                if (!currentRoomId) {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©');
                    return;
                }
                
                // ÂàõÂª∫Êñá‰ª∂ËØªÂèñÂô®
                const reader = new FileReader();
                reader.onload = function(e) {
                    const now = new Date();
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊ∑ªÂä†Êó•ÊúüÂàÜÈöîÁ∫ø
                    const lastDateElements = chatMessages.querySelectorAll('.date-separator');
                    const lastDateStr = lastDateElements.length > 0 ? 
                        lastDateElements[lastDateElements.length - 1].textContent.trim() : null;
                    const todayStr = now.getFullYear() + '/' + 
                                    String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                                    String(now.getDate()).padStart(2, '0');
                    
                    if (!lastDateStr || todayStr !== lastDateStr) {
                        addDateSeparator(now);
                    }
                    
                    // ÊûÑÂª∫Êñá‰ª∂Ê∂àÊÅØÂØπË±°
                    const messageObj = {
                        user_id: currentUser.user_id,
                        room_id: currentRoomId,
                        data: e.target.result, // base64ÁºñÁ†ÅÁöÑÊñá‰ª∂Êï∞ÊçÆ
                        type: 'file',
                        file_name: file.name,
                        file_size: file.size,
                        created_at: now.toISOString()
                    };
                    
                    // ÂèëÈÄÅÊ∂àÊÅØ
                    socket.send(JSON.stringify(messageObj));
                    
                    // Ê∑ªÂä†Ê∂àÊÅØÂà∞ÂΩìÂâçÊ∂àÊÅØÂàóË°®
                    currentRoomMessages.push(messageObj);
                };
                
                reader.readAsDataURL(file);
            }
            
            // Ë°®ÊÉÖÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            emojiBtn.addEventListener('click', function() {
                emojiPicker.classList.toggle('hidden');
            });
            
            // ÂõæÁâáÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            imageBtn.addEventListener('click', function() {
                imageInput.click();
            });
            
            // Êñá‰ª∂ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            fileBtn.addEventListener('click', function() {
                fileInput.click();
            });
            
            // ÂõæÁâáÊñá‰ª∂ÈÄâÊã©‰∫ã‰ª∂
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÔºàÈôêÂà∂‰∏∫5MBÔºâ
                    if (file.size > 5 * 1024 * 1024) {
                        alert('ÂõæÁâáÊñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá5MB');
                        return;
                    }
                    sendImageMessage(file);
                }
                // Ê∏ÖÁ©∫Êñá‰ª∂ÈÄâÊã©Âô®
                e.target.value = '';
            });
            
            // Êñá‰ª∂ÈÄâÊã©‰∫ã‰ª∂
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÔºàÈôêÂà∂‰∏∫10MBÔºâ
                    if (file.size > 10 * 1024 * 1024) {
                        alert('Êñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá10MB');
                        return;
                    }
                    sendFileMessage(file);
                }
                // Ê∏ÖÁ©∫Êñá‰ª∂ÈÄâÊã©Âô®
                e.target.value = '';
            });
            
            // ÂõûËΩ¶ÈîÆÂèëÈÄÅÊ∂àÊÅØ
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    messageForm.dispatchEvent(new Event('submit'));
                }
            });
            
            // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÈöêËóèË°®ÊÉÖÈÄâÊã©Âô®
            document.addEventListener('click', function(e) {
                if (!emojiBtn.contains(e.target) && !emojiPicker.contains(e.target)) {
                    emojiPicker.classList.add('hidden');
                }
            });
            
            // ÂàùÂßãÂåñ
            initEmojiPicker();
            fetchCurrentUser();
        });
    </script>
</body>
</html>