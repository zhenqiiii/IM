<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊天 - IM即时通讯系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-indigo-600 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">IM即时通讯系统</h1>
            <div class="flex items-center space-x-4">
                <span id="user-nickname" class="text-sm">加载中...</span>
                <img id="user-avatar" src="https://avatars.githubusercontent.com/u/148515933?s=400&u=7cbff7c77a33416cabfe463fff24495157026760&v=4" alt="头像" class="w-8 h-8 rounded-full">
                <button id="logout-btn" class="text-sm bg-indigo-700 hover:bg-indigo-800 px-3 py-1 rounded">
                    退出登录
                </button>
            </div>
        </div>
    </header>

    <!-- 主要内容区域 -->
    <div class="flex-1 flex overflow-hidden">
        <!-- 左侧联系人列表 -->
        <div class="w-1/4 bg-white border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b border-gray-200">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="搜索联系人" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="search-btn" class="absolute right-2 top-2 text-gray-500 hover:text-indigo-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-2" id="friend-list">
                <!-- 联系人列表将通过JavaScript动态加载 -->
                <div class="text-center text-gray-500 py-4">加载联系人列表中...</div>
            </div>
            
            <div class="p-4 border-t border-gray-200">
                <button id="add-friend-btn" class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    添加联系人
                </button>
            </div>
        </div>
        
        <!-- 右侧聊天区域 -->
        <div class="flex-1 flex flex-col">
            <!-- 聊天头部 -->
            <div class="p-4 border-b border-gray-200 bg-white shadow-sm flex justify-between items-center">
                <h2 id="chat-title" class="text-lg font-medium">请选择一个聊天</h2>
                <div id="chat-actions" class="hidden">
                    <button id="delete-friend-btn" class="text-sm text-red-600 hover:text-red-800">
                        删除好友
                    </button>
                </div>
            </div>
            
            <!-- 聊天消息区域 -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 bg-gray-50">
                <div class="flex items-center justify-center h-full">
                    <p class="text-gray-500">选择一个联系人开始聊天</p>
                </div>
            </div>
            
            <!-- 聊天输入区域 -->
            <div id="chat-input-area" class="p-4 border-t border-gray-200 bg-white hidden">
                <form id="message-form" class="flex items-center">
                    <input type="text" id="message-input" placeholder="输入消息..." class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <button type="submit" class="px-4 py-2 border border-transparent rounded-r-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        发送
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- 添加好友模态框 -->
    <div id="add-friend-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">添加好友</h3>
                <button id="close-add-friend-modal" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div id="add-friend-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4">
                <span id="add-friend-error-text"></span>
            </div>
            
            <div id="add-friend-success" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4">
                <span id="add-friend-success-text"></span>
            </div>
            
            <form id="add-friend-form">
                <div class="mb-4">
                    <label for="friend-account" class="block text-sm font-medium text-gray-700 mb-1">好友账号</label>
                    <input type="text" id="friend-account" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div id="search-result" class="mb-4 hidden">
                    <div class="p-3 border border-gray-200 rounded-md">
                        <div class="flex items-center">
                            <img id="result-avatar" src="https://via.placeholder.com/40" alt="头像" class="w-10 h-10 rounded-full mr-3">
                            <div>
                                <p id="result-nickname" class="font-medium"></p>
                                <p id="result-account" class="text-sm text-gray-500"></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="search-friend-btn" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        搜索
                    </button>
                    <button type="button" id="confirm-add-friend-btn" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 hidden">
                        添加
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否已登录
            const token = localStorage.getItem('token');
            if (!token) {
                // 未登录，跳转到登录页面
                window.location.href = 'login.html';
                return;
            }
            
            // 全局变量
            let currentUser = null;
            let currentRoomId = null;
            let currentChatUser = null;
            let socket = null;
            let friends = [];
            
            // DOM元素
            const userNickname = document.getElementById('user-nickname');
            const userAvatar = document.getElementById('user-avatar');
            const logoutBtn = document.getElementById('logout-btn');
            const friendList = document.getElementById('friend-list');
            const chatTitle = document.getElementById('chat-title');
            const chatMessages = document.getElementById('chat-messages');
            const chatInputArea = document.getElementById('chat-input-area');
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-input');
            const addFriendBtn = document.getElementById('add-friend-btn');
            const addFriendModal = document.getElementById('add-friend-modal');
            const closeAddFriendModal = document.getElementById('close-add-friend-modal');
            const addFriendForm = document.getElementById('add-friend-form');
            const friendAccount = document.getElementById('friend-account');
            const searchFriendBtn = document.getElementById('search-friend-btn');
            const searchResult = document.getElementById('search-result');
            const resultAvatar = document.getElementById('result-avatar');
            const resultNickname = document.getElementById('result-nickname');
            const resultAccount = document.getElementById('result-account');
            const confirmAddFriendBtn = document.getElementById('confirm-add-friend-btn');
            const addFriendError = document.getElementById('add-friend-error');
            const addFriendErrorText = document.getElementById('add-friend-error-text');
            const addFriendSuccess = document.getElementById('add-friend-success');
            const addFriendSuccessText = document.getElementById('add-friend-success-text');
            const chatActions = document.getElementById('chat-actions');
            const deleteFriendBtn = document.getElementById('delete-friend-btn');
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            
            // 获取当前用户信息
            async function fetchCurrentUser() {
                try {
                    const response = await fetch('/user/detail', {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // 成功状态码
                        currentUser = data.data;
                        userNickname.textContent = currentUser.nickname || currentUser.account;
                        if (currentUser.avatar) {
                            userAvatar.src = currentUser.avatar;
                        }
                        
                        // 获取好友列表
                        fetchFriends();
                        
                        // 建立WebSocket连接
                        connectWebSocket();
                    } else {
                        // 获取用户信息失败，可能是token过期
                        localStorage.removeItem('token');
                        window.location.href = 'login.html';
                    }
                } catch (error) {
                    console.error('获取用户信息出错:', error);
                    alert('网络错误，请稍后重试');
                }
            }
            
            // 获取好友列表
            async function fetchFriends() {
                try {
                    // 调用后端API获取联系人列表
                    const response = await fetch('/user/chatlist', {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    // 清空好友列表
                    friendList.innerHTML = '';
                    
                    if (data.code === 111) { // 成功状态码
                        const chatlist = data.data.chatlist;
                        
                        // 处理联系人列表数据
                        friends = chatlist.map(contact => {
                            return {
                                nickname: contact.name,
                                room_id: contact.room_id,
                                type: contact.type, // 1私聊 2群聊
                                last_message: '',
                                avatar: 'https://avatars.githubusercontent.com/u/148515933?s=400&u=7cbff7c77a33416cabfe463fff24495157026760&v=4' // 默认头像
                            };
                        });
                        
                        // 渲染好友列表
                        renderFriendList(friends);
                    } else {
                        console.error('获取联系人列表失败:', data.msg);
                        friendList.innerHTML = '<div class="text-center text-gray-500 py-4">获取联系人列表失败，请刷新重试</div>';
                    }
                } catch (error) {
                    console.error('获取联系人列表出错:', error);
                    friendList.innerHTML = '<div class="text-center text-gray-500 py-4">网络错误，请稍后重试</div>';
                }
                
                // 如果好友列表为空，显示提示信息
                if (friends.length === 0) {
                    friendList.innerHTML = '<div class="text-center text-gray-500 py-4">暂无联系人，请添加好友</div>';
                }
            }
            
            // 建立WebSocket连接
            function connectWebSocket() {
                // 构建WebSocket URL，指向后端服务
                // 获取当前域名和端口
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.host;
                const wsUrl = `${protocol}//${host}/user/msg?token=${token}`;
                
                // 创建WebSocket连接
                socket = new WebSocket(wsUrl);
                
                // 连接打开事件
                socket.onopen = function(e) {
                    console.log('WebSocket连接已建立');
                };
                
                // 接收消息事件
                socket.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    console.log('收到消息:', message);
                    
                    // 如果当前正在查看的聊天室与消息的聊天室相同，则显示消息
                    if (currentRoomId === message.room_id) {
                        // 检查日期是否需要添加分隔线
                        const messageDate = new Date(message.created_at);
                        const messageDateStr = messageDate.toDateString();
                        
                        // 获取最后一个日期分隔线或消息的日期
                        let lastDateStr = null;
                        const dateElements = chatMessages.querySelectorAll('.date-separator');
                        if (dateElements.length > 0) {
                            const lastDateElement = dateElements[dateElements.length - 1];
                            lastDateStr = lastDateElement.getAttribute('data-date');
                        }
                        
                        // 如果日期不同，添加新的日期分隔线
                        if (!lastDateStr || messageDateStr !== lastDateStr) {
                            addDateSeparator(messageDate);
                        }
                        
                        // 添加消息到UI
                        appendMessage(message);
                        
                        // 添加消息到当前消息列表
                        currentRoomMessages.push(message);
                        
                        // 滚动到底部
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                    
                    // 更新好友列表中的最新消息
                    updateFriendLastMessage(message);
                };
                
                // 连接关闭事件
                socket.onclose = function(event) {
                    console.log('WebSocket连接已关闭');
                    // 可以在这里添加重连逻辑
                };
                
                // 连接错误事件
                socket.onerror = function(error) {
                    console.error('WebSocket错误:', error);
                };
            }
            
            // 更新好友列表中的最新消息
            function updateFriendLastMessage(message) {
                // 实际项目中应该更新好友列表中的最新消息
            }
            
            // 添加日期分隔线
            function addDateSeparator(date) {
                const dateStr = date.getFullYear() + '/' + 
                               String(date.getMonth() + 1).padStart(2, '0') + '/' + 
                               String(date.getDate()).padStart(2, '0');
                
                const separatorElement = document.createElement('div');
                separatorElement.className = 'flex justify-center my-4 date-separator';
                separatorElement.setAttribute('data-date', date.toDateString());
                separatorElement.innerHTML = `
                    <div class="px-4 py-1 bg-gray-100 rounded-full text-xs text-gray-500">
                        ${dateStr}
                    </div>
                `;
                
                chatMessages.appendChild(separatorElement);
            }
            
            // 聊天记录分页变量
            let currentPage = 1;
            let isLoadingMessages = false;
            let hasMoreMessages = true;
            let currentRoomMessages = [];
            
            // 加载聊天记录
            async function loadChatMessages(roomId, page = 1, pageSize = 20, append = false) {
                try {
                    // 如果正在加载或没有更多消息，则返回
                    if (isLoadingMessages || (page > 1 && !hasMoreMessages)) {
                        return;
                    }
                    
                    isLoadingMessages = true;
                    
                    // 如果是加载第一页，重置分页变量
                    if (page === 1 && !append) {
                        currentPage = 1;
                        hasMoreMessages = true;
                        currentRoomMessages = [];
                    }
                    
                    // 显示加载指示器
                    if (page > 1) {
                        const loadingIndicator = document.createElement('div');
                        loadingIndicator.id = 'loading-indicator';
                        loadingIndicator.className = 'flex justify-center my-4';
                        loadingIndicator.innerHTML = `
                            <div class="px-4 py-1 bg-gray-100 rounded-full text-xs text-gray-500 flex items-center">
                                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                加载更多消息...
                            </div>
                        `;
                        chatMessages.insertBefore(loadingIndicator, chatMessages.firstChild);
                    }
                    
                    const response = await fetch(`/user/history?room_id=${roomId}&page_index=${page}&page_size=${pageSize}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    // 移除加载指示器
                    const loadingIndicator = document.getElementById('loading-indicator');
                    if (loadingIndicator) {
                        loadingIndicator.remove();
                    }
                    
                    if (data.code === 111) { // 成功状态码
                        // 显示聊天记录
                        const messages = data.data.list;
                        
                        // 如果没有消息，且是第一页，显示暂无聊天记录
                        if (messages.length === 0 && page === 1 && !append) {
                            chatMessages.innerHTML = '<div class="flex justify-center my-4"><p class="text-gray-500">暂无聊天记录</p></div>';
                            hasMoreMessages = false;
                        } else if (messages.length === 0) {
                            // 如果是其他页且没有消息，说明没有更多消息了
                            hasMoreMessages = false;
                            
                            // 添加没有更多消息的提示
                            const noMoreMessagesIndicator = document.createElement('div');
                            noMoreMessagesIndicator.className = 'flex justify-center my-4';
                            noMoreMessagesIndicator.innerHTML = `
                                <div class="px-4 py-1 bg-gray-100 rounded-full text-xs text-gray-500">
                                    没有更多消息了
                                </div>
                            `;
                            chatMessages.insertBefore(noMoreMessagesIndicator, chatMessages.firstChild);
                        } else {
                            // 按时间顺序显示消息
                            messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                            
                            // 保存当前滚动位置和高度
                            const scrollPos = chatMessages.scrollTop;
                            const oldHeight = chatMessages.scrollHeight;
                            
                            // 合并消息到当前房间消息列表
                            if (page === 1 && !append) {
                                // 如果是第一页且不是追加模式，清空聊天消息区域
                                chatMessages.innerHTML = '';
                                currentRoomMessages = messages;
                            } else {
                                // 将新消息添加到数组开头
                                currentRoomMessages = [...messages, ...currentRoomMessages];
                            }
                            
                            // 重新渲染所有消息或追加新消息
                            if (page > 1 || append) {
                                // 如果是加载更多或追加模式
                                if (page > 1) {
                                    // 清空聊天区域
                                    chatMessages.innerHTML = '';
                                    
                                    // 重新渲染所有消息
                                    let currentDate = null;
                                    
                                    currentRoomMessages.forEach(msg => {
                                        const messageDate = new Date(msg.created_at);
                                        const messageDateStr = messageDate.toDateString();
                                        
                                        // 如果日期变化，添加日期分隔线
                                        if (!currentDate || messageDateStr !== currentDate) {
                                            currentDate = messageDateStr;
                                            addDateSeparator(messageDate);
                                        }
                                        
                                        // 直接传递MessageBasic对象，包含所有必要字段
                                        appendMessage(msg);
                                    });
                                    
                                    // 计算新增内容的高度，并调整滚动位置
                                    const newHeight = chatMessages.scrollHeight;
                                    chatMessages.scrollTop = scrollPos + (newHeight - oldHeight);
                                } else {
                                    // 如果是追加模式但不是加载更多，滚动到底部
                                    chatMessages.scrollTop = chatMessages.scrollHeight;
                                }
                            } else {
                                // 如果是第一页且不是追加模式，直接渲染
                                let currentDate = null;
                                
                                messages.forEach(msg => {
                                    const messageDate = new Date(msg.created_at);
                                    const messageDateStr = messageDate.toDateString();
                                    
                                    // 如果日期变化，添加日期分隔线
                                    if (!currentDate || messageDateStr !== currentDate) {
                                        currentDate = messageDateStr;
                                        addDateSeparator(messageDate);
                                    }
                                    
                                    // 直接传递MessageBasic对象，包含所有必要字段
                                    appendMessage(msg);
                                });
                                
                                // 滚动到底部
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                            }
                            
                            // 更新当前页码
                            currentPage = page;
                        }
                    } else {
                        console.error('获取聊天记录失败:', data.msg);
                    }
                } catch (error) {
                    console.error('获取聊天记录出错:', error);
                } finally {
                    isLoadingMessages = false;
                }
            }
            
            // 添加消息到聊天区域
            function appendMessage(message) {
                const isCurrentUser = message.user_id === currentUser.user_id;
                
                const messageElement = document.createElement('div');
                messageElement.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'} mb-4`;
                
                // 格式化发送时间，只精确到分钟
                const createdTime = new Date(message.created_at || new Date()).toLocaleTimeString([], { 
                    hour: '2-digit', minute: '2-digit' 
                });
                
                // 获取用户昵称
                const userName = isCurrentUser ? currentUser.nickname : (currentChatUser?.nickname || '用户');
                
                messageElement.innerHTML = `
                    <div class="${isCurrentUser ? 'order-1' : 'order-2'} flex-shrink-0">
                        <img src="${isCurrentUser ? (currentUser.avatar || 'https://via.placeholder.com/32') : (currentChatUser?.avatar || 'https://via.placeholder.com/32')}" alt="头像" class="w-8 h-8 rounded-full">
                    </div>
                    <div class="${isCurrentUser ? 'order-2' : 'order-1'} max-w-xs mx-2">
                        <div class="${isCurrentUser ? 'text-right' : 'text-left'} text-xs text-gray-600 mb-1">${userName}</div>
                        <div class="${isCurrentUser ? 'bg-indigo-500 text-white' : 'bg-gray-200 text-gray-800'} rounded-lg px-4 py-2 shadow">
                            <p>${message.data || message.message}</p>
                        </div>
                        <div class="text-xs text-gray-500 ${isCurrentUser ? 'text-right' : 'text-left'} mt-1">
                            <span>${createdTime}</span>
                        </div>
                    </div>
                `;
                
                chatMessages.appendChild(messageElement);
                
                // 滚动到底部
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // 添加滚动事件监听，上滑加载更多消息
            function setupScrollListener() {
                // 移除之前的事件监听器（如果有）
                chatMessages.removeEventListener('scroll', handleScroll);
                
                // 添加新的事件监听器
                chatMessages.addEventListener('scroll', handleScroll);
            }
            
            // 处理滚动事件
            function handleScroll() {
                // 如果滚动到顶部附近（距离顶部小于50像素），加载更多消息
                if (chatMessages.scrollTop < 50 && !isLoadingMessages && hasMoreMessages && currentRoomId) {
                    // 加载下一页消息
                    loadChatMessages(currentRoomId, currentPage + 1, 20, true);
                }
            }
            
            // 打开聊天
            function openChat(roomId, contact) {
                // 如果是同一个聊天，不重新加载
                if (currentRoomId === roomId) {
                    return;
                }
                
                currentRoomId = roomId;
                currentChatUser = contact;
                
                // 重置分页变量
                currentPage = 1;
                hasMoreMessages = true;
                currentRoomMessages = [];
                
                // 更新聊天标题，根据类型显示不同的标题
                const chatType = contact.type === 1 ? '私聊' : '群聊';
                chatTitle.innerHTML = `${contact.nickname} <span class="text-sm text-gray-500">(${chatType})</span>`;
                
                // 显示聊天输入区域
                chatInputArea.classList.remove('hidden');
                
                // 显示聊天操作区域，只有私聊才显示删除好友按钮
                chatActions.classList.remove('hidden');
                if (contact.type === 1) {
                    deleteFriendBtn.classList.remove('hidden');
                } else {
                    deleteFriendBtn.classList.add('hidden');
                }
                
                // 加载聊天记录
                loadChatMessages(roomId);
                
                // 设置滚动事件监听
                setupScrollListener();
            }
            
            // 搜索好友
            async function searchFriend(account) {
                try {
                    const response = await fetch(`/user/query?account=${account}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // 成功状态码
                        return data.data;
                    } else {
                        throw new Error(data.msg || '搜索好友失败');
                    }
                } catch (error) {
                    console.error('搜索好友出错:', error);
                    throw error;
                }
            }
            
            // 添加好友
            async function addFriend(account) {
                try {
                    const formData = new FormData();
                    formData.append('account', account);
                    
                    const response = await fetch('/user/add', {
                        method: 'POST',
                        headers: {
                            'Authorization': token
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // 成功状态码
                        return data.data;
                    } else {
                        throw new Error(data.msg || '添加好友失败');
                    }
                } catch (error) {
                    console.error('添加好友出错:', error);
                    throw error;
                }
            }
            
            // 删除好友
            async function deleteFriend(roomId) {
                try {
                    // 从当前好友列表中找到对应的好友信息
                    const friend = friends.find(f => f.room_id === roomId);
                    if (!friend) {
                        throw new Error('找不到该好友信息');
                    }
                    
                    // 构建请求参数
                    const formData = new FormData();
                    formData.append('room_id', roomId);
                    
                    const response = await fetch('/user/delete', {
                        method: 'DELETE',
                        headers: {
                            'Authorization': token
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // 成功状态码
                        return true;
                    } else {
                        throw new Error(data.msg || '删除好友失败');
                    }
                } catch (error) {
                    console.error('删除好友出错:', error);
                    throw error;
                }
            }
            
            // 事件监听
            
            // 退出登录
            logoutBtn.addEventListener('click', function() {
                // 关闭WebSocket连接
                if (socket) {
                    socket.close();
                }
                
                // 清除本地存储的token
                localStorage.removeItem('token');
                
                // 跳转到登录页面
                window.location.href = 'login.html';
            });
            
            // 发送消息
            messageForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const message = messageInput.value.trim();
                if (!message) return;
                
                if (!currentRoomId) {
                    alert('请先选择一个聊天');
                    return;
                }
                
                // 获取当前日期
                const now = new Date();
                const todayStr = now.toDateString();
                
                // 检查是否需要添加日期分隔线
                let lastDateStr = null;
                const dateElements = chatMessages.querySelectorAll('.date-separator');
                if (dateElements.length > 0) {
                    const lastDateElement = dateElements[dateElements.length - 1];
                    lastDateStr = lastDateElement.getAttribute('data-date');
                }
                
                // 如果日期不同或没有日期分隔线，添加新的日期分隔线
                if (!lastDateStr || todayStr !== lastDateStr) {
                    addDateSeparator(now);
                }
                
                // 构建消息对象，使用data字段匹配MessageBasic结构
                const messageObj = {
                    user_id: currentUser.user_id,
                    room_id: currentRoomId,
                    data: message,
                    created_at: now.toISOString() // 添加创建时间
                };
                
                // 发送消息
                socket.send(JSON.stringify(messageObj));
                
                // 添加消息到当前消息列表（本地显示，不等待服务器响应）
                // 注意：服务器响应后会通过WebSocket再次收到这条消息，但由于已经添加过，不会重复显示
                currentRoomMessages.push(messageObj);
                
                // 清空输入框
                messageInput.value = '';
            });
            
            // 打开添加好友模态框
            addFriendBtn.addEventListener('click', function() {
                // 重置表单
                addFriendForm.reset();
                searchResult.classList.add('hidden');
                confirmAddFriendBtn.classList.add('hidden');
                addFriendError.classList.add('hidden');
                addFriendSuccess.classList.add('hidden');
                
                // 显示模态框
                addFriendModal.classList.remove('hidden');
            });
            
            // 关闭添加好友模态框
            closeAddFriendModal.addEventListener('click', function() {
                addFriendModal.classList.add('hidden');
            });
            
            // 点击模态框外部关闭模态框
            addFriendModal.addEventListener('click', function(e) {
                if (e.target === addFriendModal) {
                    addFriendModal.classList.add('hidden');
                }
            });
            
            // 搜索好友
            searchFriendBtn.addEventListener('click', async function() {
                const account = friendAccount.value.trim();
                if (!account) {
                    addFriendErrorText.textContent = '请输入好友账号';
                    addFriendError.classList.remove('hidden');
                    addFriendSuccess.classList.add('hidden');
                    return;
                }
                
                try {
                    const user = await searchFriend(account);
                    
                    // 显示搜索结果
                    resultNickname.textContent = user.nickname || user.account;
                    resultAccount.textContent = user.account;
                    if (user.avatar) {
                        resultAvatar.src = user.avatar;
                    }
                    
                    searchResult.classList.remove('hidden');
                    
                    // 如果已经是好友，不显示添加按钮
                    if (user.is_friend) {
                        addFriendErrorText.textContent = '该用户已经是您的好友';
                        addFriendError.classList.remove('hidden');
                        addFriendSuccess.classList.add('hidden');
                        confirmAddFriendBtn.classList.add('hidden');
                    } else {
                        addFriendError.classList.add('hidden');
                        addFriendSuccess.classList.add('hidden');
                        confirmAddFriendBtn.classList.remove('hidden');
                        
                        // 存储搜索到的用户信息
                        confirmAddFriendBtn.dataset.account = user.account;
                    }
                } catch (error) {
                    addFriendErrorText.textContent = error.message || '搜索好友失败';
                    addFriendError.classList.remove('hidden');
                    addFriendSuccess.classList.add('hidden');
                    searchResult.classList.add('hidden');
                    confirmAddFriendBtn.classList.add('hidden');
                }
            });
            
            // 确认添加好友
            confirmAddFriendBtn.addEventListener('click', async function() {
                const account = confirmAddFriendBtn.dataset.account;
                if (!account) return;
                
                try {
                    await addFriend(account);
                    
                    // 显示成功信息
                    addFriendSuccessText.textContent = '添加好友成功';
                    addFriendSuccess.classList.remove('hidden');
                    addFriendError.classList.add('hidden');
                    
                    // 重新获取好友列表
                    fetchFriends();
                    
                    // 3秒后关闭模态框
                    setTimeout(() => {
                        addFriendModal.classList.add('hidden');
                    }, 3000);
                } catch (error) {
                    addFriendErrorText.textContent = error.message || '添加好友失败';
                    addFriendError.classList.remove('hidden');
                    addFriendSuccess.classList.add('hidden');
                }
            });
            
            // 删除好友
            deleteFriendBtn.addEventListener('click', async function() {
                if (!currentChatUser || !currentRoomId) return;
                
                // 只有私聊才能删除好友
                if (currentChatUser.type !== 1) {
                    alert('只能删除私聊联系人');
                    return;
                }
                
                if (confirm(`确定要删除好友 ${currentChatUser.nickname} 吗？`)) {
                    try {
                        await deleteFriend(currentRoomId);
                        
                        // 重新获取好友列表
                        fetchFriends();
                        
                        // 重置聊天区域
                        currentRoomId = null;
                        currentChatUser = null;
                        chatTitle.textContent = '请选择一个聊天';
                        chatMessages.innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-gray-500">选择一个联系人开始聊天</p></div>';
                        chatInputArea.classList.add('hidden');
                        chatActions.classList.add('hidden');
                        
                        alert('删除好友成功');
                    } catch (error) {
                        alert(error.message || '删除好友失败');
                    }
                }
            });
            
            // 搜索联系人（本地搜索）
            searchBtn.addEventListener('click', function() {
                const keyword = searchInput.value.trim().toLowerCase();
                if (!keyword) {
                    // 显示所有联系人
                    renderFriendList(friends);
                    return;
                }
                
                // 过滤联系人列表
                const filteredFriends = friends.filter(friend => {
                    return friend.nickname.toLowerCase().includes(keyword);
                });
                
                // 更新联系人列表
                renderFriendList(filteredFriends);
            });
            
            // 搜索框回车事件
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    searchBtn.click();
                }
            });
            
            // 搜索框清空事件
            searchInput.addEventListener('input', function() {
                if (this.value.trim() === '') {
                    renderFriendList(friends);
                }
            });
            
            // 渲染好友列表
            function renderFriendList(friendsList) {
                // 清空好友列表
                friendList.innerHTML = '';
                
                if (friendsList.length === 0) {
                    friendList.innerHTML = '<div class="text-center text-gray-500 py-4">未找到匹配的联系人</div>';
                    return;
                }
                
                // 渲染好友列表
                friendsList.forEach(friend => {
                    const friendElement = document.createElement('div');
                    friendElement.className = 'p-2 hover:bg-gray-100 rounded-md cursor-pointer';
                    friendElement.dataset.roomId = friend.room_id;
                    friendElement.dataset.type = friend.type;
                    
                    // 根据类型显示不同的图标
                    const typeIcon = friend.type === 1 ? 
                        '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>' : 
                        '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" /></svg>';
                    
                    friendElement.innerHTML = `
                        <div class="flex items-center">
                            <img src="${friend.avatar || 'https://via.placeholder.com/40'}" alt="头像" class="w-10 h-10 rounded-full mr-3">
                            <div class="flex-1">
                                <div class="flex items-center">
                                    <p class="font-medium">${friend.nickname}</p>
                                    <span class="ml-2" title="${friend.type === 1 ? '私聊' : '群聊'}">${typeIcon}</span>
                                </div>
                                <p class="text-sm text-gray-500 truncate">${friend.last_message || ''}</p>
                            </div>
                        </div>
                    `;
                    
                    // 点击联系人打开聊天
                    friendElement.addEventListener('click', function() {
                        openChat(friend.room_id, friend);
                    });
                    
                    friendList.appendChild(friendElement);
                });
            }
            
            // 初始化
            fetchCurrentUser();
        });
    </script>
</body>
</html>