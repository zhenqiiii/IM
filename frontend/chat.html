<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤© - DINGDANG</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-50 to-gray-100 h-screen flex flex-col">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="bg-white/90 backdrop-blur-lg border-b border-gray-200/60 text-gray-800 px-4 py-3 shadow-lg">
        <div class="w-full max-w-none flex items-center justify-between h-16">
            <!-- å·¦ä¾§æ ‡é¢˜ - ç»å¯¹å·¦å¯¹é½ -->
            <div class="flex items-center flex-shrink-0">
                <h1 class="text-3xl lg:text-4xl font-black bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 bg-clip-text text-transparent tracking-widest drop-shadow-sm">
                    DINGDANG
                </h1>
            </div>
            
            <!-- å³ä¾§ç”¨æˆ·ä¿¡æ¯ - ç»å¯¹å³å¯¹é½ -->
            <div class="flex items-center justify-end flex-shrink-0">
                <!-- ç”¨æˆ·æ˜µç§° - å“åº”å¼æ˜¾ç¤º -->
                <span id="user-nickname" class="text-sm lg:text-base text-gray-700 font-medium mr-3 lg:mr-4 hidden md:block truncate max-w-32 lg:max-w-48">åŠ è½½ä¸­...</span>
                
                <!-- å¤´åƒ - å“åº”å¼å°ºå¯¸ -->
                <img id="user-avatar" src="https://avatars.githubusercontent.com/u/148515933?s=400&u=7cbff7c77a33416cabfe463fff24495157026760&v=4" alt="å¤´åƒ" class="w-10 h-10 lg:w-12 lg:h-12 rounded-full ring-2 ring-white shadow-md mr-3 lg:mr-4">
                
                <!-- ç”¨æˆ·ä¸­å¿ƒæŒ‰é’® - å“åº”å¼è®¾è®¡ -->
                <button id="user-center-btn" class="bg-gray-900 hover:bg-gray-800 active:bg-gray-700 text-white font-medium rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 active:scale-95">
                    <span class="hidden sm:inline px-6 py-4 lg:px-7 lg:py-4 text-sm lg:text-base">ç”¨æˆ·ä¸­å¿ƒ</span>
                    <span class="sm:hidden px-5 py-4 text-xs">ä¸­å¿ƒ</span>
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="flex-1 flex overflow-hidden">
        <!-- å·¦ä¾§è”ç³»äººåˆ—è¡¨ -->
        <div class="w-1/4 bg-white/70 backdrop-blur-sm border-r border-gray-200/60 flex flex-col">
            <div class="p-5 border-b border-gray-200/60">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="æœç´¢è”ç³»äºº" class="w-full px-4 py-3 border border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-900/20 focus:border-gray-400 bg-gray-50/50 text-sm transition-all duration-200">
                    <button id="search-btn" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-3" id="friend-list">
                <!-- è”ç³»äººåˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                <div class="text-center text-gray-400 py-8 text-sm">åŠ è½½è”ç³»äººåˆ—è¡¨ä¸­...</div>
            </div>
            
            <div class="p-4 border-t border-gray-200/60">
                <button id="add-friend-btn" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-xl shadow-sm text-sm font-medium text-white bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900/50 transition-all duration-200 hover:shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    æ·»åŠ è”ç³»äºº
                </button>
            </div>
        </div>
        
        <!-- å³ä¾§èŠå¤©åŒºåŸŸ -->
        <div class="flex-1 flex flex-col">
            <!-- èŠå¤©å¤´éƒ¨ -->
            <div class="p-5 border-b border-gray-200/60 bg-white/80 backdrop-blur-sm shadow-sm flex justify-between items-center">
                <h2 id="chat-title" class="text-lg font-semibold text-gray-800">è¯·é€‰æ‹©ä¸€ä¸ªèŠå¤©</h2>
                <div id="chat-actions" class="hidden">
                    <button id="view-profile-btn" class="text-sm text-gray-600 hover:text-gray-900 bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-lg transition-all duration-200">
                        æŸ¥çœ‹èµ„æ–™
                    </button>
                </div>
            </div>
            
            <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-6 bg-gradient-to-b from-gray-50/50 to-white/50">
                <div class="flex items-center justify-center h-full">
                    <div class="text-center">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gray-200 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                            </svg>
                        </div>
                        <p class="text-gray-400 text-sm">é€‰æ‹©ä¸€ä¸ªè”ç³»äººå¼€å§‹èŠå¤©</p>
                    </div>
                </div>
            </div>
            
            <!-- èŠå¤©è¾“å…¥åŒºåŸŸ -->
            <div id="chat-input-area" class="p-5 border-t border-gray-200/60 bg-white/80 backdrop-blur-sm hidden">
                <!-- è¡¨æƒ…é€‰æ‹©å™¨ -->
                <div id="emoji-picker" class="hidden absolute bottom-24 left-6 w-80 p-4 border border-gray-200/60 rounded-2xl bg-white/95 backdrop-blur-md shadow-xl max-h-48 overflow-y-auto z-10">
                    <div class="grid grid-cols-8 gap-2">
                        <!-- è¡¨æƒ…å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- æ–‡ä»¶é€‰æ‹©å™¨ -->
                <input type="file" id="file-input" class="hidden" accept="*/*">
                <input type="file" id="image-input" class="hidden" accept="image/*">
                
                <div class="relative">
                    <!-- è¾“å…¥æ¡†å®¹å™¨ -->
                    <div class="bg-gray-50/80 rounded-2xl border border-gray-200/60 p-3 flex items-center space-x-3">
                        <!-- å·¦ä¾§åŠŸèƒ½æŒ‰é’® -->
                        <div class="flex space-x-2 flex-shrink-0">
                            <button type="button" id="emoji-btn" class="w-9 h-9 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-white/80 rounded-xl transition-all duration-200 text-lg">
                                ğŸ˜Š
                            </button>
                            <button type="button" id="image-btn" class="w-9 h-9 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-white/80 rounded-xl transition-all duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </button>
                            <button type="button" id="file-btn" class="w-9 h-9 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-white/80 rounded-xl transition-all duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                                </svg>
                            </button>
                        </div>
                        
                        <!-- ä¸»è¾“å…¥åŒºåŸŸ -->
                        <form id="message-form" class="flex-1 flex items-center space-x-3 min-h-[2.5rem]">
                            <textarea id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." class="flex-1 resize-none border-none outline-none bg-transparent text-sm placeholder-gray-400 max-h-20 min-h-[2.5rem] py-2 leading-relaxed" rows="1"></textarea>
                            
                            <!-- å‘é€æŒ‰é’® -->
                            <button type="submit" class="w-10 h-10 bg-gray-900 hover:bg-gray-800 text-white rounded-xl flex items-center justify-center transition-all duration-200 hover:shadow-md flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                </svg>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å¥½å‹æ¨¡æ€æ¡† -->
    <div id="add-friend-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center hidden z-50">
        <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-8 w-full max-w-md border border-gray-200/50">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-900">æ·»åŠ å¥½å‹</h3>
                <button id="close-add-friend-modal" class="text-gray-400 hover:text-gray-600 p-1 rounded-lg hover:bg-gray-100 transition-all duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div id="add-friend-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl relative mb-4">
                <span id="add-friend-error-text"></span>
            </div>
            
            <div id="add-friend-success" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-xl relative mb-4">
                <span id="add-friend-success-text"></span>
            </div>
            
            <form id="add-friend-form">
                <div class="mb-6">
                    <label for="friend-account" class="block text-sm font-medium text-gray-700 mb-2">å¥½å‹è´¦å·</label>
                    <input type="text" id="friend-account" class="w-full px-4 py-3 border border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-900/20 focus:border-gray-400 bg-gray-50/50 transition-all duration-200">
                </div>
                
                <div id="search-result" class="mb-6 hidden">
                    <div class="p-4 border border-gray-200 rounded-xl bg-gray-50/50">
                        <div class="flex items-center">
                            <img id="result-avatar" src="https://via.placeholder.com/40" alt="å¤´åƒ" class="w-12 h-12 rounded-full mr-4 ring-2 ring-white shadow-sm">
                            <div>
                                <p id="result-nickname" class="font-medium text-gray-900"></p>
                                <p id="result-account" class="text-sm text-gray-500"></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="search-friend-btn" class="px-6 py-3 border border-gray-200 rounded-xl shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900/20 transition-all duration-200">
                        æœç´¢
                    </button>
                    <button type="button" id="confirm-add-friend-btn" class="px-6 py-3 border border-transparent rounded-xl shadow-sm text-sm font-medium text-white bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900/50 transition-all duration-200 hover:shadow-md hidden">
                        æ·»åŠ 
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            const token = localStorage.getItem('token');
            if (!token) {
                // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
                window.location.href = 'login.html';
                return;
            }
            
            // å…¨å±€å˜é‡
            let currentUser = null;
            let currentRoomId = null;
            let currentChatUser = null;
            let socket = null;
            let friends = [];
            
            // DOMå…ƒç´ ç¼“å­˜
            const elements = {
                // ç”¨æˆ·ç›¸å…³
                userNickname: document.getElementById('user-nickname'),
                userAvatar: document.getElementById('user-avatar'),
                userCenterBtn: document.getElementById('user-center-btn'),
                logoutBtn: document.getElementById('logout-btn'),
                
                // èŠå¤©ç›¸å…³
                friendList: document.getElementById('friend-list'),
                chatTitle: document.getElementById('chat-title'),
                chatMessages: document.getElementById('chat-messages'),
                chatInputArea: document.getElementById('chat-input-area'),
                messageForm: document.getElementById('message-form'),
                messageInput: document.getElementById('message-input'),
                chatActions: document.getElementById('chat-actions'),
                viewProfileBtn: document.getElementById('view-profile-btn'),
                
                // æœç´¢ç›¸å…³
                searchInput: document.getElementById('search-input'),
                searchBtn: document.getElementById('search-btn'),
                
                // æ·»åŠ å¥½å‹ç›¸å…³
                addFriendBtn: document.getElementById('add-friend-btn'),
                addFriendModal: document.getElementById('add-friend-modal'),
                closeAddFriendModal: document.getElementById('close-add-friend-modal'),
                addFriendForm: document.getElementById('add-friend-form'),
                friendAccount: document.getElementById('friend-account'),
                searchFriendBtn: document.getElementById('search-friend-btn'),
                searchResult: document.getElementById('search-result'),
                resultAvatar: document.getElementById('result-avatar'),
                resultNickname: document.getElementById('result-nickname'),
                resultAccount: document.getElementById('result-account'),
                confirmAddFriendBtn: document.getElementById('confirm-add-friend-btn'),
                addFriendError: document.getElementById('add-friend-error'),
                addFriendErrorText: document.getElementById('add-friend-error-text'),
                addFriendSuccess: document.getElementById('add-friend-success'),
                addFriendSuccessText: document.getElementById('add-friend-success-text'),
                
                // ç”¨æˆ·ä¸­å¿ƒç›¸å…³
                userCenterModal: document.getElementById('user-center-modal'),
                userCenterPanel: document.getElementById('user-center-panel'),
                userCenterBackdrop: document.getElementById('user-center-backdrop'),
                closeUserCenterBtn: document.getElementById('close-user-center-btn'),
                profileAvatar: document.getElementById('profile-avatar'),
                profileNickname: document.getElementById('profile-nickname'),
                profileAccount: document.getElementById('profile-account'),
                profileEmail: document.getElementById('profile-email'),
                profileNicknameDisplay: document.getElementById('profile-nickname-display'),
                profileAccountDisplay: document.getElementById('profile-account-display'),
                profileEmailDisplay: document.getElementById('profile-email-display'),
                profileViewMode: document.getElementById('profile-view-mode'),
                profileForm: document.getElementById('profile-form'),
                editProfileBtn: document.getElementById('edit-profile-btn'),
                cancelEditBtn: document.getElementById('cancel-edit-btn'),
                changePasswordBtn: document.getElementById('change-password-btn'),
                
                // æŸ¥çœ‹èµ„æ–™ç›¸å…³
                profileModal: document.getElementById('profile-modal'),
                profilePanel: document.getElementById('profile-panel'),
                profileBackdrop: document.getElementById('profile-backdrop'),
                closeProfileBtn: document.getElementById('close-profile-btn'),
                friendProfileAvatar: document.getElementById('friend-profile-avatar'),
                friendProfileNickname: document.getElementById('friend-profile-nickname'),
                friendProfileAccount: document.getElementById('friend-profile-account'),
                friendProfileEmail: document.getElementById('friend-profile-email'),
                deleteFriendBtn: document.getElementById('delete-friend-btn'),
                
                // æ¶ˆæ¯è¾“å…¥ç›¸å…³
                emojiBtn: document.getElementById('emoji-btn'),
                emojiPicker: document.getElementById('emoji-picker'),
                imageBtn: document.getElementById('image-btn'),
                fileBtn: document.getElementById('file-btn'),
                imageInput: document.getElementById('image-input'),
                fileInput: document.getElementById('file-input')
            };
            
            // è¡¨æƒ…æ•°æ®
            const emojis = [
                'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£',
                'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°',
                'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ',
                'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜',
                'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£',
                'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ',
                'ğŸ˜¡', 'ğŸ¤¬', 'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨',
                'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—', 'ğŸ¤”', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤¥',
                'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¬', 'ğŸ™„', 'ğŸ˜¯', 'ğŸ˜¦', 'ğŸ˜§',
                'ğŸ˜®', 'ğŸ˜²', 'ğŸ¥±', 'ğŸ˜´', 'ğŸ¤¤', 'ğŸ˜ª', 'ğŸ˜µ', 'ğŸ¤',
                'ğŸ¥´', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤‘',
                'ğŸ¤ ', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ¤¡', 'ğŸ’©', 'ğŸ‘»',
                'ğŸ’€', 'â˜ ï¸', 'ğŸ‘½', 'ğŸ‘¾', 'ğŸ¤–', 'ğŸƒ', 'ğŸ˜º', 'ğŸ˜¸',
                'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿', 'ğŸ˜¾', 'â¤ï¸',
                'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤',
                'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜',
                'ğŸ’', 'ğŸ’Ÿ', 'ğŸ‘', 'ğŸ‘', 'ğŸ‘Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤',
                'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ–•', 'ğŸ‘‡',
                'â˜ï¸', 'ğŸ‘‹', 'ğŸ¤š', 'ğŸ–ï¸', 'âœ‹', 'ğŸ––', 'ğŸ‘', 'ğŸ™Œ'
            ];
            
            // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
            async function fetchCurrentUser() {
                try {
                    const response = await fetch('/user/detail', {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // æˆåŠŸçŠ¶æ€ç 
                        currentUser = data.data;
                        elements.userNickname.textContent = currentUser.nickname || currentUser.account;
                        if (currentUser.avatar) {
                            elements.userAvatar.src = currentUser.avatar;
                        }
                        
                        // è·å–å¥½å‹åˆ—è¡¨
                        fetchFriends();
                        
                        // å»ºç«‹WebSocketè¿æ¥
                        connectWebSocket();
                    } else {
                        // è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œå¯èƒ½æ˜¯tokenè¿‡æœŸ
                        localStorage.removeItem('token');
                        window.location.href = 'login.html';
                    }
                } catch (error) {
                    console.error('è·å–ç”¨æˆ·ä¿¡æ¯å‡ºé”™:', error);
                    alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                }
            }
            
            // è·å–å¥½å‹åˆ—è¡¨
            async function fetchFriends() {
                try {
                    // è°ƒç”¨åç«¯APIè·å–è”ç³»äººåˆ—è¡¨
                    const response = await fetch('/user/chatlist', {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    // æ¸…ç©ºå¥½å‹åˆ—è¡¨
                    elements.friendList.innerHTML = '';
                    
                    if (data.code === 111) { // æˆåŠŸçŠ¶æ€ç 
                        const chatlist = data.data.chatlist;
                        
                        // å¤„ç†è”ç³»äººåˆ—è¡¨æ•°æ®
                        friends = chatlist.map(contact => {
                            return {
                                nickname: contact.name,
                                account: contact.account, // ç”¨æˆ·è´¦å·ï¼Œç”¨äºæŸ¥è¯¢è¯¦ç»†ä¿¡æ¯
                                room_id: contact.room_id,
                                type: contact.type, // 1ç§èŠ 2ç¾¤èŠ
                                last_message: '',
                                last_message_type: 'text', // æœ€æ–°æ¶ˆæ¯ç±»å‹
                                avatar: 'https://avatars.githubusercontent.com/u/148515933?s=400&u=7cbff7c77a33416cabfe463fff24495157026760&v=4', // é»˜è®¤å¤´åƒ
                                has_new_message: false, // æ˜¯å¦æœ‰æ–°æ¶ˆæ¯
                                new_message_count: 0 // æ–°æ¶ˆæ¯æ•°é‡
                            };
                        });
                        
                        // æ¸²æŸ“å¥½å‹åˆ—è¡¨
                        renderFriendList(friends);
                    } else {
                        console.error('è·å–è”ç³»äººåˆ—è¡¨å¤±è´¥:', data.msg);
                        elements.friendList.innerHTML = '<div class="text-center text-gray-500 py-4">è·å–è”ç³»äººåˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
                    }
                } catch (error) {
                    console.error('è·å–è”ç³»äººåˆ—è¡¨å‡ºé”™:', error);
                    elements.friendList.innerHTML = '<div class="text-center text-gray-500 py-4">ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</div>';
                }
                
                // å¦‚æœå¥½å‹åˆ—è¡¨ä¸ºç©ºï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                if (friends.length === 0) {
                    elements.friendList.innerHTML = '<div class="text-center text-gray-500 py-4">æš‚æ— è”ç³»äººï¼Œè¯·æ·»åŠ å¥½å‹</div>';
                }
            }
            
            // å»ºç«‹WebSocketè¿æ¥
            function connectWebSocket() {
                // æ„å»ºWebSocket URLï¼ŒæŒ‡å‘åç«¯æœåŠ¡
                // è·å–å½“å‰åŸŸåå’Œç«¯å£
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.host;
                const wsUrl = `${protocol}//${host}/user/msg?token=${token}`;
                
                // åˆ›å»ºWebSocketè¿æ¥
                socket = new WebSocket(wsUrl);
                
                // è¿æ¥æ‰“å¼€äº‹ä»¶
                socket.onopen = function(e) {
                    console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                };
                
                // æ¥æ”¶æ¶ˆæ¯äº‹ä»¶
                socket.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    console.log('æ”¶åˆ°æ¶ˆæ¯:', message);
                    
                    // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹çš„èŠå¤©å®¤ä¸æ¶ˆæ¯çš„èŠå¤©å®¤ç›¸åŒï¼Œåˆ™æ˜¾ç¤ºæ¶ˆæ¯
                    if (currentRoomId === message.room_id) {
                        // æ£€æŸ¥æ—¥æœŸæ˜¯å¦éœ€è¦æ·»åŠ åˆ†éš”çº¿
                        const messageDate = new Date(message.created_at);
                        const messageDateStr = messageDate.toDateString();
                        
                        // è·å–æœ€åä¸€ä¸ªæ—¥æœŸåˆ†éš”çº¿æˆ–æ¶ˆæ¯çš„æ—¥æœŸ
                        let lastDateStr = null;
                        const dateElements = chatMessages.querySelectorAll('.date-separator');
                        if (dateElements.length > 0) {
                            const lastDateElement = dateElements[dateElements.length - 1];
                            lastDateStr = lastDateElement.getAttribute('data-date');
                        }
                        
                        // å¦‚æœæ—¥æœŸä¸åŒï¼Œæ·»åŠ æ–°çš„æ—¥æœŸåˆ†éš”çº¿
                        if (!lastDateStr || messageDateStr !== lastDateStr) {
                            addDateSeparator(messageDate);
                        }
                        
                        // æ·»åŠ æ¶ˆæ¯åˆ°UI
                        appendMessage(message);
                        
                        // æ·»åŠ æ¶ˆæ¯åˆ°å½“å‰æ¶ˆæ¯åˆ—è¡¨
                        currentRoomMessages.push(message);
                        
                        // æ»šåŠ¨åˆ°åº•éƒ¨
                        elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
                    }
                    
                    // æ›´æ–°å¥½å‹åˆ—è¡¨ä¸­çš„æœ€æ–°æ¶ˆæ¯
                    updateFriendLastMessage(message);
                };
                
                // è¿æ¥å…³é—­äº‹ä»¶
                socket.onclose = function(event) {
                    console.log('WebSocketè¿æ¥å·²å…³é—­');
                    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é‡è¿é€»è¾‘
                };
                
                // è¿æ¥é”™è¯¯äº‹ä»¶
                socket.onerror = function(error) {
                    console.error('WebSocketé”™è¯¯:', error);
                };
            }
            
            // æ›´æ–°å¥½å‹åˆ—è¡¨ä¸­çš„æœ€æ–°æ¶ˆæ¯
            function updateFriendLastMessage(message) {
                // æŸ¥æ‰¾å¯¹åº”çš„å¥½å‹
                const friendIndex = friends.findIndex(f => f.room_id === message.room_id);
                if (friendIndex !== -1) {
                    // æ ¹æ®æ¶ˆæ¯ç±»å‹è®¾ç½®æ˜¾ç¤ºå†…å®¹
                    let displayMessage = '';
                    const messageType = message.type || 'text';
                    
                    switch (messageType) {
                        case 'emoji':
                            displayMessage = message.data || message.message;
                            break;
                        case 'image':
                            displayMessage = '[å›¾ç‰‡]';
                            break;
                        case 'file':
                            displayMessage = '[æ–‡ä»¶]';
                            break;
                        case 'video':
                            displayMessage = '[è§†é¢‘]';
                            break;
                        case 'speech':
                            displayMessage = '[è¯­éŸ³]';
                            break;
                        case 'text':
                        default:
                            displayMessage = message.data || message.message;
                            break;
                    }
                    
                    // æ›´æ–°æœ€æ–°æ¶ˆæ¯
                    friends[friendIndex].last_message = displayMessage;
                    friends[friendIndex].last_message_type = messageType;
                    
                    // å¦‚æœä¸æ˜¯å½“å‰èŠå¤©å®¤çš„æ¶ˆæ¯ï¼Œæ ‡è®°ä¸ºæœ‰æ–°æ¶ˆæ¯
                    if (message.room_id !== currentRoomId) {
                        friends[friendIndex].has_new_message = true;
                        friends[friendIndex].new_message_count = (friends[friendIndex].new_message_count || 0) + 1;
                    }
                    
                    // é‡æ–°æ¸²æŸ“å¥½å‹åˆ—è¡¨
                    renderFriendList(friends);
                }
            }
            
            // æ·»åŠ æ—¥æœŸåˆ†éš”çº¿
            function addDateSeparator(date) {
                const dateStr = date.getFullYear() + '/' + 
                               String(date.getMonth() + 1).padStart(2, '0') + '/' + 
                               String(date.getDate()).padStart(2, '0');
                
                const separatorElement = document.createElement('div');
                separatorElement.className = 'flex justify-center my-4 date-separator';
                separatorElement.setAttribute('data-date', date.toDateString());
                separatorElement.innerHTML = `
                    <div class="px-4 py-1 bg-gray-100 rounded-full text-xs text-gray-500">
                        ${dateStr}
                    </div>
                `;
                
                elements.chatMessages.appendChild(separatorElement);
            }
            
            // èŠå¤©è®°å½•åˆ†é¡µå˜é‡
            let currentPage = 1;
            let isLoadingMessages = false;
            let hasMoreMessages = true;
            let currentRoomMessages = [];
            
            // åŠ è½½èŠå¤©è®°å½•
            async function loadChatMessages(roomId, page = 1, pageSize = 20, append = false) {
                try {
                    // å¦‚æœæ­£åœ¨åŠ è½½æˆ–æ²¡æœ‰æ›´å¤šæ¶ˆæ¯ï¼Œåˆ™è¿”å›
                    if (isLoadingMessages || (page > 1 && !hasMoreMessages)) {
                        return;
                    }
                    
                    isLoadingMessages = true;
                    
                    // å¦‚æœæ˜¯åŠ è½½ç¬¬ä¸€é¡µï¼Œé‡ç½®åˆ†é¡µå˜é‡
                    if (page === 1 && !append) {
                        currentPage = 1;
                        hasMoreMessages = true;
                        currentRoomMessages = [];
                    }
                    
                    // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                    if (page > 1) {
                        const loadingIndicator = document.createElement('div');
                        loadingIndicator.id = 'loading-indicator';
                        loadingIndicator.className = 'flex justify-center my-4';
                        loadingIndicator.innerHTML = `
                            <div class="px-4 py-1 bg-gray-100 rounded-full text-xs text-gray-500 flex items-center">
                                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                åŠ è½½æ›´å¤šæ¶ˆæ¯...
                            </div>
                        `;
                        elements.chatMessages.insertBefore(loadingIndicator, elements.chatMessages.firstChild);
                    }
                    
                    const response = await fetch(`/user/history?room_id=${roomId}&page_index=${page}&page_size=${pageSize}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                    const loadingIndicator = document.getElementById('loading-indicator');
                    if (loadingIndicator) {
                        loadingIndicator.remove();
                    }
                    
                    if (data.code === 111) { // æˆåŠŸçŠ¶æ€ç 
                        // æ˜¾ç¤ºèŠå¤©è®°å½•
                        const messages = data.data.list;
                        
                        // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œä¸”æ˜¯ç¬¬ä¸€é¡µï¼Œæ˜¾ç¤ºæš‚æ— èŠå¤©è®°å½•
                        if (messages.length === 0 && page === 1 && !append) {
                            elements.chatMessages.innerHTML = '<div class="flex justify-center my-4"><p class="text-gray-500">æš‚æ— èŠå¤©è®°å½•</p></div>';
                            hasMoreMessages = false;
                        } else if (messages.length === 0) {
                            // å¦‚æœæ˜¯å…¶ä»–é¡µä¸”æ²¡æœ‰æ¶ˆæ¯ï¼Œè¯´æ˜æ²¡æœ‰æ›´å¤šæ¶ˆæ¯äº†
                            hasMoreMessages = false;
                            
                            // æ·»åŠ æ²¡æœ‰æ›´å¤šæ¶ˆæ¯çš„æç¤º
                            const noMoreMessagesIndicator = document.createElement('div');
                            noMoreMessagesIndicator.className = 'flex justify-center my-4';
                            noMoreMessagesIndicator.innerHTML = `
                                <div class="px-4 py-1 bg-gray-100 rounded-full text-xs text-gray-500">
                                    æ²¡æœ‰æ›´å¤šæ¶ˆæ¯äº†
                                </div>
                            `;
                            elements.chatMessages.insertBefore(noMoreMessagesIndicator, elements.chatMessages.firstChild);
                        } else {
                            // æŒ‰æ—¶é—´é¡ºåºæ˜¾ç¤ºæ¶ˆæ¯
                            messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                            
                            // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®å’Œé«˜åº¦
                            const scrollPos = elements.chatMessages.scrollTop;
                            const oldHeight = elements.chatMessages.scrollHeight;
                            
                            // åˆå¹¶æ¶ˆæ¯åˆ°å½“å‰æˆ¿é—´æ¶ˆæ¯åˆ—è¡¨
                            if (page === 1 && !append) {
                                // å¦‚æœæ˜¯ç¬¬ä¸€é¡µä¸”ä¸æ˜¯è¿½åŠ æ¨¡å¼ï¼Œæ¸…ç©ºèŠå¤©æ¶ˆæ¯åŒºåŸŸ
                                elements.chatMessages.innerHTML = '';
                                currentRoomMessages = messages;
                            } else {
                                // å°†æ–°æ¶ˆæ¯æ·»åŠ åˆ°æ•°ç»„å¼€å¤´
                                currentRoomMessages = [...messages, ...currentRoomMessages];
                            }
                            
                            // é‡æ–°æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯æˆ–è¿½åŠ æ–°æ¶ˆæ¯
                            if (page > 1 || append) {
                                // å¦‚æœæ˜¯åŠ è½½æ›´å¤šæˆ–è¿½åŠ æ¨¡å¼
                                if (page > 1) {
                                    // æ¸…ç©ºèŠå¤©åŒºåŸŸ
                                    elements.chatMessages.innerHTML = '';
                                    
                                    // é‡æ–°æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯
                                    let currentDate = null;
                                    
                                    currentRoomMessages.forEach(msg => {
                                        const messageDate = new Date(msg.created_at);
                                        const messageDateStr = messageDate.toDateString();
                                        
                                        // å¦‚æœæ—¥æœŸå˜åŒ–ï¼Œæ·»åŠ æ—¥æœŸåˆ†éš”çº¿
                                        if (!currentDate || messageDateStr !== currentDate) {
                                            currentDate = messageDateStr;
                                            addDateSeparator(messageDate);
                                        }
                                        
                                        // ç›´æ¥ä¼ é€’MessageBasicå¯¹è±¡ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µ
                                        appendMessage(msg);
                                    });
                                    
                                    // è®¡ç®—æ–°å¢å†…å®¹çš„é«˜åº¦ï¼Œå¹¶è°ƒæ•´æ»šåŠ¨ä½ç½®
                                    const newHeight = elements.chatMessages.scrollHeight;
                                    elements.chatMessages.scrollTop = scrollPos + (newHeight - oldHeight);
                                } else {
                                    // å¦‚æœæ˜¯è¿½åŠ æ¨¡å¼ä½†ä¸æ˜¯åŠ è½½æ›´å¤šï¼Œæ»šåŠ¨åˆ°åº•éƒ¨
                                    elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
                                }
                            } else {
                                // å¦‚æœæ˜¯ç¬¬ä¸€é¡µä¸”ä¸æ˜¯è¿½åŠ æ¨¡å¼ï¼Œç›´æ¥æ¸²æŸ“
                                let currentDate = null;
                                
                                messages.forEach(msg => {
                                    const messageDate = new Date(msg.created_at);
                                    const messageDateStr = messageDate.toDateString();
                                    
                                    // å¦‚æœæ—¥æœŸå˜åŒ–ï¼Œæ·»åŠ æ—¥æœŸåˆ†éš”çº¿
                                    if (!currentDate || messageDateStr !== currentDate) {
                                        currentDate = messageDateStr;
                                        addDateSeparator(messageDate);
                                    }
                                    
                                    // ç›´æ¥ä¼ é€’MessageBasicå¯¹è±¡ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µ
                                    appendMessage(msg);
                                });
                                
                                // æ»šåŠ¨åˆ°åº•éƒ¨
                                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
                            }
                            
                            // æ›´æ–°å½“å‰é¡µç 
                            currentPage = page;
                        }
                    } else {
                        console.error('è·å–èŠå¤©è®°å½•å¤±è´¥:', data.msg);
                    }
                } catch (error) {
                    console.error('è·å–èŠå¤©è®°å½•å‡ºé”™:', error);
                } finally {
                    isLoadingMessages = false;
                }
            }
            
            // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
            function appendMessage(message) {
                const isCurrentUser = message.user_id === currentUser.user_id;
                
                const messageElement = document.createElement('div');
                messageElement.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'} mb-4`;
                
                // æ ¼å¼åŒ–å‘é€æ—¶é—´ï¼Œåªç²¾ç¡®åˆ°åˆ†é’Ÿ
                const createdTime = new Date(message.created_at || new Date()).toLocaleTimeString([], { 
                    hour: '2-digit', minute: '2-digit' 
                });
                
                // è·å–ç”¨æˆ·æ˜µç§°
                const userName = isCurrentUser ? currentUser.nickname : (currentChatUser?.nickname || 'ç”¨æˆ·');
                
                // æ ¹æ®æ¶ˆæ¯ç±»å‹æ¸²æŸ“ä¸åŒçš„å†…å®¹
                let messageContent = '';
                const messageType = message.type || 'text'; // é»˜è®¤ä¸ºæ–‡æœ¬ç±»å‹
                
                switch (messageType) {
                    case 'emoji':
                        messageContent = `<span class="text-4xl">${message.data}</span>`;
                        break;
                    case 'image':
                        messageContent = `
                            <div class="max-w-48">
                                <img src="${message.data}" alt="${message.file_name || 'å›¾ç‰‡'}" class="rounded-lg max-w-full h-auto cursor-pointer" onclick="window.open('${message.data}', '_blank')">
                                <p class="text-xs text-gray-500 mt-1">${message.file_name || 'å›¾ç‰‡'}</p>
                            </div>
                        `;
                        break;
                    case 'file':
                        const fileSize = message.file_size ? (message.file_size / 1024 / 1024).toFixed(2) + 'MB' : 'æœªçŸ¥å¤§å°';
                        messageContent = `
                            <div class="flex items-center space-x-3 p-3 border border-gray-300 rounded-lg bg-white">
                                <div class="flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate">${message.file_name || 'æ–‡ä»¶'}</p>
                                    <p class="text-xs text-gray-500">${fileSize}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <a href="${message.data}" download="${message.file_name}" class="text-indigo-600 hover:text-indigo-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        `;
                        break;
                    case 'text':
                    default:
                        messageContent = `<p>${message.data || message.message}</p>`;
                        break;
                }
                
                messageElement.innerHTML = `
                    <div class="${isCurrentUser ? 'order-2' : 'order-1'} flex-shrink-0">
                        <img src="${isCurrentUser ? (currentUser.avatar || 'https://via.placeholder.com/32') : (currentChatUser?.avatar || 'https://via.placeholder.com/32')}" alt="å¤´åƒ" class="w-8 h-8 rounded-full ring-2 ring-white shadow-sm">
                    </div>
                    <div class="${isCurrentUser ? 'order-1' : 'order-2'} max-w-xs mx-2">
                        <div class="${isCurrentUser ? 'text-right' : 'text-left'} text-xs text-gray-500 mb-1">${userName}</div>
                        <div class="${isCurrentUser ? 'bg-gray-900 text-white' : 'bg-white border border-gray-200/60 text-gray-800'} rounded-xl ${messageType === 'emoji' ? 'px-3 py-2' : messageType === 'image' || messageType === 'file' ? 'p-3' : 'px-4 py-3'} shadow-sm">
                            ${messageContent}
                        </div>
                        <div class="text-xs text-gray-400 ${isCurrentUser ? 'text-right' : 'text-left'} mt-1">
                            <span>${createdTime}</span>
                        </div>
                    </div>
                `;
                
                elements.chatMessages.appendChild(messageElement);
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            }
            
            // æ·»åŠ æ»šåŠ¨äº‹ä»¶ç›‘å¬ï¼Œä¸Šæ»‘åŠ è½½æ›´å¤šæ¶ˆæ¯
            function setupScrollListener() {
                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
                elements.chatMessages.removeEventListener('scroll', handleScroll);
                
                // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
                elements.chatMessages.addEventListener('scroll', handleScroll);
            }
            
            // å¤„ç†æ»šåŠ¨äº‹ä»¶
            function handleScroll() {
                // å¦‚æœæ»šåŠ¨åˆ°é¡¶éƒ¨é™„è¿‘ï¼ˆè·ç¦»é¡¶éƒ¨å°äº50åƒç´ ï¼‰ï¼ŒåŠ è½½æ›´å¤šæ¶ˆæ¯
                if (elements.chatMessages.scrollTop < 50 && !isLoadingMessages && hasMoreMessages && currentRoomId) {
                    // åŠ è½½ä¸‹ä¸€é¡µæ¶ˆæ¯
                    loadChatMessages(currentRoomId, currentPage + 1, 20, true);
                }
            }
            
            // æ‰“å¼€èŠå¤©
            function openChat(roomId, contact) {
                // å¦‚æœæ˜¯åŒä¸€ä¸ªèŠå¤©ï¼Œä¸é‡æ–°åŠ è½½
                if (currentRoomId === roomId) {
                    return;
                }
                
                currentRoomId = roomId;
                currentChatUser = contact;
                
                // æ¸…é™¤è¯¥å¥½å‹çš„æ–°æ¶ˆæ¯æç¤º
                const friendIndex = friends.findIndex(f => f.room_id === roomId);
                if (friendIndex !== -1) {
                    friends[friendIndex].has_new_message = false;
                    friends[friendIndex].new_message_count = 0;
                    // é‡æ–°æ¸²æŸ“å¥½å‹åˆ—è¡¨ä»¥æ›´æ–°UI
                    renderFriendList(friends);
                }
                
                // é‡ç½®åˆ†é¡µå˜é‡
                currentPage = 1;
                hasMoreMessages = true;
                currentRoomMessages = [];
                
                // æ›´æ–°èŠå¤©æ ‡é¢˜ï¼Œæ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒçš„æ ‡é¢˜
                const chatType = contact.type === 1 ? 'ç§èŠ' : 'ç¾¤èŠ';
                elements.chatTitle.innerHTML = `${contact.nickname} <span class="text-sm text-gray-500">(${chatType})</span>`;
                
                // æ˜¾ç¤ºèŠå¤©è¾“å…¥åŒºåŸŸ
                elements.chatInputArea.classList.remove('hidden');
                
                // æ˜¾ç¤ºèŠå¤©æ“ä½œåŒºåŸŸï¼Œåªæœ‰ç§èŠæ‰æ˜¾ç¤ºæŸ¥çœ‹èµ„æ–™æŒ‰é’®
                elements.chatActions.classList.remove('hidden');
                if (contact.type === 1) {
                    elements.viewProfileBtn.classList.remove('hidden');
                } else {
                    elements.viewProfileBtn.classList.add('hidden');
                }
                
                // åŠ è½½èŠå¤©è®°å½•
                loadChatMessages(roomId);
                
                // è®¾ç½®æ»šåŠ¨äº‹ä»¶ç›‘å¬
                setupScrollListener();
            }
            
            // æœç´¢å¥½å‹
            async function searchFriend(account) {
                try {
                    const response = await fetch(`/user/query?account=${account}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // æˆåŠŸçŠ¶æ€ç 
                        return data.data;
                    } else {
                        throw new Error(data.msg || 'æœç´¢å¥½å‹å¤±è´¥');
                    }
                } catch (error) {
                    console.error('æœç´¢å¥½å‹å‡ºé”™:', error);
                    throw error;
                }
            }
            
            // æ·»åŠ å¥½å‹
            async function addFriend(account) {
                try {
                    const formData = new FormData();
                    formData.append('account', account);
                    
                    const response = await fetch('/user/add', {
                        method: 'POST',
                        headers: {
                            'Authorization': token
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // æˆåŠŸçŠ¶æ€ç 
                        return data.data;
                    } else {
                        throw new Error(data.msg || 'æ·»åŠ å¥½å‹å¤±è´¥');
                    }
                } catch (error) {
                    console.error('æ·»åŠ å¥½å‹å‡ºé”™:', error);
                    throw error;
                }
            }
            
            // åˆ é™¤å¥½å‹
            async function deleteFriend(roomId) {
                try {
                    // ä»å½“å‰å¥½å‹åˆ—è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„å¥½å‹ä¿¡æ¯
                    const friend = friends.find(f => f.room_id === roomId);
                    if (!friend) {
                        throw new Error('æ‰¾ä¸åˆ°è¯¥å¥½å‹ä¿¡æ¯');
                    }
                    
                    // æ„å»ºè¯·æ±‚å‚æ•°
                    const formData = new FormData();
                    formData.append('room_id', roomId);
                    
                    const response = await fetch('/user/delete', {
                        method: 'DELETE',
                        headers: {
                            'Authorization': token
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // æˆåŠŸçŠ¶æ€ç 
                        return true;
                    } else {
                        throw new Error(data.msg || 'åˆ é™¤å¥½å‹å¤±è´¥');
                    }
                } catch (error) {
                    console.error('åˆ é™¤å¥½å‹å‡ºé”™:', error);
                    throw error;
                }
            }
            
            // ç”¨æˆ·ä¸­å¿ƒç›¸å…³å‡½æ•°
            function openUserCenter() {
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                elements.userCenterModal.classList.remove('hidden');
                // è§¦å‘æ»‘å…¥åŠ¨ç”»
                setTimeout(() => {
                    elements.userCenterPanel.classList.remove('translate-x-full');
                }, 10);
                
                // åŠ è½½ç”¨æˆ·ä¿¡æ¯
                loadUserProfile();
            }
            
            function closeUserCenter() {
                // è§¦å‘æ»‘å‡ºåŠ¨ç”»
                elements.userCenterPanel.classList.add('translate-x-full');
                // éšè—æ¨¡æ€æ¡†
                setTimeout(() => {
                    elements.userCenterModal.classList.add('hidden');
                }, 300);
            }
            
            function openProfile() {
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                elements.profileModal.classList.remove('hidden');
                // è§¦å‘æ»‘å…¥åŠ¨ç”»
                setTimeout(() => {
                    elements.profilePanel.classList.remove('translate-x-full');
                }, 10);
                
                // åŠ è½½å¥½å‹ä¿¡æ¯
                loadFriendProfile();
            }
            
            function closeProfile() {
                // è§¦å‘æ»‘å‡ºåŠ¨ç”»
                elements.profilePanel.classList.add('translate-x-full');
                // éšè—æ¨¡æ€æ¡†
                setTimeout(() => {
                    elements.profileModal.classList.add('hidden');
                }, 300);
            }
            
            // æ˜¾ç¤ºåªè¯»æ¨¡å¼
            function showViewMode() {
                elements.profileViewMode.classList.remove('hidden');
                elements.profileForm.classList.add('hidden');
            }
            
            // æ˜¾ç¤ºç¼–è¾‘æ¨¡å¼
            function showEditMode() {
                elements.profileViewMode.classList.add('hidden');
                elements.profileForm.classList.remove('hidden');
            }
            
            // åŠ è½½ç”¨æˆ·èµ„æ–™
            async function loadUserProfile() {
                try {
                    const response = await fetch('/user/detail', {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) {
                        const user = data.data;
                        elements.profileAvatar.src = user.avatar || 'https://via.placeholder.com/80';
                        
                        // æ›´æ–°æ˜¾ç¤ºæ¨¡å¼
                        elements.profileNicknameDisplay.textContent = user.nickname || '';
                        elements.profileAccountDisplay.textContent = user.account || '';
                        elements.profileEmailDisplay.textContent = user.email || '';
                        
                        // æ›´æ–°ç¼–è¾‘æ¨¡å¼
                        elements.profileNickname.value = user.nickname || '';
                        elements.profileAccount.value = user.account || '';
                        elements.profileEmail.value = user.email || '';

                    } else {
                        alert('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                    }
                } catch (error) {
                    console.error('è·å–ç”¨æˆ·ä¿¡æ¯å‡ºé”™:', error);
                    alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                }
            }
            
            // åŠ è½½å¥½å‹èµ„æ–™
            async function loadFriendProfile() {
                if (!currentChatUser) return;
                
                try {
                    // è°ƒç”¨/user/queryæ¥å£è·å–å¥½å‹è¯¦ç»†ä¿¡æ¯
                    if (!currentChatUser.account) {
                        console.warn('å½“å‰èŠå¤©ç”¨æˆ·ç¼ºå°‘accountä¿¡æ¯');
                        // ä½¿ç”¨å¤‡ç”¨ä¿¡æ¯
                        elements.friendProfileAvatar.src = currentChatUser.avatar || 'https://via.placeholder.com/80';
                        elements.friendProfileNickname.textContent = currentChatUser.nickname || '';
                        elements.friendProfileAccount.textContent = currentChatUser.account || '';
                        elements.friendProfileEmail.textContent = currentChatUser.email || '';

                        return;
                    }
                    
                    const response = await fetch(`/user/query?account=${encodeURIComponent(currentChatUser.account)}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // æˆåŠŸçŠ¶æ€ç 
                        const userInfo = data.data;
                        elements.friendProfileAvatar.src = userInfo.avatar || 'https://via.placeholder.com/80';
                        elements.friendProfileNickname.textContent = userInfo.nickname || '';
                        elements.friendProfileAccount.textContent = userInfo.account || '';
                        elements.friendProfileEmail.textContent = userInfo.email || '';

                    } else {
                        // å¦‚æœæ¥å£è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨å½“å‰èŠå¤©ç”¨æˆ·çš„ä¿¡æ¯ä½œä¸ºå¤‡ç”¨
                        console.warn('è·å–å¥½å‹è¯¦ç»†ä¿¡æ¯å¤±è´¥:', data.msg);
                        elements.friendProfileAvatar.src = currentChatUser.avatar || 'https://via.placeholder.com/80';
                        elements.friendProfileNickname.textContent = currentChatUser.nickname || '';
                        elements.friendProfileAccount.textContent = currentChatUser.account || '';
                        elements.friendProfileEmail.textContent = currentChatUser.email || '';

                    }
                } catch (error) {
                    console.error('è·å–å¥½å‹ä¿¡æ¯å‡ºé”™:', error);
                    // ç½‘ç»œé”™è¯¯æ—¶ä½¿ç”¨å½“å‰èŠå¤©ç”¨æˆ·çš„ä¿¡æ¯ä½œä¸ºå¤‡ç”¨
                    elements.friendProfileAvatar.src = currentChatUser.avatar || 'https://via.placeholder.com/80';
                    elements.friendProfileNickname.textContent = currentChatUser.nickname || '';
                    elements.friendProfileAccount.textContent = currentChatUser.account || '';
                    elements.friendProfileEmail.textContent = currentChatUser.email || '';
                    
                    alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                }
            }
            
            // äº‹ä»¶ç›‘å¬
            
            // ç”¨æˆ·ä¸­å¿ƒæŒ‰é’®
            elements.userCenterBtn.addEventListener('click', function() {
                openUserCenter();
                // ç¡®ä¿æ‰“å¼€æ—¶æ˜¾ç¤ºåªè¯»æ¨¡å¼
                showViewMode();
            });
            
            // ç¼–è¾‘èµ„æ–™æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            elements.editProfileBtn.addEventListener('click', function() {
                showEditMode();
            });
            
            // å–æ¶ˆç¼–è¾‘æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            elements.cancelEditBtn.addEventListener('click', function() {
                showViewMode();
            });
            
            // ç”¨æˆ·ä¸­å¿ƒå…³é—­æŒ‰é’®
            elements.closeUserCenterBtn.addEventListener('click', closeUserCenter);
            
            // ç”¨æˆ·ä¸­å¿ƒèƒŒæ™¯é®ç½©
            elements.userCenterBackdrop.addEventListener('click', closeUserCenter);
            
            // æŸ¥çœ‹èµ„æ–™æŒ‰é’®
            elements.viewProfileBtn.addEventListener('click', openProfile);
            
            // æŸ¥çœ‹èµ„æ–™å…³é—­æŒ‰é’®
            elements.closeProfileBtn.addEventListener('click', closeProfile);
            
            // æŸ¥çœ‹èµ„æ–™èƒŒæ™¯é®ç½©
            elements.profileBackdrop.addEventListener('click', closeProfile);
            
            // ç”¨æˆ·èµ„æ–™è¡¨å•æäº¤
            elements.profileForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´æ–°ç”¨æˆ·ä¿¡æ¯çš„APIè°ƒç”¨
                    alert('èµ„æ–™æ›´æ–°åŠŸèƒ½å¾…å®ç°');
                    
                    // æ›´æ–°æˆåŠŸååˆ‡æ¢å›åªè¯»æ¨¡å¼
                    showViewMode();
                    // é‡æ–°åŠ è½½ç”¨æˆ·èµ„æ–™ä»¥æ˜¾ç¤ºæœ€æ–°æ•°æ®
                    loadUserProfile();
                } catch (error) {
                    console.error('æ›´æ–°ç”¨æˆ·ä¿¡æ¯å‡ºé”™:', error);
                    alert('æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            });
            
            // ä¿®æ”¹å¯†ç æŒ‰é’®
            elements.changePasswordBtn.addEventListener('click', function() {
                alert('ä¿®æ”¹å¯†ç åŠŸèƒ½å¾…å®ç°');
            });
            
            // åˆ é™¤å¥½å‹æŒ‰é’®ï¼ˆåœ¨æŸ¥çœ‹èµ„æ–™çª—å£ä¸­ï¼‰
            elements.deleteFriendBtn.addEventListener('click', async function() {
                if (!currentChatUser || !currentRoomId) return;
                
                // åªæœ‰ç§èŠæ‰èƒ½åˆ é™¤å¥½å‹
                if (currentChatUser.type !== 1) {
                    alert('åªèƒ½åˆ é™¤ç§èŠè”ç³»äºº');
                    return;
                }
                
                if (confirm(`ç¡®å®šè¦åˆ é™¤å¥½å‹ ${currentChatUser.nickname} å—ï¼Ÿ`)) {
                    try {
                        await deleteFriend(currentRoomId);
                        
                        // å…³é—­èµ„æ–™çª—å£
                        closeProfile();
                        
                        // é‡æ–°è·å–å¥½å‹åˆ—è¡¨
                        fetchFriends();
                        
                        // é‡ç½®èŠå¤©åŒºåŸŸ
                        currentRoomId = null;
                        currentChatUser = null;
                        elements.chatTitle.textContent = 'è¯·é€‰æ‹©ä¸€ä¸ªèŠå¤©';
                        elements.chatMessages.innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-gray-500">é€‰æ‹©ä¸€ä¸ªè”ç³»äººå¼€å§‹èŠå¤©</p></div>';
                        elements.chatInputArea.classList.add('hidden');
                        elements.chatActions.classList.add('hidden');
                        
                        alert('åˆ é™¤å¥½å‹æˆåŠŸ');
                    } catch (error) {
                        alert(error.message || 'åˆ é™¤å¥½å‹å¤±è´¥');
                    }
                }
            });
            
            // é€€å‡ºç™»å½•
            elements.logoutBtn.addEventListener('click', function() {
                // å…³é—­WebSocketè¿æ¥
                if (socket) {
                    socket.close();
                }
                
                // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„token
                localStorage.removeItem('token');
                
                // è·³è½¬åˆ°ç™»å½•é¡µé¢
                window.location.href = 'login.html';
            });
            
            // å‘é€æ¶ˆæ¯
            elements.messageForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const message = elements.messageInput.value.trim();
                if (!message) return;
                
                if (!currentRoomId) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©');
                    return;
                }
                
                // è·å–å½“å‰æ—¥æœŸ
                const now = new Date();
                const todayStr = now.toDateString();
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ æ—¥æœŸåˆ†éš”çº¿
                let lastDateStr = null;
                const dateElements = elements.chatMessages.querySelectorAll('.date-separator');
                if (dateElements.length > 0) {
                    const lastDateElement = dateElements[dateElements.length - 1];
                    lastDateStr = lastDateElement.getAttribute('data-date');
                }
                
                // å¦‚æœæ—¥æœŸä¸åŒæˆ–æ²¡æœ‰æ—¥æœŸåˆ†éš”çº¿ï¼Œæ·»åŠ æ–°çš„æ—¥æœŸåˆ†éš”çº¿
                if (!lastDateStr || todayStr !== lastDateStr) {
                    addDateSeparator(now);
                }
                
                // æ„å»ºæ¶ˆæ¯å¯¹è±¡ï¼Œä½¿ç”¨dataå­—æ®µåŒ¹é…MessageBasicç»“æ„
                const messageObj = {
                    user_id: currentUser.user_id,
                    room_id: currentRoomId,
                    data: message,
                    type: 'text', // è®¾ç½®æ¶ˆæ¯ç±»å‹ä¸ºæ–‡æœ¬
                    created_at: now.toISOString() // æ·»åŠ åˆ›å»ºæ—¶é—´
                };
                
                // å‘é€æ¶ˆæ¯
                socket.send(JSON.stringify(messageObj));
                
                // æ·»åŠ æ¶ˆæ¯åˆ°å½“å‰æ¶ˆæ¯åˆ—è¡¨ï¼ˆæœ¬åœ°æ˜¾ç¤ºï¼Œä¸ç­‰å¾…æœåŠ¡å™¨å“åº”ï¼‰
                // æ³¨æ„ï¼šæœåŠ¡å™¨å“åº”åä¼šé€šè¿‡WebSocketå†æ¬¡æ”¶åˆ°è¿™æ¡æ¶ˆæ¯ï¼Œä½†ç”±äºå·²ç»æ·»åŠ è¿‡ï¼Œä¸ä¼šé‡å¤æ˜¾ç¤º
                currentRoomMessages.push(messageObj);
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                elements.messageInput.value = '';
            });
            
            // æ‰“å¼€æ·»åŠ å¥½å‹æ¨¡æ€æ¡†
            elements.addFriendBtn.addEventListener('click', function() {
                // é‡ç½®è¡¨å•
                elements.addFriendForm.reset();
                elements.searchResult.classList.add('hidden');
                elements.confirmAddFriendBtn.classList.add('hidden');
                elements.addFriendError.classList.add('hidden');
                elements.addFriendSuccess.classList.add('hidden');
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                elements.addFriendModal.classList.remove('hidden');
            });
            
            // å…³é—­æ·»åŠ å¥½å‹æ¨¡æ€æ¡†
            elements.closeAddFriendModal.addEventListener('click', function() {
                elements.addFriendModal.classList.add('hidden');
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­æ¨¡æ€æ¡†
            elements.addFriendModal.addEventListener('click', function(e) {
                if (e.target === elements.addFriendModal) {
                    elements.addFriendModal.classList.add('hidden');
                }
            });
            
            // æœç´¢å¥½å‹
            elements.searchFriendBtn.addEventListener('click', async function() {
                const account = elements.friendAccount.value.trim();
                if (!account) {
                    elements.addFriendErrorText.textContent = 'è¯·è¾“å…¥å¥½å‹è´¦å·';
                    elements.addFriendError.classList.remove('hidden');
                    elements.addFriendSuccess.classList.add('hidden');
                    return;
                }
                
                try {
                    const user = await searchFriend(account);
                    
                    // æ˜¾ç¤ºæœç´¢ç»“æœ
                    elements.resultNickname.textContent = user.nickname || user.account;
                    elements.resultAccount.textContent = user.account;
                    if (user.avatar) {
                        elements.resultAvatar.src = user.avatar;
                    }
                    
                    elements.searchResult.classList.remove('hidden');
                    
                    // å¦‚æœå·²ç»æ˜¯å¥½å‹ï¼Œä¸æ˜¾ç¤ºæ·»åŠ æŒ‰é’®
                    if (user.is_friend) {
                        elements.addFriendErrorText.textContent = 'è¯¥ç”¨æˆ·å·²ç»æ˜¯æ‚¨çš„å¥½å‹';
                        elements.addFriendError.classList.remove('hidden');
                        elements.addFriendSuccess.classList.add('hidden');
                        elements.confirmAddFriendBtn.classList.add('hidden');
                    } else {
                        elements.addFriendError.classList.add('hidden');
                        elements.addFriendSuccess.classList.add('hidden');
                        elements.confirmAddFriendBtn.classList.remove('hidden');
                        
                        // å­˜å‚¨æœç´¢åˆ°çš„ç”¨æˆ·ä¿¡æ¯
                        elements.confirmAddFriendBtn.dataset.account = user.account;
                    }
                } catch (error) {
                    elements.addFriendErrorText.textContent = error.message || 'æœç´¢å¥½å‹å¤±è´¥';
                    elements.addFriendError.classList.remove('hidden');
                    elements.addFriendSuccess.classList.add('hidden');
                    elements.searchResult.classList.add('hidden');
                    elements.confirmAddFriendBtn.classList.add('hidden');
                }
            });
            
            // ç¡®è®¤æ·»åŠ å¥½å‹
            elements.confirmAddFriendBtn.addEventListener('click', async function() {
                const account = elements.confirmAddFriendBtn.dataset.account;
                if (!account) return;
                
                try {
                    await addFriend(account);
                    
                    // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                    elements.addFriendSuccessText.textContent = 'æ·»åŠ å¥½å‹æˆåŠŸ';
                    elements.addFriendSuccess.classList.remove('hidden');
                    elements.addFriendError.classList.add('hidden');
                    
                    // é‡æ–°è·å–å¥½å‹åˆ—è¡¨
                    fetchFriends();
                    
                    // 3ç§’åå…³é—­æ¨¡æ€æ¡†
                    setTimeout(() => {
                        elements.addFriendModal.classList.add('hidden');
                    }, 3000);
                } catch (error) {
                    elements.addFriendErrorText.textContent = error.message || 'æ·»åŠ å¥½å‹å¤±è´¥';
                    elements.addFriendError.classList.remove('hidden');
                    elements.addFriendSuccess.classList.add('hidden');
                }
            });
            

            
            // æœç´¢è”ç³»äººï¼ˆæœ¬åœ°æœç´¢ï¼‰
            elements.searchBtn.addEventListener('click', function() {
                const keyword = elements.searchInput.value.trim().toLowerCase();
                if (!keyword) {
                    // æ˜¾ç¤ºæ‰€æœ‰è”ç³»äºº
                    renderFriendList(friends);
                    return;
                }
                
                // è¿‡æ»¤è”ç³»äººåˆ—è¡¨
                const filteredFriends = friends.filter(friend => {
                    return friend.nickname.toLowerCase().includes(keyword);
                });
                
                // æ›´æ–°è”ç³»äººåˆ—è¡¨
                renderFriendList(filteredFriends);
            });
            
            // æœç´¢æ¡†å›è½¦äº‹ä»¶
            elements.searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    elements.searchBtn.click();
                }
            });
            
            // æœç´¢æ¡†æ¸…ç©ºäº‹ä»¶
            elements.searchInput.addEventListener('input', function() {
                if (this.value.trim() === '') {
                    renderFriendList(friends);
                }
            });
            
            // æ¸²æŸ“å¥½å‹åˆ—è¡¨
            function renderFriendList(friendsList) {
                // æ¸…ç©ºå¥½å‹åˆ—è¡¨
                elements.friendList.innerHTML = '';
                
                if (friendsList.length === 0) {
                    elements.friendList.innerHTML = '<div class="text-center text-gray-500 py-4">æœªæ‰¾åˆ°åŒ¹é…çš„è”ç³»äºº</div>';
                    return;
                }
                
                // æ¸²æŸ“å¥½å‹åˆ—è¡¨
                friendsList.forEach(friend => {
                    const friendElement = document.createElement('div');
                    // å¦‚æœæœ‰æ–°æ¶ˆæ¯ï¼Œæ·»åŠ ç‰¹æ®Šæ ·å¼
                    const hasNewMessage = friend.has_new_message && friend.room_id !== currentRoomId;
                    friendElement.className = `p-3 hover:bg-white/60 rounded-xl cursor-pointer relative transition-all duration-200 mb-2 ${hasNewMessage ? 'bg-blue-50/80 border border-blue-200/60 shadow-sm' : 'hover:shadow-sm'}`;
                    friendElement.dataset.roomId = friend.room_id;
                    friendElement.dataset.type = friend.type;
                    
                    // æ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒçš„å›¾æ ‡
                    const typeIcon = friend.type === 1 ? 
                        '<div class="w-2 h-2 bg-blue-400 rounded-full" title="ç§èŠ"></div>' : 
                        '<div class="w-2 h-2 bg-green-400 rounded-full" title="ç¾¤èŠ"></div>';
                    
                    // æ–°æ¶ˆæ¯æç¤ºæ ‡è¯†
                    const newMessageBadge = hasNewMessage && friend.new_message_count > 0 ? 
                        `<span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-medium shadow-sm">${friend.new_message_count > 99 ? '99+' : friend.new_message_count}</span>` : '';
                    
                    friendElement.innerHTML = `
                        <div class="flex items-center">
                            <div class="relative">
                                <img src="${friend.avatar || 'https://via.placeholder.com/40'}" alt="å¤´åƒ" class="w-12 h-12 rounded-full ring-2 ring-white shadow-sm">
                                ${hasNewMessage ? '<div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></div>' : ''}
                            </div>
                            <div class="flex-1 ml-3 min-w-0">
                                <div class="flex items-center justify-between">
                                    <p class="font-medium text-gray-900 truncate ${hasNewMessage ? 'text-blue-700' : ''}">${friend.nickname}</p>
                                    <div class="flex items-center space-x-2">
                                        ${typeIcon}
                                    </div>
                                </div>
                                <div class="flex items-center text-sm text-gray-500 truncate mt-1 ${hasNewMessage ? 'text-blue-600 font-medium' : ''}">
                                    ${getMessageTypeIcon(friend.last_message_type || 'text')}
                                    <span class="ml-1 truncate">${friend.last_message || 'æš‚æ— æ¶ˆæ¯'}</span>
                                </div>
                            </div>
                        </div>
                        ${newMessageBadge}
                    `;
                    
                    // ç‚¹å‡»è”ç³»äººæ‰“å¼€èŠå¤©
                    friendElement.addEventListener('click', function() {
                        openChat(friend.room_id, friend);
                    });
                    
                    elements.friendList.appendChild(friendElement);
                });
            }
            
            // è·å–æ¶ˆæ¯ç±»å‹å›¾æ ‡
            function getMessageTypeIcon(messageType) {
                switch (messageType) {
                    case 'emoji':
                        return '<span class="text-yellow-500">ğŸ˜Š</span>';
                    case 'image':
                        return '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>';
                    case 'file':
                        return '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>';
                    case 'video':
                        return '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>';
                    case 'speech':
                        return '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>';
                    case 'text':
                    default:
                        return '';
                }
            }
            
            // åˆå§‹åŒ–è¡¨æƒ…é€‰æ‹©å™¨
            function initEmojiPicker() {
                const emojiGrid = elements.emojiPicker.querySelector('.grid');
                emojiGrid.innerHTML = '';
                
                emojis.forEach(emoji => {
                    const emojiBtn = document.createElement('button');
                    emojiBtn.type = 'button';
                    emojiBtn.className = 'p-2 text-2xl hover:bg-gray-200 rounded transition-colors duration-200';
                    emojiBtn.textContent = emoji;
                    emojiBtn.addEventListener('click', function() {
                        // å‘é€è¡¨æƒ…æ¶ˆæ¯
                        sendEmojiMessage(emoji);
                        // éšè—è¡¨æƒ…é€‰æ‹©å™¨
                        elements.emojiPicker.classList.add('hidden');
                    });
                    emojiGrid.appendChild(emojiBtn);
                });
            }
            
            // å‘é€è¡¨æƒ…æ¶ˆæ¯
            function sendEmojiMessage(emoji) {
                if (!currentRoomId) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©');
                    return;
                }
                
                const now = new Date();
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ æ—¥æœŸåˆ†éš”çº¿
                const lastDateElements = elements.chatMessages.querySelectorAll('.date-separator');
                const lastDateStr = lastDateElements.length > 0 ? 
                    lastDateElements[lastDateElements.length - 1].textContent.trim() : null;
                const todayStr = now.getFullYear() + '/' + 
                                String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                                String(now.getDate()).padStart(2, '0');
                
                if (!lastDateStr || todayStr !== lastDateStr) {
                    addDateSeparator(now);
                }
                
                // æ„å»ºè¡¨æƒ…æ¶ˆæ¯å¯¹è±¡
                const messageObj = {
                    user_id: currentUser.user_id,
                    room_id: currentRoomId,
                    data: emoji,
                    type: 'emoji', // è®¾ç½®æ¶ˆæ¯ç±»å‹ä¸ºè¡¨æƒ…
                    created_at: now.toISOString()
                };
                
                // å‘é€æ¶ˆæ¯
                socket.send(JSON.stringify(messageObj));
                
                // æ·»åŠ æ¶ˆæ¯åˆ°å½“å‰æ¶ˆæ¯åˆ—è¡¨
                currentRoomMessages.push(messageObj);
            }
            
            // å‘é€å›¾ç‰‡æ¶ˆæ¯
            function sendImageMessage(file) {
                if (!currentRoomId) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©');
                    return;
                }
                
                // åˆ›å»ºæ–‡ä»¶è¯»å–å™¨
                const reader = new FileReader();
                reader.onload = function(e) {
                    const now = new Date();
                    
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ æ—¥æœŸåˆ†éš”çº¿
                    const lastDateElements = elements.chatMessages.querySelectorAll('.date-separator');
                    const lastDateStr = lastDateElements.length > 0 ? 
                        lastDateElements[lastDateElements.length - 1].textContent.trim() : null;
                    const todayStr = now.getFullYear() + '/' + 
                                    String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                                    String(now.getDate()).padStart(2, '0');
                    
                    if (!lastDateStr || todayStr !== lastDateStr) {
                        addDateSeparator(now);
                    }
                    
                    // æ„å»ºå›¾ç‰‡æ¶ˆæ¯å¯¹è±¡
                    const messageObj = {
                        user_id: currentUser.user_id,
                        room_id: currentRoomId,
                        data: e.target.result, // base64ç¼–ç çš„å›¾ç‰‡æ•°æ®
                        type: 'image',
                        file_name: file.name,
                        file_size: file.size,
                        created_at: now.toISOString()
                    };
                    
                    // å‘é€æ¶ˆæ¯
                    socket.send(JSON.stringify(messageObj));
                    
                    // æ·»åŠ æ¶ˆæ¯åˆ°å½“å‰æ¶ˆæ¯åˆ—è¡¨
                    currentRoomMessages.push(messageObj);
                };
                
                reader.readAsDataURL(file);
            }
            
            // å‘é€æ–‡ä»¶æ¶ˆæ¯
            function sendFileMessage(file) {
                if (!currentRoomId) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©');
                    return;
                }
                
                // åˆ›å»ºæ–‡ä»¶è¯»å–å™¨
                const reader = new FileReader();
                reader.onload = function(e) {
                    const now = new Date();
                    
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ æ—¥æœŸåˆ†éš”çº¿
                    const lastDateElements = elements.chatMessages.querySelectorAll('.date-separator');
                    const lastDateStr = lastDateElements.length > 0 ? 
                        lastDateElements[lastDateElements.length - 1].textContent.trim() : null;
                    const todayStr = now.getFullYear() + '/' + 
                                    String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                                    String(now.getDate()).padStart(2, '0');
                    
                    if (!lastDateStr || todayStr !== lastDateStr) {
                        addDateSeparator(now);
                    }
                    
                    // æ„å»ºæ–‡ä»¶æ¶ˆæ¯å¯¹è±¡
                    const messageObj = {
                        user_id: currentUser.user_id,
                        room_id: currentRoomId,
                        data: e.target.result, // base64ç¼–ç çš„æ–‡ä»¶æ•°æ®
                        type: 'file',
                        file_name: file.name,
                        file_size: file.size,
                        created_at: now.toISOString()
                    };
                    
                    // å‘é€æ¶ˆæ¯
                    socket.send(JSON.stringify(messageObj));
                    
                    // æ·»åŠ æ¶ˆæ¯åˆ°å½“å‰æ¶ˆæ¯åˆ—è¡¨
                    currentRoomMessages.push(messageObj);
                };
                
                reader.readAsDataURL(file);
            }
            
            // è¡¨æƒ…æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            elements.emojiBtn.addEventListener('click', function() {
                elements.emojiPicker.classList.toggle('hidden');
            });
            
            // å›¾ç‰‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            elements.imageBtn.addEventListener('click', function() {
                elements.imageInput.click();
            });
            
            // æ–‡ä»¶æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            elements.fileBtn.addEventListener('click', function() {
                elements.fileInput.click();
            });
            
            // å›¾ç‰‡æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            elements.imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º5MBï¼‰
                    if (file.size > 5 * 1024 * 1024) {
                        alert('å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                        return;
                    }
                    sendImageMessage(file);
                }
                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©å™¨
                e.target.value = '';
            });
            
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            elements.fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º10MBï¼‰
                    if (file.size > 10 * 1024 * 1024) {
                        alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
                        return;
                    }
                    sendFileMessage(file);
                }
                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©å™¨
                e.target.value = '';
            });
            
            // å›è½¦é”®å‘é€æ¶ˆæ¯
            elements.messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    elements.messageForm.dispatchEvent(new Event('submit'));
                }
            });
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—è¡¨æƒ…é€‰æ‹©å™¨
            document.addEventListener('click', function(e) {
                if (!elements.emojiBtn.contains(e.target) && !elements.emojiPicker.contains(e.target)) {
                    elements.emojiPicker.classList.add('hidden');
                }
            });
            
            // åˆå§‹åŒ–
            initEmojiPicker();
            fetchCurrentUser();
        });
    </script>
    
    <!-- ç”¨æˆ·ä¸­å¿ƒæ»‘å…¥çª—å£ -->
    <div id="user-center-modal" class="fixed inset-0 z-50 hidden">
        <!-- èƒŒæ™¯é®ç½© -->
        <div id="user-center-backdrop" class="absolute inset-0 bg-black/30 backdrop-blur-sm"></div>
        <!-- æ»‘å…¥çª—å£ -->
        <div id="user-center-panel" class="absolute right-0 top-0 h-full w-96 bg-white/95 backdrop-blur-md shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out border-l border-gray-200/50">
            <!-- å¤´éƒ¨ -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200/60 bg-gradient-to-r from-gray-50/80 to-white/80">
                <h3 class="text-xl font-semibold text-gray-900">ç”¨æˆ·ä¸­å¿ƒ</h3>
                <button id="close-user-center-btn" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100/80 p-2 rounded-xl transition-all duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- ç”¨æˆ·å¤´åƒ -->
                <div class="text-center mb-8">
                    <div class="relative inline-block">
                        <img id="profile-avatar" src="" alt="å¤´åƒ" class="w-24 h-24 rounded-full mx-auto mb-3 ring-4 ring-white shadow-lg">
                        <div class="absolute inset-0 rounded-full bg-black/10 opacity-0 hover:opacity-100 transition-opacity duration-200 flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <button id="change-avatar-btn" class="text-sm text-gray-600 hover:text-gray-800 font-medium transition-colors duration-200">æ›´æ¢å¤´åƒ</button>
                </div>
                
                <!-- ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º/ç¼–è¾‘åŒºåŸŸ -->
                <div class="space-y-6">
                    <!-- åªè¯»æ˜¾ç¤ºæ¨¡å¼ -->
                    <div id="profile-view-mode">
                        <div class="mb-5">
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ˜µç§°</label>
                            <div id="profile-nickname-display" class="w-full px-4 py-3 border border-gray-200/60 rounded-xl bg-gray-50/80 text-gray-800"></div>
                        </div>
                        
                        <div class="mb-5">
                            <label class="block text-sm font-medium text-gray-700 mb-2">è´¦å·</label>
                            <div id="profile-account-display" class="w-full px-4 py-3 border border-gray-200/60 rounded-xl bg-gray-50/80 text-gray-800"></div>
                        </div>
                        
                        <div class="mb-8">
                            <label class="block text-sm font-medium text-gray-700 mb-2">é‚®ç®±</label>
                            <div id="profile-email-display" class="w-full px-4 py-3 border border-gray-200/60 rounded-xl bg-gray-50/80 text-gray-800"></div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button type="button" id="edit-profile-btn" class="flex-1 bg-gray-900 text-white py-3 px-4 rounded-xl hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-all duration-200 font-medium shadow-sm hover:shadow-md">
                                ç¼–è¾‘èµ„æ–™
                            </button>
                            <button type="button" id="change-password-btn" class="flex-1 bg-gray-100 text-gray-700 py-3 px-4 rounded-xl hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300 transition-all duration-200 font-medium border border-gray-200/60">
                                ä¿®æ”¹å¯†ç 
                            </button>
                        </div>
                    </div>
                    
                    <!-- ç¼–è¾‘æ¨¡å¼ -->
                    <form id="profile-form" class="space-y-5 hidden">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ˜µç§°</label>
                            <input type="text" id="profile-nickname" class="w-full px-4 py-3 border border-gray-200/60 rounded-xl focus:outline-none focus:ring-2 focus:ring-gray-400 focus:border-gray-400 transition-all duration-200">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">è´¦å·</label>
                            <input type="text" id="profile-account" class="w-full px-4 py-3 border border-gray-200/60 rounded-xl bg-gray-50/80 text-gray-600" readonly>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">é‚®ç®±</label>
                            <input type="email" id="profile-email" class="w-full px-4 py-3 border border-gray-200/60 rounded-xl bg-gray-50/80 text-gray-600" readonly>
                        </div>
                        
                        <div class="flex space-x-3 pt-4">
                            <button type="submit" class="flex-1 bg-gray-900 text-white py-3 px-4 rounded-xl hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-all duration-200 font-medium shadow-sm hover:shadow-md">
                                ä¿å­˜ä¿®æ”¹
                            </button>
                            <button type="button" id="cancel-edit-btn" class="flex-1 bg-gray-100 text-gray-700 py-3 px-4 rounded-xl hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300 transition-all duration-200 font-medium border border-gray-200/60">
                                å–æ¶ˆ
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- é€€å‡ºç™»å½•æŒ‰é’® -->
                <div class="mt-8 pt-6 border-t border-gray-200/60">
                    <button id="logout-btn" class="w-full bg-red-500 text-white py-3 px-4 rounded-xl hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 transition-all duration-200 font-medium shadow-sm hover:shadow-md">
                        é€€å‡ºç™»å½•
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æŸ¥çœ‹èµ„æ–™æ»‘å…¥çª—å£ -->
    <div id="profile-modal" class="fixed inset-0 z-50 hidden">
        <!-- èƒŒæ™¯é®ç½© -->
        <div id="profile-backdrop" class="absolute inset-0 bg-black/30 backdrop-blur-sm"></div>
        <!-- æ»‘å…¥çª—å£ -->
        <div id="profile-panel" class="absolute right-0 top-0 h-full w-96 bg-white/95 backdrop-blur-md shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out border-l border-gray-200/50">
            <!-- å¤´éƒ¨ -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200/60 bg-gradient-to-r from-gray-50/80 to-white/80">
                <h3 class="text-xl font-semibold text-gray-900">ç”¨æˆ·èµ„æ–™</h3>
                <button id="close-profile-btn" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100/80 p-2 rounded-xl transition-all duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- ç”¨æˆ·å¤´åƒ -->
                <div class="text-center mb-8">
                    <img id="friend-profile-avatar" src="" alt="å¤´åƒ" class="w-24 h-24 rounded-full mx-auto ring-4 ring-white shadow-lg">
                </div>
                
                <!-- ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º -->
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ˜µç§°</label>
                        <div id="friend-profile-nickname" class="w-full px-4 py-3 border border-gray-200/60 rounded-xl bg-gray-50/80 text-gray-800"></div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è´¦å·</label>
                        <div id="friend-profile-account" class="w-full px-4 py-3 border border-gray-200/60 rounded-xl bg-gray-50/80 text-gray-800"></div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é‚®ç®±</label>
                        <div id="friend-profile-email" class="w-full px-4 py-3 border border-gray-200/60 rounded-xl bg-gray-50/80 text-gray-800"></div>
                    </div>
                    
                    <!-- åˆ é™¤å¥½å‹æŒ‰é’® -->
                    <div class="mt-8 pt-6 border-t border-gray-200/60">
                        <button id="delete-friend-btn" class="w-full bg-red-500 text-white py-3 px-4 rounded-xl hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 transition-all duration-200 font-medium shadow-sm hover:shadow-md">
                            åˆ é™¤å¥½å‹
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>