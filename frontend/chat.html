<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤© - IMå³æ—¶é€šè®¯ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="bg-indigo-600 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">IMå³æ—¶é€šè®¯ç³»ç»Ÿ</h1>
            <div class="flex items-center space-x-4">
                <span id="user-nickname" class="text-sm">åŠ è½½ä¸­...</span>
                <img id="user-avatar" src="https://avatars.githubusercontent.com/u/148515933?s=400&u=7cbff7c77a33416cabfe463fff24495157026760&v=4" alt="å¤´åƒ" class="w-8 h-8 rounded-full">
                <button id="logout-btn" class="text-sm bg-indigo-700 hover:bg-indigo-800 px-3 py-1 rounded">
                    é€€å‡ºç™»å½•
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="flex-1 flex overflow-hidden">
        <!-- å·¦ä¾§è”ç³»äººåˆ—è¡¨ -->
        <div class="w-1/4 bg-white border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b border-gray-200">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="æœç´¢è”ç³»äºº" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="search-btn" class="absolute right-2 top-2 text-gray-500 hover:text-indigo-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-2" id="friend-list">
                <!-- è”ç³»äººåˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                <div class="text-center text-gray-500 py-4">åŠ è½½è”ç³»äººåˆ—è¡¨ä¸­...</div>
            </div>
            
            <div class="p-4 border-t border-gray-200">
                <button id="add-friend-btn" class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    æ·»åŠ è”ç³»äºº
                </button>
            </div>
        </div>
        
        <!-- å³ä¾§èŠå¤©åŒºåŸŸ -->
        <div class="flex-1 flex flex-col">
            <!-- èŠå¤©å¤´éƒ¨ -->
            <div class="p-4 border-b border-gray-200 bg-white shadow-sm flex justify-between items-center">
                <h2 id="chat-title" class="text-lg font-medium">è¯·é€‰æ‹©ä¸€ä¸ªèŠå¤©</h2>
                <div id="chat-actions" class="hidden">
                    <button id="delete-friend-btn" class="text-sm text-red-600 hover:text-red-800">
                        åˆ é™¤å¥½å‹
                    </button>
                </div>
            </div>
            
            <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 bg-gray-50">
                <div class="flex items-center justify-center h-full">
                    <p class="text-gray-500">é€‰æ‹©ä¸€ä¸ªè”ç³»äººå¼€å§‹èŠå¤©</p>
                </div>
            </div>
            
            <!-- èŠå¤©è¾“å…¥åŒºåŸŸ -->
            <div id="chat-input-area" class="p-4 border-t border-gray-200 bg-white hidden">
                <!-- è¡¨æƒ…é€‰æ‹©å™¨ -->
                <div id="emoji-picker" class="hidden absolute bottom-20 left-4 w-80 p-4 border border-gray-200 rounded-lg bg-white shadow-lg max-h-48 overflow-y-auto z-10">
                    <div class="grid grid-cols-8 gap-2">
                        <!-- è¡¨æƒ…å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- æ–‡ä»¶é€‰æ‹©å™¨ -->
                <input type="file" id="file-input" class="hidden" accept="*/*">
                <input type="file" id="image-input" class="hidden" accept="image/*">
                
                <div class="relative h-20">
                    <!-- å·¦ä¾§åŠŸèƒ½æŒ‰é’® -->
                    <div class="absolute left-0 top-0 flex flex-col justify-center h-full space-y-1">
                        <button type="button" id="emoji-btn" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-indigo-500 hover:bg-gray-100 rounded-lg transition-colors">
                            ğŸ˜Š
                        </button>
                        <button type="button" id="image-btn" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-indigo-500 hover:bg-gray-100 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </button>
                        <button type="button" id="file-btn" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-indigo-500 hover:bg-gray-100 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                            </svg>
                        </button>
                    </div>
                    
                    <!-- ä¸»è¾“å…¥åŒºåŸŸ -->
                    <form id="message-form" class="h-full">
                        <div class="ml-12 mr-16 h-full relative">
                            <textarea id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." class="w-full h-full resize-none border-none outline-none bg-gray-50 rounded-lg px-4 py-3 text-sm" rows="3"></textarea>
                        </div>
                        
                        <!-- å‘é€æŒ‰é’® -->
                        <button type="submit" class="absolute bottom-2 right-2 w-12 h-8 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg flex items-center justify-center transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å¥½å‹æ¨¡æ€æ¡† -->
    <div id="add-friend-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">æ·»åŠ å¥½å‹</h3>
                <button id="close-add-friend-modal" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div id="add-friend-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4">
                <span id="add-friend-error-text"></span>
            </div>
            
            <div id="add-friend-success" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4">
                <span id="add-friend-success-text"></span>
            </div>
            
            <form id="add-friend-form">
                <div class="mb-4">
                    <label for="friend-account" class="block text-sm font-medium text-gray-700 mb-1">å¥½å‹è´¦å·</label>
                    <input type="text" id="friend-account" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div id="search-result" class="mb-4 hidden">
                    <div class="p-3 border border-gray-200 rounded-md">
                        <div class="flex items-center">
                            <img id="result-avatar" src="https://via.placeholder.com/40" alt="å¤´åƒ" class="w-10 h-10 rounded-full mr-3">
                            <div>
                                <p id="result-nickname" class="font-medium"></p>
                                <p id="result-account" class="text-sm text-gray-500"></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="search-friend-btn" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        æœç´¢
                    </button>
                    <button type="button" id="confirm-add-friend-btn" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 hidden">
                        æ·»åŠ 
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            const token = localStorage.getItem('token');
            if (!token) {
                // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
                window.location.href = 'login.html';
                return;
            }
            
            // å…¨å±€å˜é‡
            let currentUser = null;
            let currentRoomId = null;
            let currentChatUser = null;
            let socket = null;
            let friends = [];
            
            // DOMå…ƒç´ 
            const userNickname = document.getElementById('user-nickname');
            const userAvatar = document.getElementById('user-avatar');
            const logoutBtn = document.getElementById('logout-btn');
            const friendList = document.getElementById('friend-list');
            const chatTitle = document.getElementById('chat-title');
            const chatMessages = document.getElementById('chat-messages');
            const chatInputArea = document.getElementById('chat-input-area');
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-input');
            const addFriendBtn = document.getElementById('add-friend-btn');
            const addFriendModal = document.getElementById('add-friend-modal');
            const closeAddFriendModal = document.getElementById('close-add-friend-modal');
            const addFriendForm = document.getElementById('add-friend-form');
            const friendAccount = document.getElementById('friend-account');
            const searchFriendBtn = document.getElementById('search-friend-btn');
            const searchResult = document.getElementById('search-result');
            const resultAvatar = document.getElementById('result-avatar');
            const resultNickname = document.getElementById('result-nickname');
            const resultAccount = document.getElementById('result-account');
            const confirmAddFriendBtn = document.getElementById('confirm-add-friend-btn');
            const addFriendError = document.getElementById('add-friend-error');
            const addFriendErrorText = document.getElementById('add-friend-error-text');
            const addFriendSuccess = document.getElementById('add-friend-success');
            const addFriendSuccessText = document.getElementById('add-friend-success-text');
            const chatActions = document.getElementById('chat-actions');
            const deleteFriendBtn = document.getElementById('delete-friend-btn');
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            const emojiBtn = document.getElementById('emoji-btn');
            const emojiPicker = document.getElementById('emoji-picker');
            const imageBtn = document.getElementById('image-btn');
            const fileBtn = document.getElementById('file-btn');
            const imageInput = document.getElementById('image-input');
            const fileInput = document.getElementById('file-input');
            
            // è¡¨æƒ…æ•°æ®
            const emojis = [
                'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£',
                'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°',
                'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ',
                'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜',
                'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£',
                'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ',
                'ğŸ˜¡', 'ğŸ¤¬', 'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨',
                'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—', 'ğŸ¤”', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤¥',
                'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¬', 'ğŸ™„', 'ğŸ˜¯', 'ğŸ˜¦', 'ğŸ˜§',
                'ğŸ˜®', 'ğŸ˜²', 'ğŸ¥±', 'ğŸ˜´', 'ğŸ¤¤', 'ğŸ˜ª', 'ğŸ˜µ', 'ğŸ¤',
                'ğŸ¥´', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤‘',
                'ğŸ¤ ', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ¤¡', 'ğŸ’©', 'ğŸ‘»',
                'ğŸ’€', 'â˜ ï¸', 'ğŸ‘½', 'ğŸ‘¾', 'ğŸ¤–', 'ğŸƒ', 'ğŸ˜º', 'ğŸ˜¸',
                'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿', 'ğŸ˜¾', 'â¤ï¸',
                'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤',
                'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜',
                'ğŸ’', 'ğŸ’Ÿ', 'ğŸ‘', 'ğŸ‘', 'ğŸ‘Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤',
                'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ–•', 'ğŸ‘‡',
                'â˜ï¸', 'ğŸ‘‹', 'ğŸ¤š', 'ğŸ–ï¸', 'âœ‹', 'ğŸ––', 'ğŸ‘', 'ğŸ™Œ'
            ];
            
            // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
            async function fetchCurrentUser() {
                try {
                    const response = await fetch('/user/detail', {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // æˆåŠŸçŠ¶æ€ç 
                        currentUser = data.data;
                        userNickname.textContent = currentUser.nickname || currentUser.account;
                        if (currentUser.avatar) {
                            userAvatar.src = currentUser.avatar;
                        }
                        
                        // è·å–å¥½å‹åˆ—è¡¨
                        fetchFriends();
                        
                        // å»ºç«‹WebSocketè¿æ¥
                        connectWebSocket();
                    } else {
                        // è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œå¯èƒ½æ˜¯tokenè¿‡æœŸ
                        localStorage.removeItem('token');
                        window.location.href = 'login.html';
                    }
                } catch (error) {
                    console.error('è·å–ç”¨æˆ·ä¿¡æ¯å‡ºé”™:', error);
                    alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                }
            }
            
            // è·å–å¥½å‹åˆ—è¡¨
            async function fetchFriends() {
                try {
                    // è°ƒç”¨åç«¯APIè·å–è”ç³»äººåˆ—è¡¨
                    const response = await fetch('/user/chatlist', {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    // æ¸…ç©ºå¥½å‹åˆ—è¡¨
                    friendList.innerHTML = '';
                    
                    if (data.code === 111) { // æˆåŠŸçŠ¶æ€ç 
                        const chatlist = data.data.chatlist;
                        
                        // å¤„ç†è”ç³»äººåˆ—è¡¨æ•°æ®
                        friends = chatlist.map(contact => {
                            return {
                                nickname: contact.name,
                                room_id: contact.room_id,
                                type: contact.type, // 1ç§èŠ 2ç¾¤èŠ
                                last_message: '',
                                last_message_type: 'text', // æœ€æ–°æ¶ˆæ¯ç±»å‹
                                avatar: 'https://avatars.githubusercontent.com/u/148515933?s=400&u=7cbff7c77a33416cabfe463fff24495157026760&v=4', // é»˜è®¤å¤´åƒ
                                has_new_message: false, // æ˜¯å¦æœ‰æ–°æ¶ˆæ¯
                                new_message_count: 0 // æ–°æ¶ˆæ¯æ•°é‡
                            };
                        });
                        
                        // æ¸²æŸ“å¥½å‹åˆ—è¡¨
                        renderFriendList(friends);
                    } else {
                        console.error('è·å–è”ç³»äººåˆ—è¡¨å¤±è´¥:', data.msg);
                        friendList.innerHTML = '<div class="text-center text-gray-500 py-4">è·å–è”ç³»äººåˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
                    }
                } catch (error) {
                    console.error('è·å–è”ç³»äººåˆ—è¡¨å‡ºé”™:', error);
                    friendList.innerHTML = '<div class="text-center text-gray-500 py-4">ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</div>';
                }
                
                // å¦‚æœå¥½å‹åˆ—è¡¨ä¸ºç©ºï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                if (friends.length === 0) {
                    friendList.innerHTML = '<div class="text-center text-gray-500 py-4">æš‚æ— è”ç³»äººï¼Œè¯·æ·»åŠ å¥½å‹</div>';
                }
            }
            
            // å»ºç«‹WebSocketè¿æ¥
            function connectWebSocket() {
                // æ„å»ºWebSocket URLï¼ŒæŒ‡å‘åç«¯æœåŠ¡
                // è·å–å½“å‰åŸŸåå’Œç«¯å£
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.host;
                const wsUrl = `${protocol}//${host}/user/msg?token=${token}`;
                
                // åˆ›å»ºWebSocketè¿æ¥
                socket = new WebSocket(wsUrl);
                
                // è¿æ¥æ‰“å¼€äº‹ä»¶
                socket.onopen = function(e) {
                    console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                };
                
                // æ¥æ”¶æ¶ˆæ¯äº‹ä»¶
                socket.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    console.log('æ”¶åˆ°æ¶ˆæ¯:', message);
                    
                    // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹çš„èŠå¤©å®¤ä¸æ¶ˆæ¯çš„èŠå¤©å®¤ç›¸åŒï¼Œåˆ™æ˜¾ç¤ºæ¶ˆæ¯
                    if (currentRoomId === message.room_id) {
                        // æ£€æŸ¥æ—¥æœŸæ˜¯å¦éœ€è¦æ·»åŠ åˆ†éš”çº¿
                        const messageDate = new Date(message.created_at);
                        const messageDateStr = messageDate.toDateString();
                        
                        // è·å–æœ€åä¸€ä¸ªæ—¥æœŸåˆ†éš”çº¿æˆ–æ¶ˆæ¯çš„æ—¥æœŸ
                        let lastDateStr = null;
                        const dateElements = chatMessages.querySelectorAll('.date-separator');
                        if (dateElements.length > 0) {
                            const lastDateElement = dateElements[dateElements.length - 1];
                            lastDateStr = lastDateElement.getAttribute('data-date');
                        }
                        
                        // å¦‚æœæ—¥æœŸä¸åŒï¼Œæ·»åŠ æ–°çš„æ—¥æœŸåˆ†éš”çº¿
                        if (!lastDateStr || messageDateStr !== lastDateStr) {
                            addDateSeparator(messageDate);
                        }
                        
                        // æ·»åŠ æ¶ˆæ¯åˆ°UI
                        appendMessage(message);
                        
                        // æ·»åŠ æ¶ˆæ¯åˆ°å½“å‰æ¶ˆæ¯åˆ—è¡¨
                        currentRoomMessages.push(message);
                        
                        // æ»šåŠ¨åˆ°åº•éƒ¨
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                    
                    // æ›´æ–°å¥½å‹åˆ—è¡¨ä¸­çš„æœ€æ–°æ¶ˆæ¯
                    updateFriendLastMessage(message);
                };
                
                // è¿æ¥å…³é—­äº‹ä»¶
                socket.onclose = function(event) {
                    console.log('WebSocketè¿æ¥å·²å…³é—­');
                    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é‡è¿é€»è¾‘
                };
                
                // è¿æ¥é”™è¯¯äº‹ä»¶
                socket.onerror = function(error) {
                    console.error('WebSocketé”™è¯¯:', error);
                };
            }
            
            // æ›´æ–°å¥½å‹åˆ—è¡¨ä¸­çš„æœ€æ–°æ¶ˆæ¯
            function updateFriendLastMessage(message) {
                // æŸ¥æ‰¾å¯¹åº”çš„å¥½å‹
                const friendIndex = friends.findIndex(f => f.room_id === message.room_id);
                if (friendIndex !== -1) {
                    // æ ¹æ®æ¶ˆæ¯ç±»å‹è®¾ç½®æ˜¾ç¤ºå†…å®¹
                    let displayMessage = '';
                    const messageType = message.type || 'text';
                    
                    switch (messageType) {
                        case 'emoji':
                            displayMessage = message.data || message.message;
                            break;
                        case 'image':
                            displayMessage = '[å›¾ç‰‡]';
                            break;
                        case 'file':
                            displayMessage = '[æ–‡ä»¶]';
                            break;
                        case 'video':
                            displayMessage = '[è§†é¢‘]';
                            break;
                        case 'speech':
                            displayMessage = '[è¯­éŸ³]';
                            break;
                        case 'text':
                        default:
                            displayMessage = message.data || message.message;
                            break;
                    }
                    
                    // æ›´æ–°æœ€æ–°æ¶ˆæ¯
                    friends[friendIndex].last_message = displayMessage;
                    friends[friendIndex].last_message_type = messageType;
                    
                    // å¦‚æœä¸æ˜¯å½“å‰èŠå¤©å®¤çš„æ¶ˆæ¯ï¼Œæ ‡è®°ä¸ºæœ‰æ–°æ¶ˆæ¯
                    if (message.room_id !== currentRoomId) {
                        friends[friendIndex].has_new_message = true;
                        friends[friendIndex].new_message_count = (friends[friendIndex].new_message_count || 0) + 1;
                    }
                    
                    // é‡æ–°æ¸²æŸ“å¥½å‹åˆ—è¡¨
                    renderFriendList(friends);
                }
            }
            
            // æ·»åŠ æ—¥æœŸåˆ†éš”çº¿
            function addDateSeparator(date) {
                const dateStr = date.getFullYear() + '/' + 
                               String(date.getMonth() + 1).padStart(2, '0') + '/' + 
                               String(date.getDate()).padStart(2, '0');
                
                const separatorElement = document.createElement('div');
                separatorElement.className = 'flex justify-center my-4 date-separator';
                separatorElement.setAttribute('data-date', date.toDateString());
                separatorElement.innerHTML = `
                    <div class="px-4 py-1 bg-gray-100 rounded-full text-xs text-gray-500">
                        ${dateStr}
                    </div>
                `;
                
                chatMessages.appendChild(separatorElement);
            }
            
            // èŠå¤©è®°å½•åˆ†é¡µå˜é‡
            let currentPage = 1;
            let isLoadingMessages = false;
            let hasMoreMessages = true;
            let currentRoomMessages = [];
            
            // åŠ è½½èŠå¤©è®°å½•
            async function loadChatMessages(roomId, page = 1, pageSize = 20, append = false) {
                try {
                    // å¦‚æœæ­£åœ¨åŠ è½½æˆ–æ²¡æœ‰æ›´å¤šæ¶ˆæ¯ï¼Œåˆ™è¿”å›
                    if (isLoadingMessages || (page > 1 && !hasMoreMessages)) {
                        return;
                    }
                    
                    isLoadingMessages = true;
                    
                    // å¦‚æœæ˜¯åŠ è½½ç¬¬ä¸€é¡µï¼Œé‡ç½®åˆ†é¡µå˜é‡
                    if (page === 1 && !append) {
                        currentPage = 1;
                        hasMoreMessages = true;
                        currentRoomMessages = [];
                    }
                    
                    // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                    if (page > 1) {
                        const loadingIndicator = document.createElement('div');
                        loadingIndicator.id = 'loading-indicator';
                        loadingIndicator.className = 'flex justify-center my-4';
                        loadingIndicator.innerHTML = `
                            <div class="px-4 py-1 bg-gray-100 rounded-full text-xs text-gray-500 flex items-center">
                                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                åŠ è½½æ›´å¤šæ¶ˆæ¯...
                            </div>
                        `;
                        chatMessages.insertBefore(loadingIndicator, chatMessages.firstChild);
                    }
                    
                    const response = await fetch(`/user/history?room_id=${roomId}&page_index=${page}&page_size=${pageSize}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                    const loadingIndicator = document.getElementById('loading-indicator');
                    if (loadingIndicator) {
                        loadingIndicator.remove();
                    }
                    
                    if (data.code === 111) { // æˆåŠŸçŠ¶æ€ç 
                        // æ˜¾ç¤ºèŠå¤©è®°å½•
                        const messages = data.data.list;
                        
                        // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œä¸”æ˜¯ç¬¬ä¸€é¡µï¼Œæ˜¾ç¤ºæš‚æ— èŠå¤©è®°å½•
                        if (messages.length === 0 && page === 1 && !append) {
                            chatMessages.innerHTML = '<div class="flex justify-center my-4"><p class="text-gray-500">æš‚æ— èŠå¤©è®°å½•</p></div>';
                            hasMoreMessages = false;
                        } else if (messages.length === 0) {
                            // å¦‚æœæ˜¯å…¶ä»–é¡µä¸”æ²¡æœ‰æ¶ˆæ¯ï¼Œè¯´æ˜æ²¡æœ‰æ›´å¤šæ¶ˆæ¯äº†
                            hasMoreMessages = false;
                            
                            // æ·»åŠ æ²¡æœ‰æ›´å¤šæ¶ˆæ¯çš„æç¤º
                            const noMoreMessagesIndicator = document.createElement('div');
                            noMoreMessagesIndicator.className = 'flex justify-center my-4';
                            noMoreMessagesIndicator.innerHTML = `
                                <div class="px-4 py-1 bg-gray-100 rounded-full text-xs text-gray-500">
                                    æ²¡æœ‰æ›´å¤šæ¶ˆæ¯äº†
                                </div>
                            `;
                            chatMessages.insertBefore(noMoreMessagesIndicator, chatMessages.firstChild);
                        } else {
                            // æŒ‰æ—¶é—´é¡ºåºæ˜¾ç¤ºæ¶ˆæ¯
                            messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                            
                            // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®å’Œé«˜åº¦
                            const scrollPos = chatMessages.scrollTop;
                            const oldHeight = chatMessages.scrollHeight;
                            
                            // åˆå¹¶æ¶ˆæ¯åˆ°å½“å‰æˆ¿é—´æ¶ˆæ¯åˆ—è¡¨
                            if (page === 1 && !append) {
                                // å¦‚æœæ˜¯ç¬¬ä¸€é¡µä¸”ä¸æ˜¯è¿½åŠ æ¨¡å¼ï¼Œæ¸…ç©ºèŠå¤©æ¶ˆæ¯åŒºåŸŸ
                                chatMessages.innerHTML = '';
                                currentRoomMessages = messages;
                            } else {
                                // å°†æ–°æ¶ˆæ¯æ·»åŠ åˆ°æ•°ç»„å¼€å¤´
                                currentRoomMessages = [...messages, ...currentRoomMessages];
                            }
                            
                            // é‡æ–°æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯æˆ–è¿½åŠ æ–°æ¶ˆæ¯
                            if (page > 1 || append) {
                                // å¦‚æœæ˜¯åŠ è½½æ›´å¤šæˆ–è¿½åŠ æ¨¡å¼
                                if (page > 1) {
                                    // æ¸…ç©ºèŠå¤©åŒºåŸŸ
                                    chatMessages.innerHTML = '';
                                    
                                    // é‡æ–°æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯
                                    let currentDate = null;
                                    
                                    currentRoomMessages.forEach(msg => {
                                        const messageDate = new Date(msg.created_at);
                                        const messageDateStr = messageDate.toDateString();
                                        
                                        // å¦‚æœæ—¥æœŸå˜åŒ–ï¼Œæ·»åŠ æ—¥æœŸåˆ†éš”çº¿
                                        if (!currentDate || messageDateStr !== currentDate) {
                                            currentDate = messageDateStr;
                                            addDateSeparator(messageDate);
                                        }
                                        
                                        // ç›´æ¥ä¼ é€’MessageBasicå¯¹è±¡ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µ
                                        appendMessage(msg);
                                    });
                                    
                                    // è®¡ç®—æ–°å¢å†…å®¹çš„é«˜åº¦ï¼Œå¹¶è°ƒæ•´æ»šåŠ¨ä½ç½®
                                    const newHeight = chatMessages.scrollHeight;
                                    chatMessages.scrollTop = scrollPos + (newHeight - oldHeight);
                                } else {
                                    // å¦‚æœæ˜¯è¿½åŠ æ¨¡å¼ä½†ä¸æ˜¯åŠ è½½æ›´å¤šï¼Œæ»šåŠ¨åˆ°åº•éƒ¨
                                    chatMessages.scrollTop = chatMessages.scrollHeight;
                                }
                            } else {
                                // å¦‚æœæ˜¯ç¬¬ä¸€é¡µä¸”ä¸æ˜¯è¿½åŠ æ¨¡å¼ï¼Œç›´æ¥æ¸²æŸ“
                                let currentDate = null;
                                
                                messages.forEach(msg => {
                                    const messageDate = new Date(msg.created_at);
                                    const messageDateStr = messageDate.toDateString();
                                    
                                    // å¦‚æœæ—¥æœŸå˜åŒ–ï¼Œæ·»åŠ æ—¥æœŸåˆ†éš”çº¿
                                    if (!currentDate || messageDateStr !== currentDate) {
                                        currentDate = messageDateStr;
                                        addDateSeparator(messageDate);
                                    }
                                    
                                    // ç›´æ¥ä¼ é€’MessageBasicå¯¹è±¡ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µ
                                    appendMessage(msg);
                                });
                                
                                // æ»šåŠ¨åˆ°åº•éƒ¨
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                            }
                            
                            // æ›´æ–°å½“å‰é¡µç 
                            currentPage = page;
                        }
                    } else {
                        console.error('è·å–èŠå¤©è®°å½•å¤±è´¥:', data.msg);
                    }
                } catch (error) {
                    console.error('è·å–èŠå¤©è®°å½•å‡ºé”™:', error);
                } finally {
                    isLoadingMessages = false;
                }
            }
            
            // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
            function appendMessage(message) {
                const isCurrentUser = message.user_id === currentUser.user_id;
                
                const messageElement = document.createElement('div');
                messageElement.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'} mb-4`;
                
                // æ ¼å¼åŒ–å‘é€æ—¶é—´ï¼Œåªç²¾ç¡®åˆ°åˆ†é’Ÿ
                const createdTime = new Date(message.created_at || new Date()).toLocaleTimeString([], { 
                    hour: '2-digit', minute: '2-digit' 
                });
                
                // è·å–ç”¨æˆ·æ˜µç§°
                const userName = isCurrentUser ? currentUser.nickname : (currentChatUser?.nickname || 'ç”¨æˆ·');
                
                // æ ¹æ®æ¶ˆæ¯ç±»å‹æ¸²æŸ“ä¸åŒçš„å†…å®¹
                let messageContent = '';
                const messageType = message.type || 'text'; // é»˜è®¤ä¸ºæ–‡æœ¬ç±»å‹
                
                switch (messageType) {
                    case 'emoji':
                        messageContent = `<span class="text-4xl">${message.data}</span>`;
                        break;
                    case 'image':
                        messageContent = `
                            <div class="max-w-48">
                                <img src="${message.data}" alt="${message.file_name || 'å›¾ç‰‡'}" class="rounded-lg max-w-full h-auto cursor-pointer" onclick="window.open('${message.data}', '_blank')">
                                <p class="text-xs text-gray-500 mt-1">${message.file_name || 'å›¾ç‰‡'}</p>
                            </div>
                        `;
                        break;
                    case 'file':
                        const fileSize = message.file_size ? (message.file_size / 1024 / 1024).toFixed(2) + 'MB' : 'æœªçŸ¥å¤§å°';
                        messageContent = `
                            <div class="flex items-center space-x-3 p-3 border border-gray-300 rounded-lg bg-white">
                                <div class="flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate">${message.file_name || 'æ–‡ä»¶'}</p>
                                    <p class="text-xs text-gray-500">${fileSize}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <a href="${message.data}" download="${message.file_name}" class="text-indigo-600 hover:text-indigo-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        `;
                        break;
                    case 'text':
                    default:
                        messageContent = `<p>${message.data || message.message}</p>`;
                        break;
                }
                
                messageElement.innerHTML = `
                    <div class="${isCurrentUser ? 'order-2' : 'order-1'} flex-shrink-0">
                        <img src="${isCurrentUser ? (currentUser.avatar || 'https://via.placeholder.com/32') : (currentChatUser?.avatar || 'https://via.placeholder.com/32')}" alt="å¤´åƒ" class="w-8 h-8 rounded-full">
                    </div>
                    <div class="${isCurrentUser ? 'order-1' : 'order-2'} max-w-xs mx-2">
                        <div class="${isCurrentUser ? 'text-right' : 'text-left'} text-xs text-gray-600 mb-1">${userName}</div>
                        <div class="${isCurrentUser ? 'bg-indigo-500 text-white' : 'bg-gray-200 text-gray-800'} rounded-lg ${messageType === 'emoji' ? 'px-2 py-1' : messageType === 'image' || messageType === 'file' ? 'p-2' : 'px-4 py-2'} shadow">
                            ${messageContent}
                        </div>
                        <div class="text-xs text-gray-500 ${isCurrentUser ? 'text-right' : 'text-left'} mt-1">
                            <span>${createdTime}</span>
                        </div>
                    </div>
                `;
                
                chatMessages.appendChild(messageElement);
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // æ·»åŠ æ»šåŠ¨äº‹ä»¶ç›‘å¬ï¼Œä¸Šæ»‘åŠ è½½æ›´å¤šæ¶ˆæ¯
            function setupScrollListener() {
                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
                chatMessages.removeEventListener('scroll', handleScroll);
                
                // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
                chatMessages.addEventListener('scroll', handleScroll);
            }
            
            // å¤„ç†æ»šåŠ¨äº‹ä»¶
            function handleScroll() {
                // å¦‚æœæ»šåŠ¨åˆ°é¡¶éƒ¨é™„è¿‘ï¼ˆè·ç¦»é¡¶éƒ¨å°äº50åƒç´ ï¼‰ï¼ŒåŠ è½½æ›´å¤šæ¶ˆæ¯
                if (chatMessages.scrollTop < 50 && !isLoadingMessages && hasMoreMessages && currentRoomId) {
                    // åŠ è½½ä¸‹ä¸€é¡µæ¶ˆæ¯
                    loadChatMessages(currentRoomId, currentPage + 1, 20, true);
                }
            }
            
            // æ‰“å¼€èŠå¤©
            function openChat(roomId, contact) {
                // å¦‚æœæ˜¯åŒä¸€ä¸ªèŠå¤©ï¼Œä¸é‡æ–°åŠ è½½
                if (currentRoomId === roomId) {
                    return;
                }
                
                currentRoomId = roomId;
                currentChatUser = contact;
                
                // æ¸…é™¤è¯¥å¥½å‹çš„æ–°æ¶ˆæ¯æç¤º
                const friendIndex = friends.findIndex(f => f.room_id === roomId);
                if (friendIndex !== -1) {
                    friends[friendIndex].has_new_message = false;
                    friends[friendIndex].new_message_count = 0;
                    // é‡æ–°æ¸²æŸ“å¥½å‹åˆ—è¡¨ä»¥æ›´æ–°UI
                    renderFriendList(friends);
                }
                
                // é‡ç½®åˆ†é¡µå˜é‡
                currentPage = 1;
                hasMoreMessages = true;
                currentRoomMessages = [];
                
                // æ›´æ–°èŠå¤©æ ‡é¢˜ï¼Œæ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒçš„æ ‡é¢˜
                const chatType = contact.type === 1 ? 'ç§èŠ' : 'ç¾¤èŠ';
                chatTitle.innerHTML = `${contact.nickname} <span class="text-sm text-gray-500">(${chatType})</span>`;
                
                // æ˜¾ç¤ºèŠå¤©è¾“å…¥åŒºåŸŸ
                chatInputArea.classList.remove('hidden');
                
                // æ˜¾ç¤ºèŠå¤©æ“ä½œåŒºåŸŸï¼Œåªæœ‰ç§èŠæ‰æ˜¾ç¤ºåˆ é™¤å¥½å‹æŒ‰é’®
                chatActions.classList.remove('hidden');
                if (contact.type === 1) {
                    deleteFriendBtn.classList.remove('hidden');
                } else {
                    deleteFriendBtn.classList.add('hidden');
                }
                
                // åŠ è½½èŠå¤©è®°å½•
                loadChatMessages(roomId);
                
                // è®¾ç½®æ»šåŠ¨äº‹ä»¶ç›‘å¬
                setupScrollListener();
            }
            
            // æœç´¢å¥½å‹
            async function searchFriend(account) {
                try {
                    const response = await fetch(`/user/query?account=${account}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // æˆåŠŸçŠ¶æ€ç 
                        return data.data;
                    } else {
                        throw new Error(data.msg || 'æœç´¢å¥½å‹å¤±è´¥');
                    }
                } catch (error) {
                    console.error('æœç´¢å¥½å‹å‡ºé”™:', error);
                    throw error;
                }
            }
            
            // æ·»åŠ å¥½å‹
            async function addFriend(account) {
                try {
                    const formData = new FormData();
                    formData.append('account', account);
                    
                    const response = await fetch('/user/add', {
                        method: 'POST',
                        headers: {
                            'Authorization': token
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // æˆåŠŸçŠ¶æ€ç 
                        return data.data;
                    } else {
                        throw new Error(data.msg || 'æ·»åŠ å¥½å‹å¤±è´¥');
                    }
                } catch (error) {
                    console.error('æ·»åŠ å¥½å‹å‡ºé”™:', error);
                    throw error;
                }
            }
            
            // åˆ é™¤å¥½å‹
            async function deleteFriend(roomId) {
                try {
                    // ä»å½“å‰å¥½å‹åˆ—è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„å¥½å‹ä¿¡æ¯
                    const friend = friends.find(f => f.room_id === roomId);
                    if (!friend) {
                        throw new Error('æ‰¾ä¸åˆ°è¯¥å¥½å‹ä¿¡æ¯');
                    }
                    
                    // æ„å»ºè¯·æ±‚å‚æ•°
                    const formData = new FormData();
                    formData.append('room_id', roomId);
                    
                    const response = await fetch('/user/delete', {
                        method: 'DELETE',
                        headers: {
                            'Authorization': token
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 111) { // æˆåŠŸçŠ¶æ€ç 
                        return true;
                    } else {
                        throw new Error(data.msg || 'åˆ é™¤å¥½å‹å¤±è´¥');
                    }
                } catch (error) {
                    console.error('åˆ é™¤å¥½å‹å‡ºé”™:', error);
                    throw error;
                }
            }
            
            // äº‹ä»¶ç›‘å¬
            
            // é€€å‡ºç™»å½•
            logoutBtn.addEventListener('click', function() {
                // å…³é—­WebSocketè¿æ¥
                if (socket) {
                    socket.close();
                }
                
                // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„token
                localStorage.removeItem('token');
                
                // è·³è½¬åˆ°ç™»å½•é¡µé¢
                window.location.href = 'login.html';
            });
            
            // å‘é€æ¶ˆæ¯
            messageForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const message = messageInput.value.trim();
                if (!message) return;
                
                if (!currentRoomId) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©');
                    return;
                }
                
                // è·å–å½“å‰æ—¥æœŸ
                const now = new Date();
                const todayStr = now.toDateString();
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ æ—¥æœŸåˆ†éš”çº¿
                let lastDateStr = null;
                const dateElements = chatMessages.querySelectorAll('.date-separator');
                if (dateElements.length > 0) {
                    const lastDateElement = dateElements[dateElements.length - 1];
                    lastDateStr = lastDateElement.getAttribute('data-date');
                }
                
                // å¦‚æœæ—¥æœŸä¸åŒæˆ–æ²¡æœ‰æ—¥æœŸåˆ†éš”çº¿ï¼Œæ·»åŠ æ–°çš„æ—¥æœŸåˆ†éš”çº¿
                if (!lastDateStr || todayStr !== lastDateStr) {
                    addDateSeparator(now);
                }
                
                // æ„å»ºæ¶ˆæ¯å¯¹è±¡ï¼Œä½¿ç”¨dataå­—æ®µåŒ¹é…MessageBasicç»“æ„
                const messageObj = {
                    user_id: currentUser.user_id,
                    room_id: currentRoomId,
                    data: message,
                    type: 'text', // è®¾ç½®æ¶ˆæ¯ç±»å‹ä¸ºæ–‡æœ¬
                    created_at: now.toISOString() // æ·»åŠ åˆ›å»ºæ—¶é—´
                };
                
                // å‘é€æ¶ˆæ¯
                socket.send(JSON.stringify(messageObj));
                
                // æ·»åŠ æ¶ˆæ¯åˆ°å½“å‰æ¶ˆæ¯åˆ—è¡¨ï¼ˆæœ¬åœ°æ˜¾ç¤ºï¼Œä¸ç­‰å¾…æœåŠ¡å™¨å“åº”ï¼‰
                // æ³¨æ„ï¼šæœåŠ¡å™¨å“åº”åä¼šé€šè¿‡WebSocketå†æ¬¡æ”¶åˆ°è¿™æ¡æ¶ˆæ¯ï¼Œä½†ç”±äºå·²ç»æ·»åŠ è¿‡ï¼Œä¸ä¼šé‡å¤æ˜¾ç¤º
                currentRoomMessages.push(messageObj);
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                messageInput.value = '';
            });
            
            // æ‰“å¼€æ·»åŠ å¥½å‹æ¨¡æ€æ¡†
            addFriendBtn.addEventListener('click', function() {
                // é‡ç½®è¡¨å•
                addFriendForm.reset();
                searchResult.classList.add('hidden');
                confirmAddFriendBtn.classList.add('hidden');
                addFriendError.classList.add('hidden');
                addFriendSuccess.classList.add('hidden');
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                addFriendModal.classList.remove('hidden');
            });
            
            // å…³é—­æ·»åŠ å¥½å‹æ¨¡æ€æ¡†
            closeAddFriendModal.addEventListener('click', function() {
                addFriendModal.classList.add('hidden');
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­æ¨¡æ€æ¡†
            addFriendModal.addEventListener('click', function(e) {
                if (e.target === addFriendModal) {
                    addFriendModal.classList.add('hidden');
                }
            });
            
            // æœç´¢å¥½å‹
            searchFriendBtn.addEventListener('click', async function() {
                const account = friendAccount.value.trim();
                if (!account) {
                    addFriendErrorText.textContent = 'è¯·è¾“å…¥å¥½å‹è´¦å·';
                    addFriendError.classList.remove('hidden');
                    addFriendSuccess.classList.add('hidden');
                    return;
                }
                
                try {
                    const user = await searchFriend(account);
                    
                    // æ˜¾ç¤ºæœç´¢ç»“æœ
                    resultNickname.textContent = user.nickname || user.account;
                    resultAccount.textContent = user.account;
                    if (user.avatar) {
                        resultAvatar.src = user.avatar;
                    }
                    
                    searchResult.classList.remove('hidden');
                    
                    // å¦‚æœå·²ç»æ˜¯å¥½å‹ï¼Œä¸æ˜¾ç¤ºæ·»åŠ æŒ‰é’®
                    if (user.is_friend) {
                        addFriendErrorText.textContent = 'è¯¥ç”¨æˆ·å·²ç»æ˜¯æ‚¨çš„å¥½å‹';
                        addFriendError.classList.remove('hidden');
                        addFriendSuccess.classList.add('hidden');
                        confirmAddFriendBtn.classList.add('hidden');
                    } else {
                        addFriendError.classList.add('hidden');
                        addFriendSuccess.classList.add('hidden');
                        confirmAddFriendBtn.classList.remove('hidden');
                        
                        // å­˜å‚¨æœç´¢åˆ°çš„ç”¨æˆ·ä¿¡æ¯
                        confirmAddFriendBtn.dataset.account = user.account;
                    }
                } catch (error) {
                    addFriendErrorText.textContent = error.message || 'æœç´¢å¥½å‹å¤±è´¥';
                    addFriendError.classList.remove('hidden');
                    addFriendSuccess.classList.add('hidden');
                    searchResult.classList.add('hidden');
                    confirmAddFriendBtn.classList.add('hidden');
                }
            });
            
            // ç¡®è®¤æ·»åŠ å¥½å‹
            confirmAddFriendBtn.addEventListener('click', async function() {
                const account = confirmAddFriendBtn.dataset.account;
                if (!account) return;
                
                try {
                    await addFriend(account);
                    
                    // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                    addFriendSuccessText.textContent = 'æ·»åŠ å¥½å‹æˆåŠŸ';
                    addFriendSuccess.classList.remove('hidden');
                    addFriendError.classList.add('hidden');
                    
                    // é‡æ–°è·å–å¥½å‹åˆ—è¡¨
                    fetchFriends();
                    
                    // 3ç§’åå…³é—­æ¨¡æ€æ¡†
                    setTimeout(() => {
                        addFriendModal.classList.add('hidden');
                    }, 3000);
                } catch (error) {
                    addFriendErrorText.textContent = error.message || 'æ·»åŠ å¥½å‹å¤±è´¥';
                    addFriendError.classList.remove('hidden');
                    addFriendSuccess.classList.add('hidden');
                }
            });
            
            // åˆ é™¤å¥½å‹
            deleteFriendBtn.addEventListener('click', async function() {
                if (!currentChatUser || !currentRoomId) return;
                
                // åªæœ‰ç§èŠæ‰èƒ½åˆ é™¤å¥½å‹
                if (currentChatUser.type !== 1) {
                    alert('åªèƒ½åˆ é™¤ç§èŠè”ç³»äºº');
                    return;
                }
                
                if (confirm(`ç¡®å®šè¦åˆ é™¤å¥½å‹ ${currentChatUser.nickname} å—ï¼Ÿ`)) {
                    try {
                        await deleteFriend(currentRoomId);
                        
                        // é‡æ–°è·å–å¥½å‹åˆ—è¡¨
                        fetchFriends();
                        
                        // é‡ç½®èŠå¤©åŒºåŸŸ
                        currentRoomId = null;
                        currentChatUser = null;
                        chatTitle.textContent = 'è¯·é€‰æ‹©ä¸€ä¸ªèŠå¤©';
                        chatMessages.innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-gray-500">é€‰æ‹©ä¸€ä¸ªè”ç³»äººå¼€å§‹èŠå¤©</p></div>';
                        chatInputArea.classList.add('hidden');
                        chatActions.classList.add('hidden');
                        
                        alert('åˆ é™¤å¥½å‹æˆåŠŸ');
                    } catch (error) {
                        alert(error.message || 'åˆ é™¤å¥½å‹å¤±è´¥');
                    }
                }
            });
            
            // æœç´¢è”ç³»äººï¼ˆæœ¬åœ°æœç´¢ï¼‰
            searchBtn.addEventListener('click', function() {
                const keyword = searchInput.value.trim().toLowerCase();
                if (!keyword) {
                    // æ˜¾ç¤ºæ‰€æœ‰è”ç³»äºº
                    renderFriendList(friends);
                    return;
                }
                
                // è¿‡æ»¤è”ç³»äººåˆ—è¡¨
                const filteredFriends = friends.filter(friend => {
                    return friend.nickname.toLowerCase().includes(keyword);
                });
                
                // æ›´æ–°è”ç³»äººåˆ—è¡¨
                renderFriendList(filteredFriends);
            });
            
            // æœç´¢æ¡†å›è½¦äº‹ä»¶
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    searchBtn.click();
                }
            });
            
            // æœç´¢æ¡†æ¸…ç©ºäº‹ä»¶
            searchInput.addEventListener('input', function() {
                if (this.value.trim() === '') {
                    renderFriendList(friends);
                }
            });
            
            // æ¸²æŸ“å¥½å‹åˆ—è¡¨
            function renderFriendList(friendsList) {
                // æ¸…ç©ºå¥½å‹åˆ—è¡¨
                friendList.innerHTML = '';
                
                if (friendsList.length === 0) {
                    friendList.innerHTML = '<div class="text-center text-gray-500 py-4">æœªæ‰¾åˆ°åŒ¹é…çš„è”ç³»äºº</div>';
                    return;
                }
                
                // æ¸²æŸ“å¥½å‹åˆ—è¡¨
                friendsList.forEach(friend => {
                    const friendElement = document.createElement('div');
                    // å¦‚æœæœ‰æ–°æ¶ˆæ¯ï¼Œæ·»åŠ ç‰¹æ®Šæ ·å¼
                    const hasNewMessage = friend.has_new_message && friend.room_id !== currentRoomId;
                    friendElement.className = `p-2 hover:bg-gray-100 rounded-md cursor-pointer relative ${hasNewMessage ? 'bg-blue-50 border-l-4 border-blue-500' : ''}`;
                    friendElement.dataset.roomId = friend.room_id;
                    friendElement.dataset.type = friend.type;
                    
                    // æ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒçš„å›¾æ ‡
                    const typeIcon = friend.type === 1 ? 
                        '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>' : 
                        '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" /></svg>';
                    
                    // æ–°æ¶ˆæ¯æç¤ºæ ‡è¯†
                    const newMessageBadge = hasNewMessage && friend.new_message_count > 0 ? 
                        `<span class="absolute top-1 right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold">${friend.new_message_count > 99 ? '99+' : friend.new_message_count}</span>` : '';
                    
                    friendElement.innerHTML = `
                        <div class="flex items-center">
                            <img src="${friend.avatar || 'https://via.placeholder.com/40'}" alt="å¤´åƒ" class="w-10 h-10 rounded-full mr-3">
                            <div class="flex-1">
                                <div class="flex items-center">
                                    <p class="font-medium ${hasNewMessage ? 'text-blue-700' : ''}">${friend.nickname}</p>
                                    <span class="ml-2" title="${friend.type === 1 ? 'ç§èŠ' : 'ç¾¤èŠ'}">${typeIcon}</span>
                                    ${hasNewMessage ? '<span class="ml-2 w-2 h-2 bg-red-500 rounded-full" title="æœ‰æ–°æ¶ˆæ¯"></span>' : ''}
                                </div>
                                <div class="flex items-center text-sm ${hasNewMessage ? 'text-blue-600 font-medium' : 'text-gray-500'} truncate">
                                    ${getMessageTypeIcon(friend.last_message_type || 'text')}
                                    <span class="ml-1">${friend.last_message || ''}</span>
                                </div>
                            </div>
                        </div>
                        ${newMessageBadge}
                    `;
                    
                    // ç‚¹å‡»è”ç³»äººæ‰“å¼€èŠå¤©
                    friendElement.addEventListener('click', function() {
                        openChat(friend.room_id, friend);
                    });
                    
                    friendList.appendChild(friendElement);
                });
            }
            
            // è·å–æ¶ˆæ¯ç±»å‹å›¾æ ‡
            function getMessageTypeIcon(messageType) {
                switch (messageType) {
                    case 'emoji':
                        return '<span class="text-yellow-500">ğŸ˜Š</span>';
                    case 'image':
                        return '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>';
                    case 'file':
                        return '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>';
                    case 'video':
                        return '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>';
                    case 'speech':
                        return '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>';
                    case 'text':
                    default:
                        return '';
                }
            }
            
            // åˆå§‹åŒ–è¡¨æƒ…é€‰æ‹©å™¨
            function initEmojiPicker() {
                const emojiGrid = emojiPicker.querySelector('.grid');
                emojiGrid.innerHTML = '';
                
                emojis.forEach(emoji => {
                    const emojiBtn = document.createElement('button');
                    emojiBtn.type = 'button';
                    emojiBtn.className = 'p-2 text-2xl hover:bg-gray-200 rounded transition-colors duration-200';
                    emojiBtn.textContent = emoji;
                    emojiBtn.addEventListener('click', function() {
                        // å‘é€è¡¨æƒ…æ¶ˆæ¯
                        sendEmojiMessage(emoji);
                        // éšè—è¡¨æƒ…é€‰æ‹©å™¨
                        emojiPicker.classList.add('hidden');
                    });
                    emojiGrid.appendChild(emojiBtn);
                });
            }
            
            // å‘é€è¡¨æƒ…æ¶ˆæ¯
            function sendEmojiMessage(emoji) {
                if (!currentRoomId) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©');
                    return;
                }
                
                const now = new Date();
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ æ—¥æœŸåˆ†éš”çº¿
                const lastDateElements = chatMessages.querySelectorAll('.date-separator');
                const lastDateStr = lastDateElements.length > 0 ? 
                    lastDateElements[lastDateElements.length - 1].textContent.trim() : null;
                const todayStr = now.getFullYear() + '/' + 
                                String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                                String(now.getDate()).padStart(2, '0');
                
                if (!lastDateStr || todayStr !== lastDateStr) {
                    addDateSeparator(now);
                }
                
                // æ„å»ºè¡¨æƒ…æ¶ˆæ¯å¯¹è±¡
                const messageObj = {
                    user_id: currentUser.user_id,
                    room_id: currentRoomId,
                    data: emoji,
                    type: 'emoji', // è®¾ç½®æ¶ˆæ¯ç±»å‹ä¸ºè¡¨æƒ…
                    created_at: now.toISOString()
                };
                
                // å‘é€æ¶ˆæ¯
                socket.send(JSON.stringify(messageObj));
                
                // æ·»åŠ æ¶ˆæ¯åˆ°å½“å‰æ¶ˆæ¯åˆ—è¡¨
                currentRoomMessages.push(messageObj);
            }
            
            // å‘é€å›¾ç‰‡æ¶ˆæ¯
            function sendImageMessage(file) {
                if (!currentRoomId) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©');
                    return;
                }
                
                // åˆ›å»ºæ–‡ä»¶è¯»å–å™¨
                const reader = new FileReader();
                reader.onload = function(e) {
                    const now = new Date();
                    
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ æ—¥æœŸåˆ†éš”çº¿
                    const lastDateElements = chatMessages.querySelectorAll('.date-separator');
                    const lastDateStr = lastDateElements.length > 0 ? 
                        lastDateElements[lastDateElements.length - 1].textContent.trim() : null;
                    const todayStr = now.getFullYear() + '/' + 
                                    String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                                    String(now.getDate()).padStart(2, '0');
                    
                    if (!lastDateStr || todayStr !== lastDateStr) {
                        addDateSeparator(now);
                    }
                    
                    // æ„å»ºå›¾ç‰‡æ¶ˆæ¯å¯¹è±¡
                    const messageObj = {
                        user_id: currentUser.user_id,
                        room_id: currentRoomId,
                        data: e.target.result, // base64ç¼–ç çš„å›¾ç‰‡æ•°æ®
                        type: 'image',
                        file_name: file.name,
                        file_size: file.size,
                        created_at: now.toISOString()
                    };
                    
                    // å‘é€æ¶ˆæ¯
                    socket.send(JSON.stringify(messageObj));
                    
                    // æ·»åŠ æ¶ˆæ¯åˆ°å½“å‰æ¶ˆæ¯åˆ—è¡¨
                    currentRoomMessages.push(messageObj);
                };
                
                reader.readAsDataURL(file);
            }
            
            // å‘é€æ–‡ä»¶æ¶ˆæ¯
            function sendFileMessage(file) {
                if (!currentRoomId) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©');
                    return;
                }
                
                // åˆ›å»ºæ–‡ä»¶è¯»å–å™¨
                const reader = new FileReader();
                reader.onload = function(e) {
                    const now = new Date();
                    
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ æ—¥æœŸåˆ†éš”çº¿
                    const lastDateElements = chatMessages.querySelectorAll('.date-separator');
                    const lastDateStr = lastDateElements.length > 0 ? 
                        lastDateElements[lastDateElements.length - 1].textContent.trim() : null;
                    const todayStr = now.getFullYear() + '/' + 
                                    String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                                    String(now.getDate()).padStart(2, '0');
                    
                    if (!lastDateStr || todayStr !== lastDateStr) {
                        addDateSeparator(now);
                    }
                    
                    // æ„å»ºæ–‡ä»¶æ¶ˆæ¯å¯¹è±¡
                    const messageObj = {
                        user_id: currentUser.user_id,
                        room_id: currentRoomId,
                        data: e.target.result, // base64ç¼–ç çš„æ–‡ä»¶æ•°æ®
                        type: 'file',
                        file_name: file.name,
                        file_size: file.size,
                        created_at: now.toISOString()
                    };
                    
                    // å‘é€æ¶ˆæ¯
                    socket.send(JSON.stringify(messageObj));
                    
                    // æ·»åŠ æ¶ˆæ¯åˆ°å½“å‰æ¶ˆæ¯åˆ—è¡¨
                    currentRoomMessages.push(messageObj);
                };
                
                reader.readAsDataURL(file);
            }
            
            // è¡¨æƒ…æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            emojiBtn.addEventListener('click', function() {
                emojiPicker.classList.toggle('hidden');
            });
            
            // å›¾ç‰‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            imageBtn.addEventListener('click', function() {
                imageInput.click();
            });
            
            // æ–‡ä»¶æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            fileBtn.addEventListener('click', function() {
                fileInput.click();
            });
            
            // å›¾ç‰‡æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º5MBï¼‰
                    if (file.size > 5 * 1024 * 1024) {
                        alert('å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                        return;
                    }
                    sendImageMessage(file);
                }
                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©å™¨
                e.target.value = '';
            });
            
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º10MBï¼‰
                    if (file.size > 10 * 1024 * 1024) {
                        alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
                        return;
                    }
                    sendFileMessage(file);
                }
                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©å™¨
                e.target.value = '';
            });
            
            // å›è½¦é”®å‘é€æ¶ˆæ¯
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    messageForm.dispatchEvent(new Event('submit'));
                }
            });
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—è¡¨æƒ…é€‰æ‹©å™¨
            document.addEventListener('click', function(e) {
                if (!emojiBtn.contains(e.target) && !emojiPicker.contains(e.target)) {
                    emojiPicker.classList.add('hidden');
                }
            });
            
            // åˆå§‹åŒ–
            initEmojiPicker();
            fetchCurrentUser();
        });
    </script>
</body>
</html>